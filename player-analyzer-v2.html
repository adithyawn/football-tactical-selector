<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#9917; Player Analysis - Analisis Performa Detail</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom: 3px solid #3498db;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .header p {
            font-size: 0.95em;
            color: #7f8c8d;
        }

        .upload-section {
            background: #ffffff;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .upload-box {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: #2980b9;
            background: #e8f4f8;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
        }

        .content {
            padding: 0;
        }

        .player-selector {
            margin-bottom: 24px;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .player-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1em;
            color: #2c3e50;
        }

        .player-selector select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dce4ec;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
            color: #2c3e50;
        }

        .player-selector select:focus {
            outline: none;
            border-color: #3498db;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e1e8ed;
        }

        .card-icon {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }

        .player-header {
            text-align: center;
            padding: 24px;
            background: #ffffff;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom: 3px solid #3498db;
        }

        .player-name {
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .player-info {
            font-size: 1em;
            color: #7f8c8d;
        }

        .position-badge {
            display: inline-block;
            padding: 6px 14px;
            background: #3498db;
            color: white;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.9em;
            margin: 5px;
        }

        .insight-list {
            list-style: none;
        }

        .insight-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .insight-item.strength {
            border-left-color: #27ae60;
            background: #eafaf1;
        }

        .insight-item.weakness {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        .insight-item.neutral {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e1e8ed;
        }

        .stat-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #3498db;
        }

        .rating-excellent {
            color: #27ae60;
        }

        .rating-good {
            color: #3498db;
        }

        .rating-average {
            color: #f39c12;
        }

        .rating-poor {
            color: #e74c3c;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .alert-success {
            background: #eafaf1;
            color: #27ae60;
            border: 1px solid #aed9b9;
        }

        .effectiveness-rating {
            text-align: center;
            padding: 20px;
            background: #ffffff;
            color: #2c3e50;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        .effectiveness-rating h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stars {
            font-size: 2em;
            letter-spacing: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>&#9917; Player Analysis</h1>
            <p>Analisis Pemain Berdasarkan Data Performa Dalam Pertandingan</p>
            <div style="margin-top: 15px;">
                <a href="index.html" style="text-decoration: none;">
                    <button class="btn btn-secondary" style="background: #95a5a6; padding: 8px 20px;">
                        ‚Üê Back to Home
                    </button>
                </a>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">&#128193;</div>
                <h2>Upload File Excel Data Pemain</h2>
                
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Upload File Excel
                </button>
                <button class="btn btn-secondary" onclick="loadTestData()">
                    Load Test Data (Everton)
                </button>
                <button class="btn btn-secondary" onclick="resetData()" style="background: #dc3545;">
                     Reset
                </button>
                <div style="margin-top: 15px;">
                    <a href="Template Data Pemain.xlsx" download style="color: #667eea; text-decoration: none; font-weight: 600; font-size: 0.95em;">
                        &#128190; Klik Disini Untuk Download Template Excel Data Pemain
                    </a>
                    <br>
                    <a href="Analisis Data Pemain View.fmf" download style="color: #667eea; text-decoration: none; font-weight: 600; font-size: 0.95em;">
                        &#128190; Klik Disini Untuk Download Custom View Analisa Pemain
                    </a>
                </div>
            </div>
            
            <!-- Petunjuk Penggunaan -->
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin: 15px 0; font-size: 0.85em; text-align: left;">
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">üìù Petunjuk:</div>
                <ul style="margin: 0; padding-left: 20px; color: #555; text-align: left;">
                    <li>Drag & drop file Excel atau klik tombol "Upload File Excel" jika datamu sudah ada</li>
                    <li>üí° Klik "Load Test Data" untuk mencoba analisa data sample</li>
                    <li>Jika belum memiliki data. Download custom view Analisis Data Pemain View di atas untuk menyesuaikan Tampilan FM pada Menu Squad &gt; First Team / U21 / U18.</li>
                    <li>Setelah download custom view letakan pada path\Documents\Sports Interactive\Football Manager 26\views (atau buat folder views baru jika tidak ada).</li>
                    <li>Pada layar menu Squad &gt; First Team / U21 / U18 klik kanan dan import Analisis Data Pemain View. Saat ini fitur export di FM26 belum tersedia, kamu dapat melakukan sendiri scan gambar menjadi text manual (OCR).</li>
                    <li>Atau kamu juga dapat menyalin manual dengan download template Excel yang sudah disediakan di atas.</li>
                </ul>
            </div>
            
            <div id="fileInfo" class="hidden" style="margin-top: 15px; text-align: center;">
                <div class="alert alert-success">
                    &#9989; File berhasil dimuat: <strong id="fileName"></strong>
                    <br>
                    <small id="playerCount"></small>
                </div>
            </div>
            
            <!-- Data Preview Table -->
            <div id="dataPreview" class="hidden" style="margin-top: 20px;">
                <h3 style="text-align: center; color: #2c3e50; margin-bottom: 15px;">&#128065; Preview Data Imported</h3>
                <div style="overflow: auto; max-height: 400px; border: 2px solid #e1e8ed; border-radius: 8px; background: white;">
                    <table id="previewTable" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; z-index: 10;">
                            <tr id="previewTableHeader"></tr>
                        </thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                </div>
                <p style="text-align: center; margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                    <em>Scroll horizontal/vertikal untuk lihat semua data</em>
                </p>
                
                <!-- Team Tactical Recommendation Button -->
                <div style="text-align: center; margin-top: 20px;">
                    <!-- Competition Level Selector -->
                    <div style="margin-bottom: 15px;">
                        <label for="competitionLevelSelect" style="display: block; color: #2c3e50; font-weight: 600; margin-bottom: 8px; font-size: 0.9em;">
                            üèÜ Level Kompetisi:
                        </label>
                        <select id="competitionLevelSelect" 
                                style="padding: 8px 16px; font-size: 0.9em; border: 2px solid #3498db; 
                                       border-radius: 6px; background: white; cursor: pointer; min-width: 300px;"
                                onchange="updateCompetitionLevel(this.value)">
                            <option value="top5" selected>Top 5 Leagues (EPL, La Liga, Serie A, Bundesliga, Ligue 1)</option>
                            <option value="mid">Mid-Tier Leagues (Eredivisie, Liga Portugal, Championship)</option>
                            <option value="lower">Lower Leagues / Tier 2</option>
                        </select>
                        <p style="margin-top: 5px; color: #7f8c8d; font-size: 0.8em; font-style: italic;">
                            Menyesuaikan threshold scoring sesuai level kompetisi
                        </p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showTeamTacticalRecommendation()" 
                            style="background: #27ae60; color: white; border: none;
                                   padding: 8px 16px; font-size: 0.9em; font-weight: 500; 
                                   border-radius: 6px; cursor: pointer;">
                        &#128161; Lihat Rekomendasi Taktik Berdasarkan Performa Individu
                    </button>
                    <p style="margin-top: 10px; color: red; font-size: 1.1em; font-weight: 600;">
                        Atau Pilih Pemain Di Bawah Ini Untuk Langsung Analisis Performa Individu
                    </p>
                </div>
            </div>
        </div>

        <div class="content hidden" id="mainContent">
            <!-- Team Tactical Recommendation Section -->
            <div id="teamTacticalRecommendation" class="hidden" style="margin-bottom: 30px;">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="closeTeamTacticalRecommendation()" 
                            style="background: #95a5a6; padding: 8px 20px;">
                        &#10006; Tutup Rekomendasi
                    </button>
                </div>
                
                <div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);">
                    <div class="card-header" style="color: #2c3e50; margin-bottom: 15px;"">
                        <div class="card-icon">&#9881;</div>
                        <div class="card-title">Rekomendasi Taktik Tim</div>
                    </div>
                    <div id="tacticalRecommendationContent" style="padding: 20px;"></div>
                </div>
            </div>
            
            <div class="player-selector">
                <label for="playerSelect">&#128100; Pilih Pemain untuk Dianalisis:</label>
                <select id="playerSelect" onchange="analyzePlayer()">
                    <option value="">-- Pilih Pemain --</option>
                </select>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-primary" onclick="exportAllPlayersData()" style="background: #27ae60; padding: 12px 24px; font-size: 0.95em;">
                        &#128190; Export Rekap Analisis All Player
                    </button>
                </div>
            </div>

            <div id="analysisResult" class="hidden">
                <!-- Player Header -->
                <div class="player-header" id="playerHeader"></div>

                <!-- Effectiveness Rating -->
                <div class="effectiveness-rating">
                    <h2>Rating Efektivitas</h2>
                    <div class="stars" id="effectivenessStars"></div>
                    <p id="effectivenessText" style="margin-top: 15px; font-size: 1.2em;"></p>
                </div>

                <!-- Key Stats -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#128202;</div>
                        <div class="card-title">Statistik Dasar</div>
                    </div>
                    <div class="stats-grid" id="basicStats"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#127912;</div>
                        <div class="card-title">Passing & Kreativitas (per 90')</div>
                    </div>
                    <div class="stats-grid" id="passingStats"></div>
                    <div id="passingAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#128257;</div>
                        <div class="card-title">Penguasaan Bola & Duel (per 90')</div>
                    </div>
                    <div class="stats-grid" id="possessionStats"></div>
                    <div id="possessionAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#9876;</div>
                        <div class="card-title">Menyerang (per 90')</div>
                    </div>
                    <div class="stats-grid" id="attackingStats"></div>
                    <div id="attackingAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#128737;</div>
                        <div class="card-title">Defensif (per 90')</div>
                    </div>
                    <div class="stats-grid" id="defensiveStats"></div>
                    <div id="defensiveAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#128170;</div>
                        <div class="card-title">Mobilitas & Fisik (per 90')</div>
                    </div>
                    <div class="stats-grid" id="physicalStats"></div>
                    <div id="physicalAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#129516;</div>
                        <div class="card-title">Goalkeeper / GK Metrics</div>
                    </div>
                    <div class="stats-grid" id="goalkeeperStats"></div>
                    <div id="goalkeeperAnalysis" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                </div>

                <!-- Insights Section -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#128161;</div>
                        <div class="card-title">Analisis Mendalam</div>
                    </div>
                    <ul class="insight-list" id="insightsList"></ul>
                </div>

                <!-- Recommendations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">&#127891;</div>
                        <div class="card-title">Kesimpulan & Rekomendasi Training</div>
                    </div>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let playersData = [];
        let currentPlayer = null;

        // File Upload Handlers
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    playersData = jsonData;
                    console.log('Data loaded:', playersData[0]);
                    
                    populatePlayerList();
                    
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('playerCount').textContent = 
                        `Total ${playersData.length} pemain berhasil dimuat`;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                } catch (error) {
                    alert('Error membaca file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadTestData() {
            // Real Everton squad data from FM Analytics (representing each position)
            playersData = [
                {
                    "Player": "Jordan Pickford",
                    "Position": "GK",
                    "Age": 31,
                    "Best Pos": "GK",
                    "Best Role": "BGK",
                    "Pros": "One On Ones",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 7.13,
                    "Pr passes/90": 0.7,
                    "Ps A/90": 23.4,
                    "Ps C/90": 18.7,
                    "Poss Won/90": 7.8,
                    "Poss Lost/90": 6.7,
                    "OP-KP/90": 0,
                    "Asts/90": 0,
                    "Ch C/90": 0,
                    "OP-Crs A/90": 0,
                    "OP-Crs C/90": 0,
                    "Drb/90": 0,
                    "Dist/90": 4.2,
                    "Sprints/90": 0,
                    "Shot/90": 0,
                    "Sht/90": 0,
                    "xG/shot": 0,
                    "xG/90": 0,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0,
                    "Shot %": 0,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": 26,
                    "Hdrs W/90": 0,
                    "BlK/90": 0,
                    "Aer A/90": 0,
                    "Clr/90": 0,
                    "Int/90": 2.9,
                    "Pres A/90": 0,
                    "Pres C/90": 0,
                    "Tck/90": 0.1,
                    "Tck R": 100,
                    "xGP/90": 0.2,
                    "xSv %": 87,
                    "xGP": 5.71,
                    "Sv %": 83,
                    "Cln/90": 0.4,
                    "Shutouts": 10,
                    "All/90": 1.1
                },
                {
                    "Player": "Michael Keane",
                    "Position": "D (C)",
                    "Age": 33,
                    "Best Pos": "D (C)",
                    "Best Role": "BCB",
                    "Pros": "Heading",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.62,
                    "Pr passes/90": 1.3,
                    "Ps A/90": 31.6,
                    "Ps C/90": 30.7,
                    "Poss Won/90": 3.5,
                    "Poss Lost/90": 2.2,
                    "OP-KP/90": 0,
                    "Asts/90": 0,
                    "Ch C/90": 0,
                    "OP-Crs A/90": 0,
                    "OP-Crs C/90": 0,
                    "Drb/90": 0,
                    "Dist/90": 10.2,
                    "Sprints/90": 3.5,
                    "Shot/90": 0,
                    "Sht/90": 0,
                    "xG/shot": 0,
                    "xG/90": 0,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0,
                    "Shot %": 0,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": "2 (6)",
                    "Hdrs W/90": 0.4,
                    "BlK/90": 0,
                    "Aer A/90": 1.3,
                    "Clr/90": 2.2,
                    "Int/90": 1.3,
                    "Pres A/90": 0.9,
                    "Pres C/90": 0.4,
                    "Tck/90": 2.2,
                    "Tck R": 100,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Jarrad Branthwaite",
                    "Position": "D (RLC)",
                    "Age": 23,
                    "Best Pos": "D (C)",
                    "Best Role": "BCB",
                    "Pros": "Heading",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 6.97,
                    "Pr passes/90": 2.4,
                    "Ps A/90": 41.3,
                    "Ps C/90": 38,
                    "Poss Won/90": 8.7,
                    "Poss Lost/90": 3.9,
                    "OP-KP/90": 0.1,
                    "Asts/90": 0,
                    "Ch C/90": 0,
                    "OP-Crs A/90": 0,
                    "OP-Crs C/90": 0,
                    "Drb/90": 0.1,
                    "Dist/90": 10.1,
                    "Sprints/90": 5.3,
                    "Shot/90": 0.4,
                    "Sht/90": 0.2,
                    "xG/shot": 0.075,
                    "xG/90": 0,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0,
                    "Shot %": 42,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": "27 (1)",
                    "Hdrs W/90": 4.2,
                    "BlK/90": 0.9,
                    "Aer A/90": 5,
                    "Clr/90": 1.4,
                    "Int/90": 2.9,
                    "Pres A/90": 2.8,
                    "Pres C/90": 0.6,
                    "Tck/90": 1.2,
                    "Tck R": 70,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Nathan Patterson",
                    "Position": "D/WB (R)",
                    "Age": 24,
                    "Best Pos": "D (R)",
                    "Best Role": "WB",
                    "Pros": "Speed",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.76,
                    "Pr passes/90": 7.2,
                    "Ps A/90": 53,
                    "Ps C/90": 48.1,
                    "Poss Won/90": 11.1,
                    "Poss Lost/90": 9,
                    "OP-KP/90": 1.6,
                    "Asts/90": 0,
                    "Ch C/90": 0,
                    "OP-Crs A/90": 2.5,
                    "OP-Crs C/90": 0.4,
                    "Drb/90": 0.8,
                    "Dist/90": 12.7,
                    "Sprints/90": 15.2,
                    "Shot/90": 0.4,
                    "Sht/90": 0.2,
                    "xG/shot": 0.165,
                    "xG/90": 0.1,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0.2,
                    "Shot %": 50,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": "2 (8)",
                    "Hdrs W/90": 0.6,
                    "BlK/90": 0.8,
                    "Aer A/90": 1.8,
                    "Clr/90": 1.4,
                    "Int/90": 2.9,
                    "Pres A/90": 12.9,
                    "Pres C/90": 2.9,
                    "Tck/90": 2.5,
                    "Tck R": 65,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Jake O'Brien",
                    "Position": "D (RC)",
                    "Age": 24,
                    "Best Pos": "D (R)",
                    "Best Role": "IFB",
                    "Pros": "Heading",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.73,
                    "Pr passes/90": 2.7,
                    "Ps A/90": 40.1,
                    "Ps C/90": 34.7,
                    "Poss Won/90": 8.6,
                    "Poss Lost/90": 6.9,
                    "OP-KP/90": 0.3,
                    "Asts/90": 0,
                    "Ch C/90": 0.1,
                    "OP-Crs A/90": 0.3,
                    "OP-Crs C/90": 0,
                    "Drb/90": 0.3,
                    "Dist/90": 11,
                    "Sprints/90": 8.8,
                    "Shot/90": 0.5,
                    "Sht/90": 0.1,
                    "xG/shot": 0.0575,
                    "xG/90": 0,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0.2,
                    "Shot %": 13,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": "14 (6)",
                    "Hdrs W/90": 3.9,
                    "BlK/90": 0.5,
                    "Aer A/90": 4.6,
                    "Clr/90": 2.3,
                    "Int/90": 2.1,
                    "Pres A/90": 4.5,
                    "Pres C/90": 1.4,
                    "Tck/90": 1.9,
                    "Tck R": 81,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Seamus Coleman",
                    "Position": "D (RC), WB/M (R)",
                    "Age": 37,
                    "Best Pos": "D (R)",
                    "Best Role": "IWB",
                    "Pros": "Team Player",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.86,
                    "Pr passes/90": 5.9,
                    "Ps A/90": 49,
                    "Ps C/90": 43.9,
                    "Poss Won/90": 10,
                    "Poss Lost/90": 7.8,
                    "OP-KP/90": 1.1,
                    "Asts/90": 0.2,
                    "Ch C/90": 0.3,
                    "OP-Crs A/90": 1.3,
                    "OP-Crs C/90": 0.4,
                    "Drb/90": 0.9,
                    "Dist/90": 12.4,
                    "Sprints/90": 18.4,
                    "Shot/90": 0.4,
                    "Sht/90": 0,
                    "xG/shot": 0.0116,
                    "xG/90": 0,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.4,
                    "Shot %": 0,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 3,
                    "Goals From Outside The Box": 0,
                    "Appearances": "19 (4)",
                    "Hdrs W/90": 1.3,
                    "BlK/90": 0.5,
                    "Aer A/90": 2.8,
                    "Clr/90": 1,
                    "Int/90": 2.6,
                    "Pres A/90": 11.9,
                    "Pres C/90": 3.3,
                    "Tck/90": 3.8,
                    "Tck R": 90,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Adam Aznou",
                    "Position": "D (RL), WB (L)",
                    "Age": 19,
                    "Best Pos": "WB (L)",
                    "Best Role": "AWB",
                    "Pros": "Speed",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 6.97,
                    "Pr passes/90": 7,
                    "Ps A/90": 52.9,
                    "Ps C/90": 48.2,
                    "Poss Won/90": 8.1,
                    "Poss Lost/90": 10.5,
                    "OP-KP/90": 1.5,
                    "Asts/90": 0.1,
                    "Ch C/90": 0.4,
                    "OP-Crs A/90": 3.2,
                    "OP-Crs C/90": 0.9,
                    "Drb/90": 3.7,
                    "Dist/90": 13.2,
                    "Sprints/90": 19.4,
                    "Shot/90": 0.5,
                    "Sht/90": 0.3,
                    "xG/shot": 0.076,
                    "xG/90": 0,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.3,
                    "Shot %": 60,
                    "Goals": 1,
                    "Conv %": "20%",
                    "Assists": 1,
                    "Goals From Outside The Box": 0,
                    "Appearances": "10 (5)",
                    "Hdrs W/90": 0.7,
                    "BlK/90": 0.5,
                    "Aer A/90": 1.6,
                    "Clr/90": 1.2,
                    "Int/90": 2.2,
                    "Pres A/90": 11,
                    "Pres C/90": 3.7,
                    "Tck/90": 3.3,
                    "Tck R": 88,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Vitaliy Mykolenko",
                    "Position": "D/WB (L)",
                    "Age": 26,
                    "Best Pos": "D (L)",
                    "Best Role": "WB",
                    "Pros": "Speed",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 6.76,
                    "Pr passes/90": 7,
                    "Ps A/90": 55.1,
                    "Ps C/90": 48.4,
                    "Poss Won/90": 9.5,
                    "Poss Lost/90": 11.8,
                    "OP-KP/90": 1.2,
                    "Asts/90": 0.1,
                    "Ch C/90": 0.4,
                    "OP-Crs A/90": 3.6,
                    "OP-Crs C/90": 0.6,
                    "Drb/90": 1.4,
                    "Dist/90": 12.6,
                    "Sprints/90": 18.2,
                    "Shot/90": 0.3,
                    "Sht/90": 0,
                    "xG/shot": 0.07,
                    "xG/90": 0,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.2,
                    "Shot %": 0,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 1,
                    "Goals From Outside The Box": 0,
                    "Appearances": "17 (3)",
                    "Hdrs W/90": 2.4,
                    "BlK/90": 0.4,
                    "Aer A/90": 3.2,
                    "Clr/90": 1.3,
                    "Int/90": 2.4,
                    "Pres A/90": 13,
                    "Pres C/90": 3.4,
                    "Tck/90": 2,
                    "Tck R": 67,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Idrissa Gueye",
                    "Position": "DM, M (C)",
                    "Age": 36,
                    "Best Pos": "DM",
                    "Best Role": "DM",
                    "Pros": "Team Player",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.79,
                    "Pr passes/90": 4.5,
                    "Ps A/90": 43.3,
                    "Ps C/90": 39.8,
                    "Poss Won/90": 7.7,
                    "Poss Lost/90": 4.9,
                    "OP-KP/90": 0.7,
                    "Asts/90": 0,
                    "Ch C/90": 0,
                    "OP-Crs A/90": 0.1,
                    "OP-Crs C/90": 0,
                    "Drb/90": 0.2,
                    "Dist/90": 12.4,
                    "Sprints/90": 10.9,
                    "Shot/90": 0.6,
                    "Sht/90": 0.1,
                    "xG/shot": 0.03,
                    "xG/90": 0,
                    "xA/90": 0,
                    "Shots From Outside The Box per 90 Minutes": 0.6,
                    "Shot %": 13,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 0,
                    "Goals From Outside The Box": 0,
                    "Appearances": 24,
                    "Hdrs W/90": 0.3,
                    "BlK/90": 0.5,
                    "Aer A/90": 1.2,
                    "Clr/90": 1.6,
                    "Int/90": 2.7,
                    "Pres A/90": 9.3,
                    "Pres C/90": 2.4,
                    "Tck/90": 2.6,
                    "Tck R": 79,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Kiernan Dewsbury-Hall",
                    "Position": "DM, M/AM (C)",
                    "Age": 27,
                    "Best Pos": "M (C)",
                    "Best Role": "MPM",
                    "Pros": "Athleticism",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 6.79,
                    "Pr passes/90": 3.9,
                    "Ps A/90": 50,
                    "Ps C/90": 45.7,
                    "Poss Won/90": 6.6,
                    "Poss Lost/90": 7.8,
                    "OP-KP/90": 1,
                    "Asts/90": 0.2,
                    "Ch C/90": 0.3,
                    "OP-Crs A/90": 0.5,
                    "OP-Crs C/90": 0.1,
                    "Drb/90": 0.7,
                    "Dist/90": 12.5,
                    "Sprints/90": 12.3,
                    "Shot/90": 1.1,
                    "Sht/90": 0.3,
                    "xG/shot": 0.065,
                    "xG/90": 0.1,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.8,
                    "Shot %": 25,
                    "Goals": 0,
                    "Conv %": "0%",
                    "Assists": 2,
                    "Goals From Outside The Box": 0,
                    "Appearances": "10 (4)",
                    "Hdrs W/90": 0.5,
                    "BlK/90": 0.1,
                    "Aer A/90": 2,
                    "Clr/90": 1.3,
                    "Int/90": 2,
                    "Pres A/90": 8,
                    "Pres C/90": 2.2,
                    "Tck/90": 2,
                    "Tck R": 72,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "James Garner",
                    "Position": "DM, M (C)",
                    "Age": 24,
                    "Best Pos": "M (C)",
                    "Best Role": "CM",
                    "Pros": "Team Player",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.84,
                    "Pr passes/90": 4.8,
                    "Ps A/90": 50.1,
                    "Ps C/90": 45.2,
                    "Poss Won/90": 8,
                    "Poss Lost/90": 8.2,
                    "OP-KP/90": 1.5,
                    "Asts/90": 0.1,
                    "Ch C/90": 0.2,
                    "OP-Crs A/90": 0.3,
                    "OP-Crs C/90": 0.1,
                    "Drb/90": 0.5,
                    "Dist/90": 12.8,
                    "Sprints/90": 14.7,
                    "Shot/90": 1.4,
                    "Sht/90": 0.5,
                    "xG/shot": 0.05,
                    "xG/90": 0.1,
                    "xA/90": 0.1,
                    "Shots From Outside The Box per 90 Minutes": 1.3,
                    "Shot %": 32,
                    "Goals": 1,
                    "Conv %": "3%",
                    "Assists": 2,
                    "Goals From Outside The Box": 0,
                    "Appearances": 26,
                    "Hdrs W/90": 1,
                    "BlK/90": 0.2,
                    "Aer A/90": 2,
                    "Clr/90": 1.3,
                    "Int/90": 2.5,
                    "Pres A/90": 10.5,
                    "Pres C/90": 2.9,
                    "Tck/90": 1.7,
                    "Tck R": 70,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Carlos Alcaraz",
                    "Position": "M/AM (C)",
                    "Age": 23,
                    "Best Pos": "AM (C)",
                    "Best Role": "AP",
                    "Pros": "Intelligence",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.82,
                    "Pr passes/90": 2.8,
                    "Ps A/90": 47.5,
                    "Ps C/90": 41.3,
                    "Poss Won/90": 5.9,
                    "Poss Lost/90": 9.6,
                    "OP-KP/90": 1.8,
                    "Asts/90": 0.2,
                    "Ch C/90": 0.7,
                    "OP-Crs A/90": 0.7,
                    "OP-Crs C/90": 0.1,
                    "Drb/90": 2.5,
                    "Dist/90": 13.1,
                    "Sprints/90": 14.3,
                    "Shot/90": 1.6,
                    "Sht/90": 0.8,
                    "xG/shot": 0.1655,
                    "xG/90": 0.3,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.6,
                    "Shot %": 52,
                    "Goals": 4,
                    "Conv %": "15%",
                    "Assists": 3,
                    "Goals From Outside The Box": 0,
                    "Appearances": "17 (4)",
                    "Hdrs W/90": 1.9,
                    "BlK/90": 1.9,
                    "Aer A/90": 0.2,
                    "Clr/90": 3.8,
                    "Int/90": 0.9,
                    "Pres A/90": 2,
                    "Pres C/90": 8.1,
                    "Tck/90": 2.3,
                    "Tck R": 1,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Dwight McNeil",
                    "Position": "M/AM (RL), ST (C)",
                    "Age": 26,
                    "Best Pos": "M (L)",
                    "Best Role": "WM",
                    "Pros": "Team Player",
                    "Preferred Foot": "Left-Footed",
                    "Avg Rat": 6.73,
                    "Pr passes/90": 5.4,
                    "Ps A/90": 40.4,
                    "Ps C/90": 34.9,
                    "Poss Won/90": 6.2,
                    "Poss Lost/90": 15.1,
                    "OP-KP/90": 1.9,
                    "Asts/90": 0.1,
                    "Ch C/90": 3.4,
                    "OP-Crs A/90": 3.4,
                    "OP-Crs C/90": 0.7,
                    "Drb/90": 5.9,
                    "Dist/90": 13.1,
                    "Sprints/90": 20.3,
                    "Shot/90": 2,
                    "Sht/90": 1,
                    "xG/shot": 0.0731,
                    "xG/90": 0.1,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 1.2,
                    "Shot %": 47,
                    "Goals": 4,
                    "Conv %": "11%",
                    "Assists": 2,
                    "Goals From Outside The Box": 3,
                    "Appearances": "21 (6)",
                    "Hdrs W/90": 1.4,
                    "BlK/90": 1.4,
                    "Aer A/90": 0.2,
                    "Clr/90": 3.6,
                    "Int/90": 0.3,
                    "Pres A/90": 2.1,
                    "Pres C/90": 13.3,
                    "Tck/90": 3.3,
                    "Tck R": 2.3,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Thierno Barry",
                    "Position": "AM (RL), ST (C)",
                    "Age": 23,
                    "Best Pos": "ST (C)",
                    "Best Role": "TF",
                    "Pros": "Heading",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.92,
                    "Pr passes/90": 2.2,
                    "Ps A/90": 30.6,
                    "Ps C/90": 26.8,
                    "Poss Won/90": 5.4,
                    "Poss Lost/90": 9.6,
                    "OP-KP/90": 1.5,
                    "Asts/90": 0.4,
                    "Ch C/90": 2,
                    "OP-Crs A/90": 2,
                    "OP-Crs C/90": 0.3,
                    "Drb/90": 4,
                    "Dist/90": 13,
                    "Sprints/90": 16.8,
                    "Shot/90": 2.5,
                    "Sht/90": 0.9,
                    "xG/shot": 0.1407,
                    "xG/90": 0.3,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.8,
                    "Shot %": 38,
                    "Goals": 4,
                    "Conv %": "10%",
                    "Assists": 6,
                    "Goals From Outside The Box": 1,
                    "Appearances": "14 (10)",
                    "Hdrs W/90": 4.1,
                    "BlK/90": 4.1,
                    "Aer A/90": 0.2,
                    "Clr/90": 6.6,
                    "Int/90": 0.4,
                    "Pres A/90": 1.8,
                    "Pres C/90": 7.1,
                    "Tck/90": 1.4,
                    "Tck R": 0.9,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                },
                {
                    "Player": "Iliman N'Diaye",
                    "Position": "AM (RLC), ST (C)",
                    "Age": 25,
                    "Best Pos": "ST (C)",
                    "Best Role": "CHF",
                    "Pros": "Skill",
                    "Preferred Foot": "Right-Footed",
                    "Avg Rat": 6.76,
                    "Pr passes/90": 2.9,
                    "Ps A/90": 37.5,
                    "Ps C/90": 32.9,
                    "Poss Won/90": 5.3,
                    "Poss Lost/90": 11.8,
                    "OP-KP/90": 2.4,
                    "Asts/90": 0.3,
                    "Ch C/90": 2.9,
                    "OP-Crs A/90": 2.9,
                    "OP-Crs C/90": 0.5,
                    "Drb/90": 3.8,
                    "Dist/90": 12.3,
                    "Sprints/90": 11.5,
                    "Shot/90": 1.4,
                    "Sht/90": 0.9,
                    "xG/shot": 0.0875,
                    "xG/90": 0.1,
                    "xA/90": 0.2,
                    "Shots From Outside The Box per 90 Minutes": 0.5,
                    "Shot %": 63,
                    "Goals": 1,
                    "Conv %": "13%",
                    "Assists": 2,
                    "Goals From Outside The Box": 0,
                    "Appearances": "7 (3)",
                    "Hdrs W/90": 0,
                    "BlK/90": 0,
                    "Aer A/90": 0.7,
                    "Clr/90": 2.1,
                    "Int/90": 0.9,
                    "Pres A/90": 2.4,
                    "Pres C/90": 13,
                    "Tck/90": 3.6,
                    "Tck R": 1.7,
                    "xGP/90": 0,
                    "xSv %": 0,
                    "xGP": 0,
                    "Sv %": 0,
                    "Cln/90": 0,
                    "Shutouts": 0,
                    "All/90": 0
                }
            ];
            
            console.log('Test data loaded (hardcoded):', playersData.length, 'players');
            
            populatePlayerList();
            
            document.getElementById('fileName').textContent = 'Sample Data - Everton Squad';
            document.getElementById('playerCount').textContent = 
                `Total ${playersData.length} pemain test berhasil dimuat`;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Team Tactical Recommendation Functions
        function showTeamTacticalRecommendation() {
            if (!playersData || playersData.length === 0) {
                alert('&#9888; Tidak ada data pemain. Silakan upload file terlebih dahulu.');
                return;
            }
            
            // Show the recommendation section
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('teamTacticalRecommendation').classList.remove('hidden');
            
            // Analyze squad and generate recommendations
            const analysis = analyzeSquadStrengths({ mode: CURRENT_NORMALIZATION_MODE });
            displayTacticalRecommendations(analysis);
            
            // Scroll to the recommendation section
            document.getElementById('teamTacticalRecommendation').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeTeamTacticalRecommendation() {
            document.getElementById('teamTacticalRecommendation').classList.add('hidden');
        }
        
        function updateCompetitionLevel(level) {
            CURRENT_COMPETITION = level;
            console.log(`Competition level changed to: ${COMPETITION_PRESETS[level].name}`);
            // If recommendation is already shown, refresh it
            const recDiv = document.getElementById('teamTacticalRecommendation');
            if (!recDiv.classList.contains('hidden')) {
                showTeamTacticalRecommendation();
            }
        }

        function updateNormalizationMode(mode) {
            if (!mode) return;
            CURRENT_NORMALIZATION_MODE = mode;
            console.log(`Normalization mode changed to: ${mode}`);
            // Update select element state (in case called programmatically)
            const sel = document.getElementById('normalizationModeSelect');
            if (sel && sel.value !== mode) sel.value = mode;
            // If recommendation is visible, refresh
            const recDiv = document.getElementById('teamTacticalRecommendation');
            if (!recDiv.classList.contains('hidden')) {
                showTeamTacticalRecommendation();
            }
        }
        
        // =========================
        // UTILITY FUNCTIONS
        // =========================
        function clamp(value, min = 0, max = 10) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return min;
            }
            return Math.max(min, Math.min(max, value));
        }
        
        function safeDiv(numerator, denominator, fallback = 0) {
            if (denominator === 0 || denominator === null || denominator === undefined || Number.isNaN(denominator)) {
                return fallback;
            }
            const result = numerator / denominator;
            return Number.isNaN(result) ? fallback : result;
        }
        
        // =========================
        // CONFIGURATION
        // =========================
        
        // Competition level presets
        const COMPETITION_PRESETS = {
            'top5': {
                name: 'Top 5 Leagues (EPL, La Liga, Serie A, Bundesliga, Ligue 1)',
                factor: 1.00,
                description: 'Baseline - Elite competition'
            },
            'mid': {
                name: 'Mid-Tier Leagues (Eredivisie, Liga Portugal, Championship)',
                factor: 0.90,
                description: 'Stats slightly inflated vs Top 5'
            },
            'lower': {
                name: 'Lower Leagues / Tier 2',
                factor: 0.80,
                description: 'Stats more inflated vs weaker opposition'
            }
        };
        
        // Current competition setting (changeable)
        let CURRENT_COMPETITION = 'top5'; // default: Top 5 Leagues
    // Current normalization mode (category | perMetric)
    let CURRENT_NORMALIZATION_MODE = 'category'; // default: 'category'
        
        // Base MAX_EXPECTED values (calibrated for Top 5 Leagues)
        const BASE_MAX_EXPECTED = {
            attacking: 24.5,   // xG:3.0√ó4 + xA:1.0√ó2 + SoT:60√∑8 + G/xG:1.5√ó2
            creativity: 15.0,  // KeyP:6.0√ó1.8 + xA:1.0√ó3 + ProgP:40√ó0.2 + Drb:6.0√ó0.3
            possession: 20.0,  // PassAcc:95√∑12 + ProgP:40√ó0.6 + Tch:140√∑20 + PossWon:20√ó0.4
            pressing: 15.0,    // PressAtt:260√ó0.05 + PressSuc:60√∑12 + PossWon:20√ó0.25 + Dist:12.5√∑300
            defensive: 15.0,   // Tck:6.0√ó1.0 + Int:6.0√ó1.0 + Blk:4.0√ó0.6 + Clr:10.0√ó0.4 + Aer:80√∑25
            physical: 15.0     // Dist:12.5√∑70 + Spr:180√ó0.08 + Duel:60√ó0.2 + Tck:6.0√ó0.2
        };
        
        // Function to get adjusted MAX_EXPECTED based on competition level
        function getAdjustedMaxExpected(competitionLevel = 'top5') {
            const factor = COMPETITION_PRESETS[competitionLevel]?.factor || 1.00;
            const adjusted = {};
            Object.keys(BASE_MAX_EXPECTED).forEach(key => {
                // Higher factor = lower threshold = harder to get 10/10
                // Lower factor = higher threshold = easier to get high scores
                adjusted[key] = BASE_MAX_EXPECTED[key] / factor;
            });
            return adjusted;
        }
        
        // Get current MAX_EXPECTED (dynamically adjusted)
        const MAX_EXPECTED = getAdjustedMaxExpected(CURRENT_COMPETITION);
        
        // Per-metric caps (realistic max values per metric)
        const METRIC_CAPS = {
            xG_per90: 3.0,
            xA_per90: 1.0,
            SoT_pct: 60.0,
            Goal_xG: 1.5,
            KeyP_per90: 6.0,
            ProgPasses_per90: 40.0,
            Dribbles_per90: 6.0,
            PassAcc_pct: 95.0,
            Touches_per90: 140.0,
            PossWon_per90: 20.0,
            PressAttempts_per90: 260.0,
            PressSucc_pct: 60.0,
            Distance_km_per90: 12.5,
            Tackles_per90: 6.0,
            Interceptions_per90: 6.0,
            Blocks_per90: 4.0,
            Clearances_per90: 10.0,
            AerialWin_pct: 80.0,
            Sprints_per90: 180.0,
            Duels_per90: 60.0
        };
        
        // Weighted combination for per-metric mode
        const ATTACKING_WEIGHTS = { xG_per90: 0.45, xA_per90: 0.25, SoT_pct: 0.15, Goal_xG: 0.15 };
        const CREATIVITY_WEIGHTS = { KeyP_per90: 0.40, xA_per90: 0.30, ProgPasses_per90: 0.20, Dribbles_per90: 0.10 };
        const POSSESSION_WEIGHTS = { PassAcc_pct: 0.45, ProgPasses_per90: 0.30, Touches_per90: 0.15, PossWon_per90: 0.10 };
        const PRESSING_WEIGHTS = { PressAttempts_per90: 0.40, PressSucc_pct: 0.35, PossWon_per90: 0.15, Distance_km_per90: 0.10 };
        const DEFENSIVE_WEIGHTS = { Tackles_per90: 0.30, Interceptions_per90: 0.25, Blocks_per90: 0.20, Clearances_per90: 0.15, AerialWin_pct: 0.10 };
        const PHYSICAL_WEIGHTS = { Distance_km_per90: 0.35, Sprints_per90: 0.30, Duels_per90: 0.20, Tackles_per90: 0.15 };
        
        // =========================
        // HELPER FUNCTIONS
        // =========================
        function capMetric(value, metricKey) {
            const cap = METRIC_CAPS[metricKey];
            if (cap === undefined) return value;
            return clamp(value, 0, cap);
        }
        
        function normalizeScoreCategory(rawScore, category) {
            const maxExpected = MAX_EXPECTED[category] || 10.0;
            if (maxExpected <= 0) return clamp(rawScore);
            const normalized = (rawScore / maxExpected) * 10.0;
            return clamp(normalized, 0, 10);
        }
        
        function normalizeMetricTo0_10(value, metricKey) {
            const cap = METRIC_CAPS[metricKey] || 1.0;
            // Map 0..cap -> 0..10
            return clamp((value / cap) * 10.0, 0, 10);
        }
        
        function getTierLabel(score) {
            if (score >= 7.0) return 'Elite';
            if (score >= 5.0) return 'Good';
            if (score >= 3.0) return 'Average';
            return 'Weak';
        }
        
        function getTierColor(score) {
            if (score >= 7.0) return '#27ae60';  // Green
            if (score >= 5.0) return '#3498db';  // Blue
            if (score >= 3.0) return '#f39c12';  // Orange
            return '#e74c3c';  // Red
        }
        
        // =========================
        // CORE: Per-player raw calculation
        // =========================
        function computePlayerRawContrib(player) {
            // Helper to read attributes with multiple possible keys
            const read = (names) => {
                for (const k of names) {
                    const val = findAttribute(player, [k]);
                    if (val !== undefined && val !== null && val !== '') {
                        const num = parseFloat(val);
                        if (!isNaN(num)) return num;
                    }
                }
                return 0;
            };
            
            // Raw inputs (per 90 assumed) with per-metric caps applied
            const xG = capMetric(read(['xG/90', 'xG', 'xg/90']), 'xG_per90');
            const xA = capMetric(read(['xA/90', 'xA', 'xa/90']), 'xA_per90');
            const keyP = capMetric(read(['Key Ps/90', 'KeyPs/90', 'Key Passes/90', 'OP-KP/90']), 'KeyP_per90');
            const SoT = capMetric(read(['Shot %', 'Shot%', 'ShT %']), 'SoT_pct');
            const goalsP90 = read(['Goals/90', 'Gls/90', 'Goals']);
            const dribbles = capMetric(read(['Drb/90', 'Dribbles/90', 'dribbles/90', 'Succ Drb/90']), 'Dribbles_per90');
            const progPasses = capMetric(read(['Prog Ps/90', 'ProgPs/90', 'Progressive Passes/90', 'Pr passes/90']), 'ProgPasses_per90');
            const touches = capMetric(read(['Tch/90', 'Touches/90', 'touches/90']), 'Touches_per90');
            const possWon = capMetric(read(['Poss Won/90', 'PossWon/90', 'Recoveries/90']), 'PossWon_per90');
            const tackles = capMetric(read(['Tck/90', 'Tackles/90', 'tackles/90']), 'Tackles_per90');
            const interceptions = capMetric(read(['Int/90', 'Interceptions/90', 'int/90']), 'Interceptions_per90');
            const blocks = capMetric(read(['Blk/90', 'Blocks/90', 'blocks/90']), 'Blocks_per90');
            const clearances = capMetric(read(['Clr/90', 'Clearances/90', 'clearances/90']), 'Clearances_per90');
            const aerialWin = capMetric(read(['Aerial Win %', 'AerialWin%', 'Aerial%', 'Aer A/90']), 'AerialWin_pct');
            const distance = capMetric(read(['Dist/90', 'Distance/90', 'dist/90']), 'Distance_km_per90');
            const sprints = capMetric(read(['Sprints/90', 'sprints/90']), 'Sprints_per90');
            const duels = capMetric(read(['Duels/90', 'duels/90', 'Aer A/90']), 'Duels_per90');
            
            // Pass accuracy (safe)
            const psC = read(['Ps C/90', 'Passes Completed']);
            const psA = read(['Ps A/90', 'Passes Attempted']);
            const passAccRaw = safeDiv(psC, psA, 0) * 100;
            const passAcc = capMetric(passAccRaw, 'PassAcc_pct');
            
            // Press success (safe - single calculation)
            const presC = read(['Pres C/90', 'Pressures Completed']);
            const presA = read(['Pres A/90', 'Pressures Attempted']);
            const pressSuccessRaw = safeDiv(presC, presA, 0) * 100;
            const pressSuccess = capMetric(pressSuccessRaw, 'PressSucc_pct');
            const pressAtt = capMetric(presA, 'PressAttempts_per90');
            
            // Finishing efficiency (safe - handles xG == 0)
            let finishingEfficiency = 0;
            if (xG > 0) {
                finishingEfficiency = safeDiv(goalsP90, xG, 0);
            }
            finishingEfficiency = clamp(finishingEfficiency, 0, METRIC_CAPS.Goal_xG || 1.5);
            
            // Compute raw category contributions (using formulas with capped metrics)
            const attackingRaw = (xG * 4) + (xA * 2) + (SoT / 8) + (finishingEfficiency * 2);
            const creativityRaw = (keyP * 1.8) + (xA * 3) + (progPasses * 0.2) + (dribbles * 0.3);
            const possessionRaw = (passAcc / 12) + (progPasses * 0.6) + (touches / 20) + (possWon * 0.4);
            const pressingRaw = (pressAtt * 0.05) + (pressSuccess / 12) + (possWon * 0.25) + (distance / 300);
            const defensiveRaw = (tackles * 1.0) + (interceptions * 1.0) + (blocks * 0.6) + (clearances * 0.4) + (aerialWin / 25);
            const physicalRaw = (distance / 70) + (sprints * 0.08) + (duels * 0.2) + (tackles * 0.2);
            
            // Per-metric normalized values (0..10) for per-metric mode
            const perMetricNorm = {
                xG_per90: normalizeMetricTo0_10(xG, 'xG_per90'),
                xA_per90: normalizeMetricTo0_10(xA, 'xA_per90'),
                SoT_pct: normalizeMetricTo0_10(SoT, 'SoT_pct'),
                Goal_xG: normalizeMetricTo0_10(finishingEfficiency, 'Goal_xG'),
                KeyP_per90: normalizeMetricTo0_10(keyP, 'KeyP_per90'),
                ProgPasses_per90: normalizeMetricTo0_10(progPasses, 'ProgPasses_per90'),
                Dribbles_per90: normalizeMetricTo0_10(dribbles, 'Dribbles_per90'),
                PassAcc_pct: normalizeMetricTo0_10(passAcc, 'PassAcc_pct'),
                Touches_per90: normalizeMetricTo0_10(touches, 'Touches_per90'),
                PossWon_per90: normalizeMetricTo0_10(possWon, 'PossWon_per90'),
                PressAttempts_per90: normalizeMetricTo0_10(pressAtt, 'PressAttempts_per90'),
                PressSucc_pct: normalizeMetricTo0_10(pressSuccess, 'PressSucc_pct'),
                Distance_km_per90: normalizeMetricTo0_10(distance, 'Distance_km_per90'),
                Tackles_per90: normalizeMetricTo0_10(tackles, 'Tackles_per90'),
                Interceptions_per90: normalizeMetricTo0_10(interceptions, 'Interceptions_per90'),
                Blocks_per90: normalizeMetricTo0_10(blocks, 'Blocks_per90'),
                Clearances_per90: normalizeMetricTo0_10(clearances, 'Clearances_per90'),
                AerialWin_pct: normalizeMetricTo0_10(aerialWin, 'AerialWin_pct'),
                Sprints_per90: normalizeMetricTo0_10(sprints, 'Sprints_per90'),
                Duels_per90: normalizeMetricTo0_10(duels, 'Duels_per90')
            };
            
            return {
                raw: {
                    attacking: attackingRaw,
                    creativity: creativityRaw,
                    possession: possessionRaw,
                    pressing: pressingRaw,
                    defensive: defensiveRaw,
                    physical: physicalRaw
                },
                perMetricNorm,
                debug: {
                    inputs: { xG, xA, SoT, finishingEfficiency, keyP, progPasses, dribbles, passAcc, pressAtt, pressSuccess, distance, sprints, duels, tackles, interceptions, blocks, clearances, aerialWin, touches, possWon },
                    contributions: {
                        attacking: { xG: xG * 4, xA: xA * 2, SoT: SoT / 8, finish: finishingEfficiency * 2 },
                        creativity: { keyP: keyP * 1.8, xA: xA * 3, prog: progPasses * 0.2, drb: dribbles * 0.3 },
                        possession: { passAcc: passAcc / 12, prog: progPasses * 0.6, touches: touches / 20, possWon: possWon * 0.4 },
                        pressing: { pressAtt: pressAtt * 0.05, pressSuc: pressSuccess / 12, possWon: possWon * 0.25, dist: distance / 300 },
                        defensive: { tck: tackles * 1.0, int: interceptions * 1.0, blk: blocks * 0.6, clr: clearances * 0.4, aer: aerialWin / 25 },
                        physical: { dist: distance / 70, spr: sprints * 0.08, duel: duels * 0.2, tck: tackles * 0.2 }
                    }
                }
            };
        }
        
        // =========================
        // MAIN: Squad Strength Analysis
        // Options: mode ('category' or 'perMetric'), minutesWeighted, debug, competitionLevel
        // =========================
        function analyzeSquadStrengths(options = {}) {
            const mode = options.mode || 'category'; // 'category' or 'perMetric'
            const minutesWeighted = !!options.minutesWeighted;
            const debug = !!options.debug;
            const competitionLevel = options.competitionLevel || CURRENT_COMPETITION;
            
            // Get adjusted MAX_EXPECTED for this competition level
            const adjustedMaxExpected = getAdjustedMaxExpected(competitionLevel);
            
            const analysis = {
                totalPlayers: playersData.length,
                positions: { GK: 0, D: 0, DM: 0, M: 0, AM: 0, W: 0, ST: 0 },
                avgAge: 0,
                avgRating: 0,
                strengths: {},
                topPlayers: {
                    attackers: [],
                    midfielders: [],
                    defenders: [],
                    goalkeepers: []
                },
                mode: mode,
                minutesWeighted: minutesWeighted,
                competitionLevel: competitionLevel,
                competitionInfo: COMPETITION_PRESETS[competitionLevel]
            };
            
            let totalAge = 0;
            let totalRating = 0;
            let ratingCount = 0;
            
            const sumRaw = { attacking: 0, creativity: 0, possession: 0, pressing: 0, defensive: 0, physical: 0 };
            const sumNormPerMetric = {}; // for perMetric mode
            const perMetricContrib = [];
            let totalWeight = 0;
            
            playersData.forEach(player => {
                // Position counting
                const pos = findAttribute(player, ['Position', 'Pos', 'position']);
                if (pos) {
                    const posUpper = pos.toString().toUpperCase();
                    if (posUpper.includes('GK')) analysis.positions.GK++;
                    if (posUpper.includes('ST')) analysis.positions.ST++;
                    if (posUpper.includes('W') && !posUpper.includes('WB')) analysis.positions.W++;
                    if (posUpper.includes('AM')) analysis.positions.AM++;
                    if (posUpper.includes('DM')) analysis.positions.DM++;
                    if (posUpper.includes('M') && !posUpper.includes('AM') && !posUpper.includes('DM')) analysis.positions.M++;
                    if (posUpper.includes('D') && !posUpper.includes('DM') && !posUpper.includes('M')) analysis.positions.D++;
                }
                
                // Age and Rating
                const age = parseFloat(findAttribute(player, ['Age', 'age']));
                if (!isNaN(age)) totalAge += age;
                
                const rating = parseFloat(findAttribute(player, ['Rating', 'Avg Rat', 'AvgRat', 'rating']));
                if (!isNaN(rating)) {
                    totalRating += rating;
                    ratingCount++;
                }
                
                // Minutes for weighting (if available)
                const minutes = parseFloat(findAttribute(player, ['Minutes', 'Mins', 'mins', 'minutes'])) || 90;
                const weight = minutesWeighted ? (minutes / 90) : 1;
                totalWeight += weight;
                
                // Compute player contribution using modular function
                const playerContrib = computePlayerRawContrib(player);
                
                if (debug) {
                    perMetricContrib.push(playerContrib.debug);
                }
                
                // Accumulate raw category sums (weighted)
                Object.keys(sumRaw).forEach(k => {
                    sumRaw[k] += (playerContrib.raw[k] || 0) * weight;
                });
                
                // Accumulate per-metric normalized sums if using perMetric mode
                if (mode === 'perMetric') {
                    Object.keys(playerContrib.perMetricNorm).forEach(metric => {
                        sumNormPerMetric[metric] = (sumNormPerMetric[metric] || 0) + (playerContrib.perMetricNorm[metric] * weight);
                    });
                }
                
                // Categorize top players
                const playerInfo = {
                    name: findAttribute(player, ['Player', 'player', 'Name', 'name']) || 'Unknown',
                    position: pos,
                    rating: rating,
                    xG: parseFloat(findAttribute(player, ['xG/90', 'xG'])) || 0,
                    xA: parseFloat(findAttribute(player, ['xA/90', 'xA'])) || 0
                };
                
                if (pos) {
                    const posUpper = pos.toString().toUpperCase();
                    if (posUpper.includes('ST') || posUpper.includes('W') || posUpper.includes('AM')) {
                        analysis.topPlayers.attackers.push(playerInfo);
                    } else if (posUpper.includes('M')) {
                        analysis.topPlayers.midfielders.push(playerInfo);
                    } else if (posUpper.includes('D') && !posUpper.includes('DM')) {
                        analysis.topPlayers.defenders.push(playerInfo);
                    } else if (posUpper.includes('GK')) {
                        analysis.topPlayers.goalkeepers.push(playerInfo);
                    }
                }
            });
            
            // Calculate averages
            analysis.avgAge = totalAge / playersData.length;
            analysis.avgRating = ratingCount > 0 ? totalRating / ratingCount : 0;
            
            // Normalization depends on mode
            const n = Math.max(1, minutesWeighted ? totalWeight : playersData.length);
            const rawAverages = {};
            
            Object.keys(sumRaw).forEach(k => {
                rawAverages[k] = sumRaw[k] / n;
            });
            
            if (mode === 'category') {
                // MODE 1: Category normalization (raw category avg -> normalize by MAX_EXPECTED)
                Object.keys(rawAverages).forEach(k => {
                    const maxExpected = adjustedMaxExpected[k] || 10.0;
                    if (maxExpected <= 0) {
                        analysis.strengths[k] = clamp(rawAverages[k]);
                    } else {
                        const normalized = (rawAverages[k] / maxExpected) * 10.0;
                        analysis.strengths[k] = clamp(normalized, 0, 10);
                    }
                });
            } else if (mode === 'perMetric') {
                // MODE 2: Per-metric normalization (normalize each metric 0..10, then weighted average)
                const avgMetricNorm = {};
                Object.keys(sumNormPerMetric).forEach(metric => {
                    avgMetricNorm[metric] = sumNormPerMetric[metric] / n;
                });
                
                // Helper: weighted average from metric normalized values
                function weightedAverageFromMetricNorm(weights) {
                    let total = 0, wsum = 0;
                    Object.keys(weights).forEach(m => {
                        const w = weights[m];
                        total += (avgMetricNorm[m] || 0) * w;
                        wsum += w;
                    });
                    return wsum > 0 ? (total / wsum) : 0;
                }
                
                analysis.strengths.attacking = clamp(weightedAverageFromMetricNorm(ATTACKING_WEIGHTS), 0, 10);
                analysis.strengths.creativity = clamp(weightedAverageFromMetricNorm(CREATIVITY_WEIGHTS), 0, 10);
                analysis.strengths.possession = clamp(weightedAverageFromMetricNorm(POSSESSION_WEIGHTS), 0, 10);
                analysis.strengths.pressing = clamp(weightedAverageFromMetricNorm(PRESSING_WEIGHTS), 0, 10);
                analysis.strengths.defensive = clamp(weightedAverageFromMetricNorm(DEFENSIVE_WEIGHTS), 0, 10);
                analysis.strengths.physical = clamp(weightedAverageFromMetricNorm(PHYSICAL_WEIGHTS), 0, 10);
            }
            
            // Store raw averages for debugging
            analysis.rawAverages = rawAverages;
            
            // Enhanced Debug logging (uncomment to see detailed breakdown)
            if (debug) {
                console.log('=== SQUAD STRENGTH ANALYSIS ===');
                console.log(`Mode: ${mode}, Minutes Weighted: ${minutesWeighted}`);
                console.log(`Competition: ${COMPETITION_PRESETS[competitionLevel].name} (Factor: ${COMPETITION_PRESETS[competitionLevel].factor})`);
                console.log(`Total Players: ${playersData.length}, Effective Weight: ${n.toFixed(2)}`);
                console.log('\nAdjusted MAX_EXPECTED:');
                Object.keys(adjustedMaxExpected).forEach(k => {
                    console.log(`  ${k}: ${adjustedMaxExpected[k].toFixed(2)}`);
                });
                console.log('\nCategory Scores:');
                Object.keys(analysis.strengths).forEach(key => {
                    const maxExp = adjustedMaxExpected[key];
                    const pct = mode === 'category' ? ((rawAverages[key] / maxExp) * 100).toFixed(1) : 'N/A';
                    console.log(`${key.toUpperCase()}:`);
                    console.log(`  Raw Avg: ${rawAverages[key].toFixed(2)}${mode === 'category' ? ` / ${maxExp.toFixed(2)} (${pct}%)` : ''}`);
                    console.log(`  Normalized: ${analysis.strengths[key].toFixed(2)}/10 [${getTierLabel(analysis.strengths[key])}]`);
                });
                
                analysis.perMetricContrib = perMetricContrib;
                analysis.adjustedMaxExpected = adjustedMaxExpected;
            }
            
            // Sort top players by rating
            analysis.topPlayers.attackers.sort((a, b) => b.rating - a.rating);
            analysis.topPlayers.midfielders.sort((a, b) => b.rating - a.rating);
            analysis.topPlayers.defenders.sort((a, b) => b.rating - a.rating);
            analysis.topPlayers.goalkeepers.sort((a, b) => b.rating - a.rating);
            
            return analysis;
        }
        
        function displayTacticalRecommendations(analysis) {
            const content = document.getElementById('tacticalRecommendationContent');
            
            // Determine primary tactical style based on strengths
            const strengths = analysis.strengths;
            const sortedStrengths = Object.entries(strengths).sort((a, b) => b[1] - a[1]);
            
            // Competition info badge
            const compInfo = analysis.competitionInfo || COMPETITION_PRESETS[analysis.competitionLevel || 'top5'];
            const compBadge = `
                <div style="display: inline-block; padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            color: white; border-radius: 20px; font-size: 0.85em; font-weight: 600; margin-bottom: 15px;">
                    üèÜ ${compInfo.name} (Factor: ${compInfo.factor})
                </div>
            `;
            
            let html = `
                ${compBadge}
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">&#128202; Analisis Squad</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                            <div style="font-size: 0.9em; color: #7f8c8d;">Total Pemain</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: #2c3e50;">${analysis.totalPlayers}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                            <div style="font-size: 0.9em; color: #7f8c8d;">Rata-rata Rating</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: #2c3e50;">${analysis.avgRating.toFixed(2)}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22;">
                            <div style="font-size: 0.9em; color: #7f8c8d;">Rata-rata Umur</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: #2c3e50;">${analysis.avgAge.toFixed(1)} tahun</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 10px;">Komposisi Posisi</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">GK</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.GK}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">DEF</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.D}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">DM</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.DM}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">MID</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.M}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">AM</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.AM}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">WING</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.W}</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 600; color: #2c3e50;">ST</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #3498db;">${analysis.positions.ST}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">&#128170; Kekuatan Tim</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
            `;
            
            // Display strength bars
            const strengthLabels = {
                attacking: '&#9876; Attacking',
                creativity: '&#127912; Creativity',
                possession: '&#128257; Possession',
                pressing: '&#128293; Pressing',
                defensive: '&#128737; Defensive',
                physical: '&#128170; Physical'
            };
            
            sortedStrengths.forEach(([key, value]) => {
                const percentage = Math.min(100, (value / 5) * 100); // Scale to 100%
                let color = '#95a5a6';
                if (percentage >= 70) color = '#27ae60';
                else if (percentage >= 50) color = '#3498db';
                else if (percentage >= 30) color = '#f39c12';
                else color = '#e74c3c';
                
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50;">${strengthLabels[key]}</span>
                            <span style="color: #7f8c8d; font-weight: 600;">${value.toFixed(2)}</span>
                        </div>
                        <div style="background: #ecf0f1; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            html += `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Rekomendasi Taktik</h3>
            `;
            
            // Generate tactical recommendations based on analysis
            const recommendations = generateTacticalRecommendations(analysis, sortedStrengths);
            
            recommendations.forEach((rec, index) => {
                const priority = index === 0 ? 'PRIMARY' : index === 1 ? 'SECONDARY' : 'ALTERNATIVE';
                const priorityColor = index === 0 ? '#27ae60' : index === 1 ? '#3498db' : '#f39c12';
                
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid ${priorityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #2c3e50; margin: 0;">${rec.title}</h4>
                            <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                ${priority}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 8px;">&#9881; Formasi yang Disarankan:</div>
                            <div style="color: #2c3e50; font-size: 1.1em; font-weight: 600;">${rec.formations.join(' / ')}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 8px;">&#9917; Gaya Bermain:</div>
                            <div style="color: #2c3e50;">${rec.style}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 8px;">&#128221; Instruksi Taktik:</div>
                            <ul style="margin: 5px 0; padding-left: 20px; color: #2c3e50;">
                                ${rec.instructions.map(inst => `<li>${inst}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 8px;">&#9989; Kelebihan:</div>
                            <ul style="margin: 5px 0; padding-left: 20px; color: #27ae60;">
                                ${rec.strengths.map(str => `<li>${str}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 8px;">&#9888; Perhatian:</div>
                            <ul style="margin: 5px 0; padding-left: 20px; color: #e67e22;">
                                ${rec.warnings.map(warn => `<li>${warn}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 6px;">
                    <div style="font-weight: 600; color: #1565c0; margin-bottom: 12px;">&#128220; Penjelasan Perhitungan Kekuatan Tim:</div>
                    <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="color: #1976d2; font-size: 0.9em; line-height: 1.6;">
                            <div style="margin-bottom: 8px;">
                                <strong>&#9876; Attacking:</strong> (xG/90 &times; 4) + (xA/90 &times; 2) + (SoT% &times; 8) + (Goal/xG &times; 2)<br>
                                <span style="color: #666; font-size: 0.9em;">
                                    Mengukur <em>attack potential</em> (xG, xA, SoT%) + <em>finishing efficiency</em> (Goal/xG ratio)<br>
                                    <strong>Goal/xG:</strong> &lt;1.0 = finishing buruk | 1.0 = sesuai ekspektasi | &gt;1.0 = klinikal
                                </span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =7.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.attacking >= 7.0 ? '#27ae60' : analysis.strengths.attacking >= 5.0 ? '#3498db' : analysis.strengths.attacking >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.attacking.toFixed(2)}
                                </span>
                                <div style="margin-top: 6px; padding: 6px; background: #f0f8ff; border-left: 3px solid #2196f3; border-radius: 3px; font-size: 0.85em;">
                                    &#128161; <strong>Interpretasi:</strong> Score dinormalisasi ke skala 0-10. Bobot realistis mencegah inflasi skor.
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <strong>&#127912; Creativity:</strong> (KeyP/90 &times; 1.8) + (xA/90 &times; 3) + (ProgP/90 &times; 0.2) + (Drb/90 &times; 0.3)<br>
                                <span style="color: #666; font-size: 0.9em;">
                                    Menciptakan peluang melalui <em>passing</em> (KeyP, xA, ProgP) + <em>ball-carrying</em> (Dribbles)<br>
                                    <strong>Bedakan:</strong> Playmaker statis vs creator yang membawa bola
                                </span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =7.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.creativity >= 7.0 ? '#27ae60' : analysis.strengths.creativity >= 5.0 ? '#3498db' : analysis.strengths.creativity >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.creativity.toFixed(2)}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <strong>&#128257; Possession:</strong> (PassAcc &divide; 12) + (ProgP/90 &times; 0.6) + (Tch/90 &divide; 20) + (PossWon/90 &times; 0.4)<br>
                                <span style="color: #666; font-size: 0.9em;">
                                    Kontrol bola + build-up + <em>counter-press</em> (Poss Won = kemampuan rewin ball)<br>
                                    <strong>Man City/Brighton-style:</strong> Mempertahankan penguasaan setelah kehilangan
                                </span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =7.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.possession >= 7.0 ? '#27ae60' : analysis.strengths.possession >= 5.0 ? '#3498db' : analysis.strengths.possession >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.possession.toFixed(2)}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <strong>&#128293; Pressing:</strong> (Press Attempts/90 &times; 0.25) + (Press Success % &divide; 10) + (Distance/90 &divide; 200)<br>
                                <span style="color: #666; font-size: 0.9em;">Volume, efektivitas pressing, dan integrasi kerja fisik</span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =9.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.pressing >= 7.0 ? '#27ae60' : analysis.strengths.pressing >= 5.0 ? '#3498db' : analysis.strengths.pressing >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.pressing.toFixed(2)}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <strong>&#128737; Defensive:</strong> (Tck/90 &times; 1.2) + (Int/90 &times; 1.1) + (Blk/90 &times; 0.8) + (Clr/90 &times; 0.5) + (AerWin% &divide; 20)<br>
                                <span style="color: #666; font-size: 0.9em;">
                                    Efisiensi bertahan untuk <em>semua gaya blok</em><br>
                                    <strong>High block:</strong> Tackles+Int tinggi | <strong>Low block:</strong> Blocks+Clearances tinggi
                                </span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =9.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.defensive >= 7.0 ? '#27ae60' : analysis.strengths.defensive >= 5.0 ? '#3498db' : analysis.strengths.defensive >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.defensive.toFixed(2)}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 0;">
                                <strong>&#128170; Physical:</strong> (Dist/90 &divide; 90) + (Sprints/90 &times; 0.5) + (Duels/90 &times; 0.2) + (Tck/90 &times; 0.2)<br>
                                <span style="color: #666; font-size: 0.9em;">
                                    Work rate + <em>physical contact strength</em> + aggressiveness<br>
                                    <strong>Bukan cuma jarak:</strong> Kombinasi stamina, duel, dan tackles
                                </span><br>
                                <span style="color: #27ae60; font-weight: 600;">Elite: =8.0</span> | 
                                <span style="color: #3498db; font-weight: 600;">Good: 5.0-7.0</span> | 
                                <span style="color: #f39c12; font-weight: 600;">Average: 3.0-5.0</span> | 
                                <span style="color: #e74c3c; font-weight: 600;">Weak: &lt;3.0</span><br>
                                <span style="background: ${analysis.strengths.physical >= 7.0 ? '#27ae60' : analysis.strengths.physical >= 5.0 ? '#3498db' : analysis.strengths.physical >= 3.0 ? '#f39c12' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 4px; font-weight: 700; margin-top: 4px; display: inline-block;">
                                    Score Anda: ${analysis.strengths.physical.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: #1565c0; font-size: 0.85em; font-style: italic; margin-bottom: 8px;">
                        * Nilai dihitung per pemain, dirata-rata, lalu dinormalisasi ke skala 0-10<br>
                        * Semua perhitungan menggunakan safe division dan NaN handling
                    </p>

                    <div style="margin-bottom: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <label for="normalizationModeSelect" style="font-size: 0.9em; color: #333;">Metode Normalisasi:</label>
                        <select id="normalizationModeSelect" onchange="updateNormalizationMode(this.value)" style="padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc;">
                            <option value="category" selected>Category (default)</option>
                            <option value="perMetric">Per-metric (equalize per-metric ranges)</option>
                        </select>
                        <span style="font-size: 0.85em; color: #666;">Pilih metode normalisasi untuk analisis (default: category)</span>
                        <button id="tryBothBtn" onclick="tryBothNormalizationModes()" style="margin-left:12px; padding:6px 14px; background:#2196f3; color:white; border:none; border-radius:4px; font-size:0.9em; cursor:pointer;">Try Both Modes</button>
                    </div>
                    
                    <!-- Container for comparison table -->
                    <div id="normCompareTableContainer" style="margin-bottom: 12px;"></div>
                    
                    <div style="margin-top: 12px; padding: 10px; background: #fff9e6; border: 1px solid #ffd966; border-radius: 4px;">
                        <div style="color: #856404; font-size: 0.85em; line-height: 1.5;">
                            <strong>Disclaimer:</strong> Formula dan range perhitungan ini bersifat <strong>experimental</strong> dan belum tervalidasi secara ilmiah dengan data profesional. Gunakan sebagai referensi awal, bukan keputusan final.
                            <br><br>
                            <b>üìä Pilih Metode Normalisasi:</b>
                            <ul style="margin:6px 0 0 18px; padding:0;">
                                <li><strong>Category (default):</strong> Cocok untuk <strong>membandingkan kekuatan tim dengan standar liga</strong>. Gunakan jika ingin tahu: "Apakah tim saya memenuhi standar kompetisi?"</li>
                                <li><strong>Per-metric:</strong> Cocok untuk <strong>menggambarkan kekuatan tim secara internal</strong>. Gunakan jika ingin tahu: "Area mana yang paling kuat/lemah dalam squad saya?"</li>
                            </ul>
                            <p style="margin:8px 0 0 0; font-size:0.9em; font-style:italic;">üí° Klik <strong>"Try Both Modes"</strong> untuk melihat perbandingan kedua metode.</p>
                            <br>
                            <b>üéØ Cara Penentuan Rekomendasi Taktik:</b>
                            <p style="margin:4px 0;">Sistem menentukan rekomendasi berdasarkan kekuatan tertinggi tim:</p>
                            <ul style="margin:6px 0 0 18px; padding:0; font-size:0.95em;">
                                <li><strong>Attacking</strong> tertinggi ‚Üí Gegenpressing & Vertical Tiki-Taka</li>
                                <li><strong>Possession/Creativity</strong> tertinggi ‚Üí Tiki-Taka Possession Based</li>
                                <li><strong>Pressing</strong> tertinggi (atau secondary jika ‚â•6.5) ‚Üí High Press Gegenpressing</li>
                                <li><strong>Defensive</strong> tertinggi ‚Üí Solid Defence Counter-Attack</li>
                                <li><strong>Physical</strong> tertinggi ‚Üí Direct & Physical Football</li>
                                <li><strong>Tidak ada yang dominan</strong> (selisih tertinggi & terendah &lt;1.0) ‚Üí Balanced Flexible</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 6px;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">‚ö†Ô∏è Catatan Penting:</div>
                    <ul style="margin: 5px 0; padding-left: 20px; color: #856404; font-size: 0.95em;">
                        <li>Rekomendasi berdasarkan kekuatan statistik tim</li>
                        <li>Sesuaikan dengan kondisi lawan dan situasi pertandingan</li>
                        <li>Pertimbangkan chemistry dan understanding antar pemain</li>
                        <li>Lakukan training sesuai dengan taktik yang dipilih</li>
                    </ul>
                </div>
            `;
            
            content.innerHTML = html;
            // Ensure the normalization select reflects current mode
            const normSel = document.getElementById('normalizationModeSelect');
            if (normSel) normSel.value = CURRENT_NORMALIZATION_MODE;
        }
        
        function generateTacticalRecommendations(analysis, sortedStrengths) {
            const recommendations = [];
            const primaryStrength = sortedStrengths[0][0];
            const secondaryStrength = sortedStrengths[1][0];
            
            // High attacking strength
            if (primaryStrength === 'attacking') {
                recommendations.push({
                    title: '&#9876;&#128293; Gegenpressing & Vertical Tiki-Taka',
                    formations: ['4-3-3', '4-2-3-1', '4-1-4-1'],
                    style: 'Attacking football dengan transisi cepat, pressing tinggi, dan build-up bermain pendek. Fokus pada serangan vertikal dan ekspolitasi ruang di belakang lini pertahanan lawan.',
                    instructions: [
                        'Tempo: Sangat Tinggi',
                        'Width: Fairly Wide',
                        'Passing: Shorter atau Mixed',
                        'Pressing: Much Higher',
                        'Defensive Line: Higher',
                        'Counter-Press: Yes',
                        'Play Out of Defence: Yes'
                    ],
                    strengths: [
                        'Maksimalkan potensi menyerang pemain',
                        'Pressing tinggi untuk rebut bola cepat',
                        'Transisi menyerang yang mematikan',
                        'Kontrol permainan dengan possession'
                    ],
                    warnings: [
                        'Rentan terhadap counter-attack cepat',
                        'Butuh stamina tinggi dari semua pemain',
                        'Risiko tinggi jika kehilangan bola'
                    ]
                });
            }
            
            // High possession/creativity
            if (primaryStrength === 'possession' || primaryStrength === 'creativity') {
                recommendations.push({
                    title: '&#127912;&#128257; Tiki-Taka Possession Based',
                    formations: ['4-3-3 DM Wide', '4-1-4-1 DM Wide', '3-4-3'],
                    style: 'Kontrol permainan dengan possession tinggi, passing pendek, dan pergerakan konstan. Membangun serangan dengan sabar dan mencari celah melalui kombinasi passing.',
                    instructions: [
                        'Tempo: Tinggi',
                        'Width: Fairly Wide',
                        'Passing: Much Shorter',
                        'Pressing: Higher',
                        'Defensive Line: Higher',
                        'Play Out of Defence: Yes',
                        'Work Ball Into Box: Yes',
                        'Dribble Less: Yes'
                    ],
                    strengths: [
                        'Dominasi possession dan territory',
                        'Melelahkan lawan dengan pergerakan bola',
                        'Minimize risiko kehilangan bola berbahaya',
                        'Kreativitas tinggi menciptakan peluang'
                    ],
                    warnings: [
                        'Bisa frustasi menghadapi low block',
                        'Butuh technical ability tinggi',
                        'Efektivitas tergantung kondisi lapangan'
                    ]
                });
            }
            
            // High pressing
            if (primaryStrength === 'pressing' || secondaryStrength === 'pressing') {
                recommendations.push({
                    title: '&#128293;&#9889; High Press Gegenpressing',
                    formations: ['4-4-2', '4-2-3-1', '4-3-3'],
                    style: 'Pressing agresif untuk memaksa error lawan dan memenangkan bola di area berbahaya. Transisi cepat dari defence ke attack.',
                    instructions: [
                        'Tempo: Much Higher',
                        'Passing: Mixed atau Direct',
                        'Pressing: Much Higher',
                        'Defensive Line: Much Higher',
                        'Counter-Press: Yes',
                        'Counter: Yes',
                        'Get Stuck In: Yes',
                        'Prevent Short GK Distribution: Yes'
                    ],
                    strengths: [
                        'Maksimalkan kemampuan pressing tim',
                        'Ciptakan peluang dari kesalahan lawan',
                        'Momentum permainan tinggi',
                        'Transisi cepat menyerang'
                    ],
                    warnings: [
                        'Sangat demanding secara fisik',
                        'Rentan jika lawan bisa bypass press',
                        'Butuh organization yang sangat baik'
                    ]
                });
            }
            
            // High defensive strength
            if (primaryStrength === 'defensive') {
                recommendations.push({
                    title: '&#128737;&#128170; Solid Defence Counter-Attack',
                    formations: ['4-5-1', '5-4-1', '4-4-1-1'],
                    style: 'Pertahanan solid dan kompak, fokus pada defensive stability dan eksploitasi ruang lewat counter-attack cepat.',
                    instructions: [
                        'Tempo: Lower',
                        'Width: Fairly Narrow',
                        'Passing: Mixed atau Direct',
                        'Pressing: Lower',
                        'Defensive Line: Lower atau Standard',
                        'Counter: Yes',
                        'Tackle Harder: Yes',
                        'Distribute to Full-Backs: Yes'
                    ],
                    strengths: [
                        'Maksimalkan kekuatan defensive',
                        'Minimize space untuk lawan',
                        'Efektif melawan tim attacking',
                        'Counter-attack berbahaya'
                    ],
                    warnings: [
                        'Possession mungkin rendah',
                        'Butuh striker dengan Hold-Up play bagus',
                        'Bisa kesulitan melawan deep defence'
                    ]
                });
            }
            
            // High physical strength
            if (primaryStrength === 'physical') {
                recommendations.push({
                    title: '&#128170;&#9889; Direct & Physical Football',
                    formations: ['4-4-2', '3-5-2', '4-2-3-1'],
                    style: 'Permainan langsung dengan memanfaatkan kekuatan fisik. Bola panjang ke striker, second balls, dan dominasi aerial duels.',
                    instructions: [
                        'Tempo: Higher',
                        'Width: Wide',
                        'Passing: More Direct',
                        'Pressing: Standard atau Higher',
                        'Defensive Line: Standard',
                        'Hit Early Crosses: Yes',
                        'Get Stuck In: Yes',
                        'Distribute to Playmaker: No'
                    ],
                    strengths: [
                        'Maksimalkan advantage fisik',
                        'Efektif dalam aerial duels',
                        'Permainan langsung bypass midfield',
                        'Power running dan athleticism'
                    ],
                    warnings: [
                        'Technical play mungkin kurang',
                        'Predictable jika lawan adapt',
                        'Butuh striker dengan heading ability'
                    ]
                });
            }
            
            // Balanced approach if no clear dominance
            if (sortedStrengths[0][1] - sortedStrengths[2][1] < 1.0) {
                recommendations.push({
                    title: '&#9881;&#128079; Balanced Flexible Approach',
                    formations: ['4-2-3-1', '4-3-3', '4-1-2-3'],
                    style: 'Pendekatan seimbang yang bisa beradaptasi dengan situasi. Solid di defence, kreatif di midfield, dan threat di attack.',
                    instructions: [
                        'Tempo: Standard atau Higher',
                        'Width: Standard',
                        'Passing: Mixed',
                        'Pressing: Standard',
                        'Defensive Line: Standard',
                        'Counter: Yes',
                        'Play Out of Defence: Yes',
                        'Be More Disciplined: Yes'
                    ],
                    strengths: [
                        'Fleksibilitas taktik tinggi',
                        'Balanced di semua area',
                        'Adaptif terhadap lawan',
                        'Minimize kelemahan'
                    ],
                    warnings: [
                        'Tidak memaksimalkan strength spesifik',
                        'Butuh pemain versatile',
                        'Bisa kurang identity jelas'
                    ]
                });
            }
            
            // Ensure at least 2 recommendations
            if (recommendations.length < 2) {
                recommendations.push({
                    title: '&#128221;&#9881; Standard Structured Approach',
                    formations: ['4-2-3-1', '4-3-3'],
                    style: 'Pendekatan terstruktur dengan balance antara defence dan attack. Solid foundation dengan fleksibilitas dalam execution.',
                    instructions: [
                        'Tempo: Standard',
                        'Width: Standard',
                        'Passing: Mixed',
                        'Pressing: Standard',
                        'Defensive Line: Standard',
                        'Counter: Yes'
                    ],
                    strengths: [
                        'Structure yang jelas',
                        'Balance yang baik',
                        'Mudah dipahami pemain'
                    ],
                    warnings: [
                        'Mungkin kurang exploit kekuatan spesifik',
                        'Perlu tactical tweaking sesuai lawan'
                    ]
                });
            }
            
            // Limit to max 3 recommendations
            return recommendations.slice(0, 3);
        }

        function resetData() {
            // Clear data
            playersData = [];
            currentPlayer = null;
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Hide file info, data preview, and main content
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('dataPreview').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('teamTacticalRecommendation').classList.add('hidden');
            
            // Clear player select
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">-- Pilih Pemain --</option>';
            
            console.log('Data reset successfully');
        }

        function findAttribute(player, keys) {
            for (let key of keys) {
                const exactMatch = player[key];
                if (exactMatch !== undefined && exactMatch !== null && exactMatch !== '') {
                    return exactMatch;
                }
            }
            // Case insensitive search
            const playerKeys = Object.keys(player);
            for (let key of keys) {
                const found = playerKeys.find(pk => pk.toLowerCase() === key.toLowerCase());
                if (found && player[found] !== undefined && player[found] !== null && player[found] !== '') {
                    return player[found];
                }
            }
            return null;
        }

        function populatePlayerList() {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">-- Pilih Pemain --</option>';
            
            playersData.forEach((player, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                const name = findAttribute(player, ['Player', 'Name', 'Nama']) || 'Unknown';
                const position = findAttribute(player, ['Position', 'Pos', 'Posisi']) || '';
                const age = findAttribute(player, ['Age', 'Umur']) || '';
                
                option.textContent = `${name} ${position ? '(' + position + ')' : ''} ${age ? '- ' + age + ' tahun' : ''}`;
                select.appendChild(option);
            });
            
            // Generate data preview table
            generateDataPreview();
        }
        
        function generateDataPreview() {
            if (!playersData || playersData.length === 0) {
                document.getElementById('dataPreview').classList.add('hidden');
                return;
            }
            
            // Show preview section
            document.getElementById('dataPreview').classList.remove('hidden');
            
            // Get all unique keys from all players
            const allKeys = new Set();
            playersData.forEach(player => {
                Object.keys(player).forEach(key => allKeys.add(key));
            });
            
            // Prioritize important columns
            const priorityKeys = ['Player', 'Position', 'Age', 'Avg Rat', 'Best Pos', 'Best Role', 
                                  'Goals', 'Assists', 'Appearances', 'xG/90', 'xA/90'];
            const otherKeys = Array.from(allKeys).filter(key => !priorityKeys.includes(key));
            const orderedKeys = [...priorityKeys.filter(key => allKeys.has(key)), ...otherKeys];
            
            // Generate table header
            const headerRow = document.getElementById('previewTableHeader');
            headerRow.innerHTML = '';
            orderedKeys.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                th.style.cssText = 'padding: 12px 15px; text-align: left; white-space: nowrap; border-right: 1px solid rgba(255,255,255,0.2); font-weight: 600;';
                headerRow.appendChild(th);
            });
            
            // Generate table body
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            playersData.forEach((player, index) => {
                const tr = document.createElement('tr');
                tr.style.cssText = `background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; cursor: pointer; transition: background 0.2s;`;
                tr.onmouseover = () => tr.style.background = '#e3f2fd';
                tr.onmouseout = () => tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';
                tr.onclick = () => {
                    document.getElementById('playerSelect').value = index;
                    analyzePlayer();
                };
                
                orderedKeys.forEach(key => {
                    const td = document.createElement('td');
                    const value = player[key];
                    td.textContent = value !== undefined && value !== null ? value : '-';
                    td.style.cssText = 'padding: 10px 15px; border-bottom: 1px solid #e1e8ed; border-right: 1px solid #e1e8ed; white-space: nowrap;';
                    
                    // Highlight important cells
                    if (key === 'Player') {
                        td.style.fontWeight = '600';
                        td.style.color = '#2c3e50';
                    }
                    if (key === 'Position') {
                        td.style.color = '#667eea';
                        td.style.fontWeight = '500';
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
        }

        function analyzePlayer() {
            const selectedIndex = document.getElementById('playerSelect').value;
            if (selectedIndex === '') {
                document.getElementById('analysisResult').classList.add('hidden');
                return;
            }

            currentPlayer = playersData[selectedIndex];
            displayAnalysis(currentPlayer);
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisResult').scrollIntoView({ behavior: 'smooth' });
        }

        function displayAnalysis(p) {
            // Player Header
            const name = findAttribute(p, ['Player', 'Name']) || 'Unknown Player';
            const position = findAttribute(p, ['Position', 'Pos']) || 'N/A';
            const age = findAttribute(p, ['Age']) || 'N/A';
            const bestPos = findAttribute(p, ['Best Pos']) || '';
            const bestRole = findAttribute(p, ['Best Role']) || '';
            const pros = findAttribute(p, ['Pros']) || '';
            const foot = findAttribute(p, ['Preferred Foot']) || '';
            
            document.getElementById('playerHeader').innerHTML = `
                <div class="player-name">${name}</div>
                <div class="player-info">
                    <span class="position-badge">${position}</span>
                    ${bestPos ? '<span class="position-badge">Best: ' + bestPos + '</span>' : ''}
                    <br>
                    ${age} tahun ${foot ? 'ÔøΩ ' + foot : ''}
                    ${bestRole ? '<br>Role: ' + bestRole : ''}
                    ${pros ? '<br>Kelebihan: ' + pros : ''}
                </div>
            `;

            // Display grouped stats
            displayGroupedStats(p);
            
            // Analyze each section
            analyzeAllSections(p);
            
            // Generate Insights
            const insights = generateInsights(p);
            displayInsights(insights);
            
            // Effectiveness Rating
            const rating = calculateEffectiveness(p);
            const ratingBreakdown = calculateEffectivenessWithBreakdown(p);
            displayEffectivenessRating(rating, ratingBreakdown);
            
            // Recommendations
            displayRecommendations(p, insights, rating);
        }

        function displayKeyStats(p) {
            const stats = [
                // Basic Stats
                { label: 'Avg Rating', value: findAttribute(p, ['Avg Rat', 'AvRat', 'Average Rating']), format: 'rating' },
                { label: 'Appearances', value: findAttribute(p, ['Appearances', 'Apps', 'Aps']), format: 'number' },
                { label: 'Goals', value: findAttribute(p, ['Goals', 'Gls']), format: 'number' },
                { label: 'Assists', value: findAttribute(p, ['Assists', 'Asts', 'Ast']), format: 'number' },
                { label: 'Man of Match', value: findAttribute(p, ['MoM', 'MotM', 'Man of Match']), format: 'number' },
                
                // Passing & Creativity
                { label: 'Pr Passes/90', value: findAttribute(p, ['Pr passes/90', 'Progressive Passes']), format: 'decimal' },
                { label: 'Ps Attempted/90', value: findAttribute(p, ['Ps A/90', 'Passes Attempted']), format: 'decimal' },
                { label: 'Ps Completed/90', value: findAttribute(p, ['Ps C/90', 'Passes Completed']), format: 'decimal' },
                { label: 'Key Passes/90', value: findAttribute(p, ['OP-KP/90', 'Key Passes', 'KeyP/90']), format: 'decimal' },
                { label: 'Assists/90', value: findAttribute(p, ['Asts/90', 'Assists per 90']), format: 'decimal' },
                { label: 'Ch Created/90', value: findAttribute(p, ['Ch C/90', 'Chances Created']), format: 'decimal' },
                
                // Possession & Duel
                { label: 'Poss Won/90', value: findAttribute(p, ['Poss Won/90', 'Possession Won']), format: 'decimal' },
                { label: 'Poss Lost/90', value: findAttribute(p, ['Poss Lost/90', 'Possession Lost']), format: 'decimal' },
                { label: 'Pres Attempted/90', value: findAttribute(p, ['Pres A/90', 'Pressures Attempted']), format: 'decimal' },
                { label: 'Pres Completed/90', value: findAttribute(p, ['Pres C/90', 'Pressures Completed']), format: 'decimal' },
                
                // Crossing & Attacking
                { label: 'Crosses Att/90', value: findAttribute(p, ['OP-Crs A/90', 'Crosses Attempted']), format: 'decimal' },
                { label: 'Crosses Comp/90', value: findAttribute(p, ['OP-Crs C/90', 'Crosses Completed']), format: 'decimal' },
                { label: 'Dribbles/90', value: findAttribute(p, ['Drb/90', 'Dribbles']), format: 'decimal' },
                { label: 'Distance/90', value: findAttribute(p, ['Dist/90', 'Distance']), format: 'decimal' },
                { label: 'Sprints/90', value: findAttribute(p, ['Sprints/90', 'Sprint']), format: 'decimal' },
                
                // Shooting
                { label: 'Shots/90', value: findAttribute(p, ['Shot/90', 'Shots']), format: 'decimal' },
                { label: 'Shots on Target/90', value: findAttribute(p, ['Sht/90', 'SoT/90', 'Shots on Target']), format: 'decimal' },
                { label: 'xG per Shot', value: findAttribute(p, ['xG/shot', 'Expected Goals per shot']), format: 'decimal' },
                
                // Defensive
                { label: 'Headers Won/90', value: findAttribute(p, ['Hdrs W/90', 'Headers Won']), format: 'decimal' },
                { label: 'Blocks/90', value: findAttribute(p, ['Blk/90', 'Blocks']), format: 'decimal' },
                { label: 'Clearances/90', value: findAttribute(p, ['Clr/90', 'Clearances']), format: 'decimal' },
                { label: 'Interceptions/90', value: findAttribute(p, ['Int/90', 'Interceptions']), format: 'decimal' },
                { label: 'Tackles/90', value: findAttribute(p, ['Tck/90', 'Tackles']), format: 'decimal' },
                { label: 'Tackle Rate %', value: findAttribute(p, ['Tck R', 'Tackle Rate']), format: 'percent' }
            ];

            let html = '';
            stats.forEach(stat => {
                if (stat.value !== null && stat.value !== undefined && stat.value !== '') {
                    let displayValue = stat.value;
                    let cssClass = 'stat-value';
                    
                    if (stat.format === 'rating') {
                        const val = parseFloat(stat.value);
                        if (val >= 7.5) cssClass += ' rating-excellent';
                        else if (val >= 7.0) cssClass += ' rating-good';
                        else if (val >= 6.5) cssClass += ' rating-average';
                        else cssClass += ' rating-poor';
                        displayValue = val.toFixed(2);
                    } else if (stat.format === 'decimal') {
                        displayValue = parseFloat(stat.value).toFixed(1);
                    } else if (stat.format === 'percent') {
                        displayValue = parseFloat(stat.value).toFixed(0) + '%';
                    }
                    
                    html += `
                        <div class="stat-box">
                            <div class="stat-label">${stat.label}</div>
                            <div class="${cssClass}">${displayValue}</div>
                        </div>
                    `;
                }
            });
            
            document.getElementById(elementId).innerHTML = html || '<p style="padding: 15px; color: #999;">Data tidak tersedia</p>';
        }

        function analyzeAllSections(p) {
            const position = (findAttribute(p, ['Position', 'Pos']) || '').toUpperCase();
            
            // Analyze Passing & Creativity
            analyzePassingCreativity(p, position);
            
            // Analyze Possession & Duel
            analyzePossessionDuel(p, position);
            
            // Analyze Attacking
            analyzeAttacking(p, position);
            
            // Analyze Defensive
            analyzeDefensive(p, position);
            
            // Analyze Physical
            analyzePhysical(p, position);
            
            // Goalkeeper analysis: run if position is GK or GK metrics exist
            const isGK = position.includes('GK');
            const hasGKMetrics = (findAttribute(p, ['xGP/90']) || findAttribute(p, ['xSv %']) || findAttribute(p, ['xGP']) || findAttribute(p, ['Sv %'])) !== null && (findAttribute(p, ['xGP/90']) || findAttribute(p, ['xSv %']) || findAttribute(p, ['xGP']) || findAttribute(p, ['Sv %'])) !== '';
            if (isGK || hasGKMetrics) {
                analyzeGoalkeeper(p, position);
            }
        }

        function analyzePassingCreativity(p, pos) {
            const prPasses = parseFloat(findAttribute(p, ['Pr passes/90'])) || 0;
            const psC = parseFloat(findAttribute(p, ['Ps C/90'])) || 0;
            const psA = parseFloat(findAttribute(p, ['Ps A/90'])) || 0;
            const keyPasses = parseFloat(findAttribute(p, ['OP-KP/90'])) || 0;
            const chCreated = parseFloat(findAttribute(p, ['Ch C/90'])) || 0;
            
            // Position classification
            const isGK = pos.includes('GK');
            const isCB = pos.includes('CB') || (pos.includes('D') && pos.includes('C'));
            const isFB = pos.includes('B') || pos.includes('WB');
            const isDM = pos.includes('DM') || pos.includes('CDM');
            const isCM = pos.includes('CM') || (pos.includes('M') && !pos.includes('A') && !pos.includes('D'));
            const isAM = pos.includes('AM') || pos.includes('CAM');
            const isWinger = pos.includes('W') || pos.includes('AML') || pos.includes('AMR');
            const isStriker = pos.includes('ST') || pos.includes('CF');
            
            let analysis = '<strong>&#127912;&#128257; Analisis Passing & Kreativitas:</strong><br><br>';
            
            // Pass completion rate with position context
            if (psA > 0) {
                const passAccuracy = ((psC / psA) * 100).toFixed(1);
                analysis += `&#128202; <strong>Pass Accuracy:</strong> ${passAccuracy}% (${psC.toFixed(1)}/${psA.toFixed(1)})<br>`;
                
                // Position-specific benchmarks (Opta/Stats Perform data)
                let benchmarkMsg = '';
                if (isGK) {
                    if (parseFloat(passAccuracy) >= 75) {
                        benchmarkMsg = `<span style="color: #28a745;">EXCELLENT untuk GK</span> - Modern sweeper-keeper. Comfortable dalam build-up.`;
                    } else if (parseFloat(passAccuracy) >= 65) {
                        benchmarkMsg = `<span style="color: #17a2b8;">GOOD untuk GK</span> - Dapat dilibatkan dalam possession play.`;
                    } else {
                        benchmarkMsg = `Traditional GK - Fokus distribution ke area aman atau long ball.`;
                    }
                } else if (isCB || isDM) {
                    if (parseFloat(passAccuracy) >= 90) {
                        benchmarkMsg = `<span style="color: #28a745;">ELITE</span> - Ball-playing CB/DM material (90%+). Sangat reliable.`;
                    } else if (parseFloat(passAccuracy) >= 85) {
                        benchmarkMsg = `<span style="color: #28a745;">EXCELLENT</span> - Modern defender/DM (85-90%). Comfortable on ball.`;
                    } else if (parseFloat(passAccuracy) >= 80) {
                        benchmarkMsg = `<span style="color: #17a2b8;">GOOD</span> - Standar liga top untuk ${isCB ? 'CB' : 'DM'} (80-85%).`;
                    } else {
                        benchmarkMsg = `<span style="color: #ffc107;">BELOW PAR</span> - Perlu improve composure under pressure.`;
                    }
                } else if (isFB) {
                    if (parseFloat(passAccuracy) >= 80) {
                        benchmarkMsg = `<span style="color: #28a745;">EXCELLENT</span> - Inverted full-back material (80%+).`;
                    } else if (parseFloat(passAccuracy) >= 75) {
                        benchmarkMsg = `<span style="color: #17a2b8;">GOOD</span> - Solid untuk attacking full-back.`;
                    } else {
                        benchmarkMsg = `Traditional FB - Prioritas pada crossing/defending over passing.`;
                    }
                } else if (isCM || isAM) {
                    if (parseFloat(passAccuracy) >= 85) {
                        benchmarkMsg = `<span style="color: #28a745;">ELITE</span> - Dictator material. Rare untuk ${isAM ? 'AM' : 'CM'} (85%+).`;
                    } else if (parseFloat(passAccuracy) >= 80) {
                        benchmarkMsg = `<span style="color: #17a2b8;">EXCELLENT</span> - Standar playmaker liga top (80-85%).`;
                    } else if (parseFloat(passAccuracy) >= 75) {
                        benchmarkMsg = `<span style="color: #ffc107;">OK</span> - Acceptable jika high risk/reward player.`;
                    } else {
                        benchmarkMsg = `<span style="color: #dc3545;">CONCERN</span> - Terlalu banyak turnover untuk midfield controller.`;
                    }
                } else if (isWinger || isStriker) {
                    if (parseFloat(passAccuracy) >= 75) {
                        benchmarkMsg = `<span style="color: #28a745;">BONUS</span> - Attacker dengan passing skill bagus (75%+).`;
                    } else if (parseFloat(passAccuracy) >= 70) {
                        benchmarkMsg = `Standar untuk attacker - Fokus pada final third actions.`;
                    } else {
                        benchmarkMsg = `Direct player - Prioritas dribbling/shooting over passing.`;
                    }
                } else {
                    // Generic benchmark
                    if (parseFloat(passAccuracy) >= 85) {
                        benchmarkMsg = `<span style="color: #28a745;">ELITE</span> - Di atas rata-rata liga top (85%+).`;
                    } else if (parseFloat(passAccuracy) >= 80) {
                        benchmarkMsg = `<span style="color: #17a2b8;">BAGUS</span> - Sesuai standar liga top (80-85%).`;
                    } else if (parseFloat(passAccuracy) >= 75) {
                        benchmarkMsg = `<span style="color: #ffc107;">CUKUP</span> - Sedikit di bawah standar.`;
                    } else {
                        benchmarkMsg = `<span style="color: #dc3545;">PERLU IMPROVE</span> - Accuracy rendah.`;
                    }
                }
                
                analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; ${benchmarkMsg}<br><br>`;
            }
            
            // Progressive Passes - Position-specific benchmarks
            if (prPasses > 0) {
                analysis += `&#128640; <strong>Progressive Passes:</strong> ${prPasses.toFixed(1)}/90<br>`;
                
                if (isGK) {
                    if (prPasses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE Sweeper-Keeper</span> - Ederson/Alisson level (3+ prog passes).<br>`;
                    } else if (prPasses >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Modern GK - Aktif dalam memulai serangan dari belakang.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Traditional GK - Focus pada shot-stopping over distribution.<br>`;
                    }
                } else if (isCB) {
                    if (prPasses >= 6) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">WORLD-CLASS Ball-Playing CB</span> (6+). Van Dijk/R√∫ben Dias level.<br>`;
                    } else if (prPasses >= 4) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Top-tier progressive CB (4-6).<br>`;
                    } else if (prPasses >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> - Modern CB dengan comfortable on ball.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Traditional stopper - Safe passing, minimal risk.<br>`;
                    }
                } else if (isFB) {
                    if (prPasses >= 4) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> - Robertson/Cancelo type FB (4+). Key playmaker dari flank.<br>`;
                    } else if (prPasses >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> - Modern attacking full-back (2.5-4).<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Traditional FB - Crossing > progressive passing.<br>`;
                    }
                } else if (isDM) {
                    if (prPasses >= 8) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE REGISTA</span> (8+). Rodri/Busquets level - Deep-lying dictator.<br>`;
                    } else if (prPasses >= 6) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> DLP (6-8). Main distributor dari base.<br>`;
                    } else if (prPasses >= 4) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">SOLID</span> - Balance antara defensive work & progression.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Defensive-oriented DM - Fokus ball-winning > playmaking.<br>`;
                    }
                } else if (isCM) {
                    if (prPasses >= 7) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> Box-to-box playmaker (7+). Frenkie de Jong level.<br>`;
                    } else if (prPasses >= 5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">EXCELLENT</span> - Progressive midfielder (5-7). Engine room.<br>`;
                    } else if (prPasses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">OK</span> - Contributing ke build-up play.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; More destroyer/runner - Bukan primary creator.<br>`;
                    }
                } else if (isAM) {
                    if (prPasses >= 5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Deep-lying AM (5+). Drop deep untuk dictate.<br>`;
                    } else if (prPasses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Balanced AM - Connect midfield & attack.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Final third specialist - Stay high, create chances.<br>`;
                    }
                } else if (isWinger || isStriker) {
                    if (prPasses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">BONUS TRAIT</span> - False nine/deep-lying forward (3+).<br>`;
                    } else if (prPasses >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Dapat drop deep untuk link-up play.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Stay high - Focus finish moves, bukan build them.<br>`;
                    }
                }
                analysis += '<br>';
            }
            
            // Key Passes & Chance Creation - Position-specific expectations
            if (keyPasses > 0 || chCreated > 0) {
                const xa90 = parseFloat(findAttribute(p, ['xA/90'])) || 0;
                
                analysis += `&#127912; <strong>Kreativitas:</strong> ${chCreated.toFixed(1)} peluang (${keyPasses.toFixed(1)} key passes)/90`;
                if (xa90 > 0) analysis += ` | <strong>xA/90:</strong> ${xa90.toFixed(2)}`;
                analysis += '<br>';
                
                // xA/90 Analysis - Expected Assists benchmark
                if (xa90 > 0) {
                    if (isAM || isWinger) {
                        // AM/Winger: Primary creators
                        if (xa90 >= 0.30) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE CREATOR</span> - xA 0.3+/90. Top assist provider.<br>`;
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: De Bruyne (~0.4), Saka (~0.3), Odegaard (~0.35).<br>`;
                        } else if (xa90 >= 0.20) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">EXCELLENT</span> - xA 0.2-0.3. High-quality chance creator.<br>`;
                        } else if (xa90 >= 0.12) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">GOOD</span> - xA 0.12-0.2. Decent creative output.<br>`;
                        } else {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Limited creative output (xA <0.12). Focus on other aspects.<br>`;
                        }
                    } else if (isFB) {
                        // Full-backs: Bonus creativity
                        if (xa90 >= 0.20) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE ATTACKING FB</span> - xA 0.2+. TAA/Cancelo level (~0.25).<br>`;
                        } else if (xa90 >= 0.12) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> attacking threat (xA 0.12-0.2).<br>`;
                        } else if (xa90 >= 0.06) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional creative contribution.<br>`;
                        }
                    } else if (isStriker) {
                        // Strikers: Link-up play
                        if (xa90 >= 0.20) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">COMPLETE FORWARD</span> - xA 0.2+. Kane/Benzema style.<br>`;
                        } else if (xa90 >= 0.10) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> link-up (xA 0.1-0.2). Bukan pure poacher.<br>`;
                        } else if (xa90 > 0) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional assist - Primary focus tetap scoring.<br>`;
                        }
                    } else {
                        // Generic benchmark
                        if (xa90 >= 0.15) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">HIGH CREATIVE OUTPUT</span> (xA 0.15+).<br>`;
                        } else if (xa90 >= 0.08) {
                            analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">MODERATE</span> creative contribution (xA 0.08-0.15).<br>`;
                        }
                    }
                    analysis += '<br>';
                }
                
                // Position-specific creative benchmarks (Chances Created)
                if (isAM) {
                    // AM: Primary creator - highest expectations
                    if (chCreated >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">WORLD-CLASS AM</span> (3+). De Bruyne/Odegaard level (3-4/90).<br>`;
                    } else if (chCreated >= 2) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> playmaker (2-3). Top-tier creative output.<br>`;
                    } else if (chCreated >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> untuk AM. Consistent creator.<br>`;
                    } else if (chCreated >= 1) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">BELOW PAR</span> untuk AM. Perlu more influence.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">CONCERN</span> - AM harus jadi main creator.<br>`;
                    }
                } else if (isWinger) {
                    // Wingers: Good creator = 1.5+
                    if (chCreated >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE WINGER</span> (2.5+). Saka/Vinicius level creativity.<br>`;
                    } else if (chCreated >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">CREATIVE WINGER</span> (1.5-2.5). Bukan hanya pace merchant.<br>`;
                    } else if (chCreated >= 0.8) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">BALANCED</span> - Mix dribbling, shooting, & creating.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Direct winger - Focus dribble & shoot daripada create.<br>`;
                    }
                } else if (isCM) {
                    // CM: Supporting creator
                    if (chCreated >= 2) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">CREATOR CM</span> (2+). Rare - creative box-to-box.<br>`;
                    } else if (chCreated >= 1.2) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> contribution untuk CM (1.2-2).<br>`;
                    } else if (chCreated >= 0.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Supporting role - Bukan main creator.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Destroyer/runner - Focus defensive work & carrying.<br>`;
                    }
                } else if (isFB) {
                    // Full-backs: Bonus if creative
                    if (chCreated >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE ATTACKING FB</span> (1.5+). TAA/Cancelo level.<br>`;
                    } else if (chCreated >= 0.8) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> offensive contribution (0.8-1.5).<br>`;
                    } else if (chCreated >= 0.3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional attacking threat.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Defensive-oriented FB - Stay back & support.<br>`;
                    }
                } else if (isStriker) {
                    // Strikers: Link-up play bonus
                    if (chCreated >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">COMPLETE FORWARD</span> (1.5+). Kane/Benzema style.<br>`;
                    } else if (chCreated >= 0.8) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD link-up</span> - Bukan hanya finisher.<br>`;
                    } else if (chCreated >= 0.3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional assist - Primary job tetap scoring.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Pure finisher - Off-ball movement > playmaking.<br>`;
                    }
                } else if (isDM) {
                    // DM: Not expected to create much
                    if (chCreated >= 1) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">BONUS</span> - Rare creative DM (1+).<br>`;
                    } else if (chCreated >= 0.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional final ball contribution.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Standard DM - Focus shield defense, recycle possession.<br>`;
                    }
                } else if (isCB) {
                    // CB: Very rare to create
                    if (chCreated >= 0.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">UNIQUE</span> - CB yang join attack (set-pieces?).<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Defensive focus - Normal untuk CB.<br>`;
                    }
                } else {
                    // Generic benchmark
                    if (chCreated >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE CREATOR</span> - Top 10% di posisinya.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Level De Bruyne, Odegaard, Maddison (2.5-3.5/90).<br>`;
                    } else if (chCreated >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">CREATOR SOLID</span> - Above average.<br>`;
                    } else if (chCreated >= 0.8) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Kreativitas moderate. Supporting cast.<br>`;
                    } else if (chCreated > 0) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Bukan natural creator.<br>`;
                    }
                }
                analysis += '<br>';
            }
            
            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>Pass Accuracy:</strong> =85% Elite | 80-85% Excellent | 75-80% Good | &lt;75% Below Par<br>
                        <strong>Progressive Passes/90:</strong> =6 World-Class | 4-6 Excellent | 2-4 Good | &lt;2 Limited<br>
                        <strong>Key Passes/90:</strong> =2.0 Elite Creator | 1.5-2.0 Very Good | 1.0-1.5 Good | &lt;1.0 Limited<br>
                        <strong>Chances Created/90:</strong> =3.0 Elite | 2.0-3.0 Excellent | 1.0-2.0 Good | &lt;1.0 Low
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: Opta/Stats Perform; Top 5 Leagues Average
                    </div>
                </div>
            `;
            
            document.getElementById('passingAnalysis').innerHTML = analysis;
        }

        function analyzePossessionDuel(p, pos) {
            const possWon = parseFloat(findAttribute(p, ['Poss Won/90'])) || 0;
            const possLost = parseFloat(findAttribute(p, ['Poss Lost/90'])) || 0;
            const presC = parseFloat(findAttribute(p, ['Pres C/90'])) || 0;
            const presA = parseFloat(findAttribute(p, ['Pres A/90'])) || 0;
            
            let analysis = '<strong>&#128257;&#128293; Analisis Penguasaan Bola & Pressing:</strong><br><br>';
            
            // Possession Won/Lost Ratio
            if (possWon > 0 || possLost > 0) {
                const ratio = possWon > 0 && possLost > 0 ? (possWon / possLost).toFixed(2) : 0;
                analysis += `&#128274; <strong>Ball Security:</strong> Won ${possWon.toFixed(1)} vs Lost ${possLost.toFixed(1)} (Ratio: ${ratio})<br>`;
                
                // Research shows elite ball carriers have 1.2+ ratio (CIES Football Observatory)
                if (parseFloat(ratio) >= 1.2) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Ball retention superior. Cocok carry bola under pressure.<br>`;
                } else if (parseFloat(ratio) >= 1.0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">BALANCED</span> - Win/loss seimbang. Standar untuk posisinya.<br>`;
                } else if (parseFloat(ratio) >= 0.8) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">TURNOVER RISK</span> - Kehilangan bola lebih sering. Normal untuk risk-taker.<br>`;
                    
                    // Context by position
                    if (pos.includes('W') || pos.includes('F')) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Acceptable untuk winger/forward - high risk/reward style.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Perlu improve decision making untuk ${pos}.<br>`;
                    }
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">MASALAH</span> - Terlalu banyak kehilangan bola. Review first touch & composure.<br>`;
                }
                analysis += '<br>';
            }
            
            // Pressing - Benchmark dari CIES Football Observatory
            if (presC > 0 || presA > 0) {
                const presSuccess = presA > 0 ? ((presC / presA) * 100).toFixed(1) : 0;
                analysis += `&#128293; <strong>Pressing:</strong> ${presC.toFixed(1)} sukses dari ${presA.toFixed(1)} attempts (${presSuccess}%)<br>`;
                
                // Elite pressers: 35-40% success rate (StatsBomb research)
                if (parseFloat(presSuccess) >= 40) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE PRESSER</span> - Success rate luar biasa (>40%). World-class positioning.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Level Kant√©, Gueye, Tchouameni di peak form.<br>`;
                } else if (parseFloat(presSuccess) >= 35) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Above average (35-40%). Pressing sangat efektif.<br>`;
                } else if (parseFloat(presSuccess) >= 30) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> - Standar liga top (30-35%). Kontribusi solid untuk high press.<br>`;
                } else if (parseFloat(presSuccess) >= 25) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> - Work rate ada, tapi timing perlu improve.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">INEFFICIENT</span> - Banyak pressing gagal. Review positioning & timing.<br>`;
                }
                
                // Volume context
                if (presA >= 20) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume presser</strong> (${presA.toFixed(1)} attempts) - Gegenpressing style player.<br>`;
                } else if (presA >= 10) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Moderate pressing</strong> - Selective dalam choose moments.<br>`;
                } else if (presA < 5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low pressing</strong> - Lebih reactive defender atau conserve energy untuk attacks.<br>`;
                }
                analysis += '<br>';
            }
            
            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>Poss Won/Lost Ratio:</strong> =1.2 Excellent | 1.0-1.2 Balanced | 0.8-1.0 Turnover Risk | &lt;0.8 Concern<br>
                        <strong>Pressing Success %:</strong> =40% Elite | 35-40% Excellent | 30-35% Good | 25-30% Average | &lt;25% Inefficient<br>
                        <strong>Dribbles/90:</strong> =3.0 Elite Ball Carrier | 2.0-3.0 Very Good | 1.0-2.0 Good | &lt;1.0 Limited
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: CIES Football Observatory; StatsBomb Research
                    </div>
                </div>
            `;
            
            document.getElementById('possessionAnalysis').innerHTML = analysis;
        }

        function analyzeAttacking(p, pos) {
            const shots = parseFloat(findAttribute(p, ['Shot/90'])) || 0;
            const shotsOT = parseFloat(findAttribute(p, ['Sht/90'])) || 0;
            const xgShot = parseFloat(findAttribute(p, ['xG/shot'])) || 0;
            const xg90 = parseFloat(findAttribute(p, ['xG/90'])) || 0;
            const dribbles = parseFloat(findAttribute(p, ['Drb/90'])) || 0;
            const crosses = parseFloat(findAttribute(p, ['OP-Crs A/90'])) || 0;
            const crossesC = parseFloat(findAttribute(p, ['OP-Crs C/90'])) || 0;
            const goals = parseInt(findAttribute(p, ['Goals', 'Gls'])) || 0;
            const assists = parseInt(findAttribute(p, ['Assists', 'Asts'])) || 0;
            
            let analysis = '<strong>&#9876; Analisis Menyerang:</strong><br><br>';
            
            // xG/90 Analysis - Overall goal threat
            if (xg90 > 0) {
                analysis += `&bull; <strong>xG/90 (Expected Goals per 90):</strong> ${xg90.toFixed(2)}<br>`;
                
                const isStriker = pos.includes('ST') || pos.includes('CF');
                const isWinger = pos.includes('W') || pos.includes('AML') || pos.includes('AMR') || pos.includes('(RL)') || pos.includes('(R)') || pos.includes('(L)');
                const isAM = pos.includes('AM') || pos.includes('CAM');
                
                // DUAL ASSESSMENT untuk Striker & Winger (untuk semua pemain menyerang)
                if (isStriker || isWinger || isAM) {
                    // Assessment sebagai STRIKER
                    analysis += `&nbsp;&nbsp;<strong>&#9876; Sebagai STRIKER:</strong><br>`;
                    if (xg90 >= 0.70) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> (0.7+ xG/90). World-class finisher material.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Haaland (~1.0), Kane (~0.8), Lewandowski (~0.75).<br>`;
                    } else if (xg90 >= 0.50) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> (0.5-0.7). Top-tier striker material (~18-22 goals/season).<br>`;
                    } else if (xg90 >= 0.35) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (0.35-0.5). Solid goal threat (~12-16 goals/season).<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">BELOW PAR</span> untuk striker murni. Perlu improve movement & positioning.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Cocok untuk role support striker, target man, atau false nine.<br>`;
                    }
                    
                    // Assessment sebagai WINGER
                    analysis += `&nbsp;&nbsp;<strong>&#127942; Sebagai WINGER:</strong><br>`;
                    if (xg90 >= 0.40) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> goal-scoring winger (0.4+). Salah/Saka/Son level.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Salah (~0.65), Saka (~0.45), Son (~0.50).<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Inverted winger material - suka cut inside & finish.<br>`;
                    } else if (xg90 >= 0.30) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> (0.3-0.4). Genuine goal threat dari flank.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Balance bagus antara scoring & creating.<br>`;
                    } else if (xg90 >= 0.20) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (0.2-0.3). Balanced winger (goals + assists).<br>`;
                    } else if (xg90 >= 0.10) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">MODERATE</span> threat. More creator/dribbler than finisher.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Traditional winger atau wide playmaker role.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">LIMITED</span> finishing threat. Fokus: Width, crossing, assists.<br>`;
                    }
                    
                    // REKOMENDASI ROLE berdasarkan xG/90
                    analysis += `&nbsp;&nbsp;<strong>&#128161; Rekomendasi:</strong><br>`;
                    if (xg90 >= 0.50) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Striker lebih cocok</strong> - Elite goal threat layak main central.<br>`;
                    } else if (xg90 >= 0.30 && xg90 < 0.50) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Versatile</strong> - Bisa main striker atau inverted winger.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Check dribbling & crossing stats untuk tentukan posisi terbaik.<br>`;
                    } else if (xg90 >= 0.20 && xg90 < 0.30) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Winger lebih cocok</strong> - Better dari flank, bisa contribute goals + assists.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Traditional winger atau AM</strong> - Creator role lebih cocok daripada finisher.<br>`;
                    }
                } else {
                    // Midfielder/Defender - Original assessment
                    if (xg90 >= 0.20) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">BONUS THREAT</span> - Unexpected goals dari posisi ini.<br>`;
                    } else if (xg90 >= 0.10) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Occasional goal threat - Late runs into box atau set-pieces.<br>`;
                    }
                }
                analysis += '<br>';
            }
            
            // Shooting Analysis - xG research from Understat/FBref
            if (shots > 0) {
                const shotAccuracy = shotsOT > 0 ? ((shotsOT / shots) * 100).toFixed(1) : 0;
                analysis += `&#127919; <strong>Shooting:</strong> ${shots.toFixed(1)} shots/90 (${shotAccuracy}% on target)<br>`;
                
                // xG per shot quality (Michael Caley research)
                if (xgShot >= 0.15) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">HIGH QUALITY</span> shots (xG: ${xgShot.toFixed(2)}). Excellent positioning.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Indikasi: Shots dari area berbahaya (penalty box), bukan speculative dari jauh.<br>`;
                } else if (xgShot >= 0.10) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD QUALITY</span> (xG: ${xgShot.toFixed(2)}). Above average shot selection.<br>`;
                } else if (xgShot > 0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">LOW QUALITY</span> (xG: ${xgShot.toFixed(2)}). Banyak long shots atau tight angles.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Saran: Improve movement untuk get into better positions.<br>`;
                }
                
                // Shot volume by position - Different expectations for ST vs Winger
                const isStriker = pos.includes('ST') || pos.includes('CF');
                const isWinger = pos.includes('W') || pos.includes('(RL)') || pos.includes('(R)') || pos.includes('(L)');
                const isAM = pos.includes('AM');
                
                if (isStriker) {
                    if (shots >= 3.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Elite volume striker</strong> (3.5+). Main attacking focal point.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Haaland (~5), Kane (~4), Isak (~3.7).<br>`;
                    } else if (shots >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Good volume</strong> (2.5-3.5). Standar striker modern.<br>`;
                    } else if (shots >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low volume</strong> (1.5-2.5). Link-up striker atau butuh more service.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Very low</strong> (<1.5). Target man atau deep-lying forward style.<br>`;
                    }
                } else if (isWinger) {
                    if (shots >= 3.0) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High-volume winger</strong> (3+). Inverted winger - suka cut inside & shoot.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Tipe seperti Salah, Saka, Raphinha (shooting primary weapon).<br>`;
                    } else if (shots >= 2.0) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Good volume</strong> untuk winger (2-3). Balance shoot & create.<br>`;
                    } else if (shots >= 1.0) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Moderate</strong> (1-2). More creator/crosser than direct shooter.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low</strong> (<1). Traditional winger - width & crossing focus, bukan inverted.<br>`;
                    }
                } else if (isAM) {
                    if (shots >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume AM</strong> (2.5+). Aggressive #10 - loves to shoot (Bruno style).<br>`;
                    } else if (shots >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Balanced AM</strong> (1.5-2.5). Mix antara shoot & create.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Pure playmaker - Prefer final pass over shooting.<br>`;
                    }
                } else {
                    if (shots >= 2) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Aggressive shooter</strong> untuk posisinya. Box-to-box threat.<br>`;
                    }
                }
                analysis += '<br>';
            }
            
            // Dribbling - CIES Football Observatory data
            if (dribbles > 0) {
                analysis += `&#128170; <strong>Dribbling:</strong> ${dribbles.toFixed(1)} successful dribbles/90<br>`;
                
                const isStriker = pos.includes('ST') || pos.includes('CF');
                const isWinger = pos.includes('W') || pos.includes('(RL)') || pos.includes('(R)') || pos.includes('(L)');
                
                // Elite dribblers: 3+ per 90 (Vinicius Jr ~4.5, Musiala ~3.5, Saka ~3.2)
                if (dribbles >= 3.0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE DRIBBLER</span> (3+). World-class 1v1 specialist.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Vinicius Jr (~4.5), Saka (~3.2), Musiala (~3.5).<br>`;
                    if (isWinger) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Core strength - Dapat isolate & beat defenders consistently.<br>`;
                    } else if (isStriker) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Rare trait untuk striker - Can drop deep & dribble (Mbappe style).<br>`;
                    }
                } else if (dribbles >= 2.0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">VERY GOOD</span> (2-3). Confident taking on defenders.<br>`;
                    if (isWinger) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Genuine 1v1 threat - Core weapon untuk beat full-backs.<br>`;
                    }
                } else if (dribbles >= 1.0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (1-2). Occasionally beats opponents in tight spaces.<br>`;
                } else if (dribbles >= 0.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">LIMITED</span> (0.5-1). Rarely attempts take-ons.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Bukan dribbler. Prefer quick passing, off-ball movement, atau physicality.<br>`;
                }
                
                // Context warning untuk winger dengan dribbling rendah
                if (isWinger && dribbles < 1.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Low dribbling untuk winger - More sistem player atau crosser style.<br>`;
                }
                
                analysis += '<br>';
            }
            
            // Crossing - Wyscout analysis
            if (crosses > 0) {
                const crossAcc = ((crossesC / crosses) * 100).toFixed(1);
                analysis += `&#129534; <strong>Crossing:</strong> ${crosses.toFixed(1)} attempts (${crossAcc}% completed)<br>`;
                
                const isWinger = pos.includes('W') || pos.includes('(RL)') || pos.includes('(R)') || pos.includes('(L)');
                const isFB = pos.includes('D/WB') || pos.includes('WB') || pos.includes('D (R)') || pos.includes('D (L)');
                
                // Good crossing accuracy: 28-35% (WhoScored/Opta research)
                if (parseFloat(crossAcc) >= 35) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> crosser (35%+). Pinpoint delivery - TAA/De Bruyne level.<br>`;
                } else if (parseFloat(crossAcc) >= 28) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> accuracy (28-35%). Very reliable outlet.<br>`;
                } else if (parseFloat(crossAcc) >= 22) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (22-28%). Above average crosser.<br>`;
                } else if (parseFloat(crossAcc) >= 18) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (~18-22%). Standar untuk volume crosser.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">POOR</span> accuracy (<18%). Perlu improve timing & technique.<br>`;
                }
                
                // Volume context - Different for Wingers vs Full-backs
                if (isWinger) {
                    if (crosses >= 4) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Very high volume</strong> (4+). Traditional winger - crossing primary weapon.<br>`;
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Tipe seperti Grealish (Man City), Pedro Neto - Stay wide & deliver.<br>`;
                    } else if (crosses >= 2.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume</strong> (2.5-4). Consistent wide threat.<br>`;
                    } else if (crosses >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Moderate</strong> (1.5-2.5). Balanced wide play - mix crossing & cutting inside.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low volume</strong> (<1.5). Inverted winger - prefer cutting inside over crossing.<br>`;
                    }
                } else if (isFB) {
                    if (crosses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Very high volume FB</strong> (3+). Attacking wing-back role - TAA style.<br>`;
                    } else if (crosses >= 1.5) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Good volume</strong> untuk FB (1.5-3). Active dalam build-up.<br>`;
                    } else {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; More defensive-oriented FB atau inverted full-back.<br>`;
                    }
                } else {
                    if (crosses >= 3) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume</strong> (3+). Wide role dalam sistem.<br>`;
                    }
                }
                
                // Warning untuk volume tinggi dengan accuracy rendah
                if ((isWinger || isFB) && parseFloat(crossAcc) < 20 && crosses >= 2.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume + Low accuracy</strong> = Wasteful possession.<br>`;
                    if (isWinger) {
                        analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Saran: Consider cutting inside more atau improve crossing technique.<br>`;
                    }
                }
                
                analysis += '<br>';
            }
            
            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>xG/90 (Striker):</strong> =0.7 Elite | 0.5-0.7 Excellent | 0.35-0.5 Good | &lt;0.35 Limited<br>
                        <strong>xG/90 (Winger):</strong> =0.4 Elite | 0.3-0.4 Excellent | 0.2-0.3 Good | &lt;0.2 Limited<br>
                        <strong>xG per Shot:</strong> =0.15 Elite Positioning | 0.12-0.15 Excellent | 0.10-0.12 Good | &lt;0.10 Poor<br>
                        <strong>Dribbles/90:</strong> =3.0 Elite | 2.0-3.0 Very Good | 1.0-2.0 Good | &lt;1.0 Limited<br>
                        <strong>Crossing Accuracy:</strong> =35% Elite | 28-35% Excellent | 22-28% Good | &lt;22% Poor
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: FBref Top 5 Leagues; Wyscout Data
                    </div>
                </div>
            `;
            
            document.getElementById('attackingAnalysis').innerHTML = analysis;
        }

        function analyzeDefensive(p, pos) {
            const hdrsW = parseFloat(findAttribute(p, ['Hdrs W/90'])) || 0;
            const interceptions = parseFloat(findAttribute(p, ['Int/90'])) || 0;
            const tackles = parseFloat(findAttribute(p, ['Tck/90'])) || 0;
            const tackleRate = parseFloat(findAttribute(p, ['Tck R'])) || 0;
            const clearances = parseFloat(findAttribute(p, ['Clr/90'])) || 0;
            const blocks = parseFloat(findAttribute(p, ['Blk/90'])) || 0;
            
            const isDefender = pos.includes('D') || pos.includes('CB') || pos.includes('B');
            const isDM = pos.includes('DM') || pos.includes('CDM');
            
            let analysis = '<strong>&#128737; Analisis Defensif:</strong><br><br>';
            
            // Aerial Duels - StatsBomb research
            if (hdrsW > 0) {
                analysis += `&#9917; <strong>Aerial Duels:</strong> ${hdrsW.toFixed(1)} headers won/90<br>`;
                
                // Elite CBs: 3.5+ (Van Dijk ~5, Dias ~4.5)
                if (hdrsW >= 4) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">DOMINANT</span> in the air (4+). Elite set-piece defender.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Top 5% CBs di liga Eropa. Dapat jadi target man juga.<br>`;
                } else if (hdrsW >= 3) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">STRONG</span> aerial presence (3-4). Reliable untuk high balls.<br>`;
                } else if (hdrsW >= 2) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> aerial ability. Kompetitif di udara.<br>`;
                } else if (hdrsW >= 1) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">MODERATE</span>. Bisa menang aerial duels occasionally.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Bukan kekuatan. Hindari target long balls.<br>`;
                }
                
                if (isDefender && hdrsW >= 3) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Big asset untuk set-piece defense + attack.<br>`;
                }
                analysis += '<br>';
            }
            
            // Interceptions - FBref Top 5 Leagues
            if (interceptions > 0) {
                analysis += `&#128683; <strong>Interceptions:</strong> ${interceptions.toFixed(1)}/90<br>`;
                
                // Elite interceptors: 2.5+ for CBs, 2+ for DMs
                if (interceptions >= 3) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE READER</span> (3+). Exceptional anticipation.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Indikasi: Positioning intelligence + reading passing lanes expert.<br>`;
                } else if (interceptions >= 2) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> anticipation (2-3). Proactive defender.<br>`;
                } else if (interceptions >= 1.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> reading of game. Above average positioning.<br>`;
                } else if (interceptions >= 1) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span>. Standar untuk posisinya.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Lebih reactive daripada proactive defender.<br>`;
                }
                analysis += '<br>';
            }
            
            // Tackling - WhoScored/Opta data
            if (tackles > 0) {
                analysis += `&#128170; <strong>Tackling:</strong> ${tackles.toFixed(1)} tackles/90 (${tackleRate.toFixed(0)}% success)<br>`;
                
                // Elite tackle success: 75%+ (Opta research)
                if (tackleRate >= 80) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE EFFICIENCY</span> (80%+). Timing sempurna.<br>`;
                } else if (tackleRate >= 70) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> (70-80%). Clean tackler, rarely fouls.<br>`;
                } else if (tackleRate >= 60) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (60-70%). Standar defensive midfielder.<br>`;
                } else if (tackleRate >= 50) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (~50%). Masih banyak miss tackles.<br>`;
                } else if (tackleRate > 0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">POOR</span> (<50%). Timing issue, sering buat foul.<br>`;
                }
                
                // Volume context
                if (tackles >= 3) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>High volume tackler</strong> - Aggressive ball-winner style.<br>`;
                } else if (tackles >= 1.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Moderate</strong> - Balanced defensive approach.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low tackles</strong> - Prefer positioning/interceptions over diving in.<br>`;
                }
                analysis += '<br>';
            }
            
            // Clearances & Blocks
            if (clearances >= 3 || blocks > 0) {
                analysis += `&#128737; <strong>Last-ditch Defense:</strong> ${clearances.toFixed(1)} clearances, ${blocks.toFixed(1)} blocks/90<br>`;
                
                if (clearances >= 5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">HIGH CLEARANCES</span> (5+). Tim sering under pressure atau deep block.<br>`;
                } else if (clearances >= 3) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Normal untuk CB. Active dalam box defense.<br>`;
                }
                
                if (blocks >= 1.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">SHOT BLOCKER</span>. Brave dan well-positioned untuk block shots.<br>`;
                }
                analysis += '<br>';
            }
            
            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>Aerial Duels/90:</strong> =4.0 Dominant | 3.0-4.0 Strong | 2.0-3.0 Good | 1.0-2.0 Moderate | &lt;1.0 Weak<br>
                        <strong>Interceptions/90:</strong> =3.0 Elite | 2.5-3.0 Excellent | 2.0-2.5 Very Good | 1.5-2.0 Good | &lt;1.5 Limited<br>
                        <strong>Tackles/90:</strong> =3.5 Very High | 2.5-3.5 High | 1.5-2.5 Good | 1.0-1.5 Moderate | &lt;1.0 Low<br>
                        <strong>Tackle Success %:</strong> =75% Elite | 70-75% Excellent | 65-70% Good | 60-65% Average | &lt;60% Poor<br>
                        <strong>Clearances/90:</strong> =5.0 Very High | 3.5-5.0 High | 2.0-3.5 Moderate | &lt;2.0 Low
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: StatsBomb; FBref Top 5 Leagues Data
                    </div>
                </div>
            `;
            
            document.getElementById('defensiveAnalysis').innerHTML = analysis;
        }

        function analyzePhysical(p, pos) {
            const distance = parseFloat(findAttribute(p, ['Dist/90'])) || 0;
            const sprints = parseFloat(findAttribute(p, ['Sprints/90'])) || 0;
            
            let analysis = '<strong>&#128170;&#9889; Analisis Mobilitas & Fisik:</strong><br><br>';
            
            // Distance covered - Sports science research (Bangsbo, Mohr et al.)
            if (distance > 0) {
                analysis += `&#128694; <strong>Distance Covered:</strong> ${distance.toFixed(1)} km/90<br>`;
                
                // Premier League average: 10-11km (varies by position)
                if (distance >= 12) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCEPTIONAL</span> work rate (12+ km). Elite endurance.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Referensi: Kante, Henderson, Goretzka level (~12-13km).<br>`;
                } else if (distance >= 11) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> (11-12 km). Above average stamina.<br>`;
                } else if (distance >= 10) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (10-11 km). Standar premier league midfielder.<br>`;
                } else if (distance >= 9) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (9-10 km). OK untuk forward/CB position.<br>`;
                } else if (distance > 0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">LOW</span> (<9 km). Limited mobility atau conserving energy.<br>`;
                }
                
                // Position-specific context
                const isMidfielder = pos.includes('M');
                const isDefender = pos.includes('D') || pos.includes('B');
                const isForward = pos.includes('F') || pos.includes('ST');
                
                if (isMidfielder && distance >= 11) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Perfect for <strong>box-to-box</strong> atau high-intensity pressing role.<br>`;
                } else if (isDefender && distance >= 11) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Modern <strong>attacking full-back</strong> atau libero material.<br>`;
                } else if (isForward && distance < 9.5) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Target man</strong> atau poacher style - conserve energy for key moments.<br>`;
                }
                analysis += '<br>';
            }
            
            // Sprints - High intensity running research (Ingebrigtsen et al.)
            if (sprints > 0) {
                analysis += `&#9889; <strong>Sprints:</strong> ${sprints.toFixed(0)} high-intensity runs/90<br>`;
                
                // Elite: 25-35+ sprints per game (varies by position)
                if (sprints >= 30) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXPLOSIVE</span> player (30+). Constant threat dengan pace.<br>`;
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Counter-attack weapon. Transition specialist.<br>`;
                } else if (sprints >= 20) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">HIGH INTENSITY</span> (20-30). Good burst of speed regularly.<br>`;
                } else if (sprints >= 15) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">MODERATE</span> (15-20). Selective sprinting, conserve energy.<br>`;
                } else if (sprints >= 10) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #ffc107;">LOW</span> intensity (10-15). Pace bukan main asset.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Minimal sprinting. Positional player atau lacks pace.<br>`;
                }
                
                // Combined with distance
                if (distance >= 11 && sprints >= 20) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Complete athlete</strong> - Endurance + explosiveness. Rare combination.<br>`;
                } else if (distance >= 11 && sprints < 15) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Marathon runner</strong> - High volume, low intensity style.<br>`;
                } else if (distance < 10 && sprints >= 20) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Explosive athlete</strong> - Burst player, bukan endurance runner.<br>`;
                }
                analysis += '<br>';
            }
            
            analysis += '<strong>&#128170; Profil Fisik:</strong><br>';
            if (distance >= 11 && sprints >= 25) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Elite Athlete</strong> - Complete physical package. Box-to-box specialist.<br>';
            } else if (distance >= 11) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Workhorse</strong> - Tireless runner, cover a lot of ground consistently.<br>';
            } else if (sprints >= 25) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Speed Merchant</strong> - Explosive pace, transition threat.<br>';
            } else if (distance < 10 && sprints < 15) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Economy Player</strong> - Conserve energy, maximize efficiency. Technical over physical.<br>';
            } else {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Balanced</strong> - Standard physical output untuk posisinya.<br>';
            }
            
            analysis += '<br><strong>&#128221; Implikasi Taktis:</strong><br>';
            if (distance >= 11 || sprints >= 20) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Cocok untuk <strong>high-press, counter-press</strong> system (Klopp/Guardiola style).<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Dapat maintain intensity sepanjang 90 menit.<br>';
            } else if (distance < 10 && sprints < 15) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Lebih cocok untuk <strong>possession-based, slower tempo</strong> game.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Consider rotasi atau substitusi di menit 60-70.<br>';
            }
            
            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>Distance/90 (km):</strong> =12 Exceptional | 11-12 Excellent | 10-11 Good | 9-10 Average | &lt;9 Low<br>
                        <strong>Sprints/90:</strong> =30 Elite Pace | 25-30 Excellent | 20-25 Very Good | 15-20 Good | 10-15 Moderate | &lt;10 Low<br>
                        <strong>Context:</strong> Midfielders avg 10.5-11.5km | Forwards avg 9-10km | Defenders avg 9.5-10.5km
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: Bangsbo et al.; Sports Science Research; Premier League Data
                    </div>
                </div>
            `;
            
            document.getElementById('physicalAnalysis').innerHTML = analysis;
        }

        function analyzeGoalkeeper(p, pos) {
            // Only run if player is a goalkeeper or GK-specific metrics exist
            const xgp90 = parseFloat(findAttribute(p, ['xGP/90'])) || 0;
            const xsvPerc = parseFloat(findAttribute(p, ['xSv %'])) || 0;
            const xgp = parseFloat(findAttribute(p, ['xGP'])) || 0;
            const svPerc = parseFloat(findAttribute(p, ['Sv %'])) || 0;
            const cln90 = parseFloat(findAttribute(p, ['Cln/90'])) || 0;
            const shutouts = parseInt(findAttribute(p, ['Shutouts'])) || 0;
            const conceded90 = parseFloat(findAttribute(p, ['All/90'])) || 0;

            let analysis = '<strong>&#129516; Analisis Goalkeeper:</strong><br><br>';

            // Goals Conceded Analysis
            if (conceded90 > 0) {
                analysis += `&bull; <strong>Goals Conceded/90:</strong> ${conceded90.toFixed(2)}<br>`;
                // Lower is better for GK
                if (conceded90 <= 0.80) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Very low goals conceded (=0.8). Elite defensive record.<br>';
                    analysis += '&nbsp;&nbsp;&bull; Referensi: Top 5% GKs di liga. Ederson (~0.7), Alisson (~0.75) level.<br>';
                } else if (conceded90 <= 1.00) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">VERY GOOD</span> (0.8-1.0). Strong defensive organization.<br>';
                } else if (conceded90 <= 1.20) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (~1.0-1.2). Above average defensive stability.<br>';
                } else if (conceded90 <= 1.50) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (~1.2-1.5). Mid-table standard.<br>';
                } else {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #dc3545;">CONCERN</span> (>1.5). High goals conceded - defensive issues.<br>';
                    analysis += '&nbsp;&nbsp;&bull; Bisa karena: weak defense, poor positioning, atau shot-stopping issues.<br>';
                }
                analysis += '<br>';
            }

            // xG Prevention Analysis
            if (xgp90 > 0 || xgp90 < 0) {
                analysis += `&bull; <strong>xG Prevented/90:</strong> ${xgp90 > 0 ? '+' : ''}${xgp90.toFixed(2)}<br>`;
                // Context: positive xG prevented is good (prevents goals above expected)
                if (xgp90 >= 0.25) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> - Consistently preventing goals above expectation (+0.25).<br>';
                    analysis += '&nbsp;&nbsp;&bull; Shot-stopping ability kelas dunia. Saves yang seharusnya goal.<br>';
                } else if (xgp90 >= 0.10) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (+0.1 to +0.25) - Kontribusi positif untuk defensive line.<br>';
                } else if (xgp90 >= -0.05) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (¬±0.05) - Neutral impact vs xG baseline.<br>';
                } else {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #dc3545;">BELOW EXPECTATION</span> (<-0.05) - Conceding more than expected. Perlu improve.<br>';
                    analysis += '&nbsp;&nbsp;&bull; Indikasi: Positioning errors, slow reactions, atau poor decision making.<br>';
                }
                analysis += '<br>';
            }

            // Expected Save % Analysis
            if (xsvPerc > 0) {
                analysis += `&bull; <strong>Expected Save % (xSv %):</strong> ${xsvPerc.toFixed(0)}%<br>`;
                if (xsvPerc >= 70) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> (70%+) - Saves above expected consistently. World-class reflexes.<br>';
                } else if (xsvPerc >= 60) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (60-70%) - Above average shot-stopping quality.<br>';
                } else {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE/BELOW</span> (<60%) - May concede routine shots. Focus training.<br>';
                }
                analysis += '<br>';
            }

            // Actual Save % Analysis
            if (svPerc > 0) {
                analysis += `&bull; <strong>Save %:</strong> ${svPerc.toFixed(0)}%<br>`;
                // Elite keepers: 75%+ (Premier League standard)
                if (svPerc >= 75) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">EXCELLENT</span> (75%+) - Reliable shot-stopper.<br>';
                } else if (svPerc >= 70) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (70-75%) - Solid saves conversion.<br>';
                } else if (svPerc >= 65) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (65-70%) - Standar league average.<br>';
                } else {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #dc3545;">BELOW AVERAGE</span> (<65%) - Room for improvement in handling shots.<br>';
                }
                analysis += '<br>';
            }

            // Clean Sheets Analysis
            if (cln90 > 0 || shutouts > 0) {
                if (shutouts > 0) analysis += `&bull; <strong>Clean Sheets Total:</strong> ${shutouts}<br>`;
                if (cln90 > 0) analysis += `&bull; <strong>Clean Sheets/90:</strong> ${cln90.toFixed(2)} (${(cln90*100).toFixed(0)}% of games)<br>`;
                
                // Clean sheet rate benchmark
                if (cln90 >= 0.40) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #28a745;">ELITE</span> clean sheet rate (40%+). Defensive rock.<br>';
                    analysis += '&nbsp;&nbsp;&bull; Kombinasi: Excellent shot-stopping + defensive organization + command of box.<br>';
                } else if (cln90 >= 0.30) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">GOOD</span> (30-40%). Reliable untuk defensive teams.<br>';
                } else if (cln90 >= 0.20) {
                    analysis += '&nbsp;&nbsp;&bull; <span style="color: #ffc107;">AVERAGE</span> (~20-30%). Standar untuk mid-table teams.<br>';
                } else if (cln90 > 0) {
                    analysis += '&nbsp;&nbsp;&bull; Limited clean sheets (<20%). Mungkin defensive line lemah atau high-risk style.<br>';
                }
                analysis += '<br>';
            }

            // Overall Goalkeeper Profile
            analysis += '<strong>&#129516; Profil GK:</strong><br>';
            if (conceded90 <= 1.0 && xgp90 >= 0.2 && svPerc >= 75 && cln90 >= 0.35) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Elite Shot-Stopper</strong> - World-class reflexes, commanding presence, defensive anchor.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&bull; Goals conceded minimal, clean sheets tinggi, saves above expectation.<br>';
            } else if (conceded90 <= 1.0 && cln90 >= 0.30) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Reliable Traditional GK</strong> - Solid shot-stopping, organizational skills, team trust.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&bull; Defensive stability excellent, low goals conceded.<br>';
            } else if (xgp90 >= 0.15 && svPerc >= 70) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Quality Shot-Stopper</strong> - Saves high-quality chances, prevents expected goals.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&bull; Can bail out team dengan crucial saves meski goals conceded moderate.<br>';
            } else if (conceded90 >= 1.3 || xgp90 < 0) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Developing GK</strong> - Perlu fokus pada fundamentals: positioning, handling, decision making.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&bull; High goals conceded dan/atau underperforming vs xG expectation.<br>';
            } else {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Balanced GK</strong> - Competent di semua aspek, no major weaknesses.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&bull; Standard performance untuk level timnya.<br>';
            }

            // Tactical implications & Performance Summary
            analysis += '<br><strong>&#128221; Implikasi Taktis & Rekomendasi:</strong><br>';
            
            if (conceded90 <= 1.0 && xgp90 >= 0.15) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Defensive Anchor</strong> - Can play in high line system, confident shot-stopper.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Cocok untuk <strong>attacking team</strong> yang occasional concede high-quality chances.<br>';
            } else if (conceded90 <= 1.0 && cln90 >= 0.35) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Low-block Specialist</strong> - Excellent untuk defensive organization.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Cocok untuk <strong>defensive setup</strong>, protect 1-0 leads, park the bus tactics.<br>';
            } else if (conceded90 >= 1.5) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Defensive Overhaul Needed</strong> - High goals conceded is major concern.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Focus: <strong>Positioning drills</strong>, 1v1 situations, communication dengan defenders.<br>';
            }
            
            if (svPerc < 70 || xgp90 < 0) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Shot-stopping Training</strong> - Perlu improve reflex & decision making.<br>';
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; Latihan: Reaction saves, shot-stopping dari berbagai angles, handling under pressure.<br>';
            }
            
            if (cln90 >= 0.30) {
                analysis += '&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Set-piece Specialist</strong> - Excellent command of box, komunikasi dengan defenders.<br>';
            }
            
            // Performance vs Expectation
            if (conceded90 > 0 && xgp90 !== 0) {
                const expectedConceded = conceded90 - xgp90;
                analysis += `<br><strong>&#128202; Performance vs Expectation:</strong><br>`;
                analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Actual: ${conceded90.toFixed(2)} goals conceded/90<br>`;
                analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Expected (based on shots faced): ~${expectedConceded.toFixed(2)}/90<br>`;
                if (xgp90 > 0) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #28a745;">OVERPERFORMING</span> - Preventing ${Math.abs(xgp90).toFixed(2)} goals/90 above expectation!<br>`;
                } else if (xgp90 < -0.05) {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #dc3545;">UNDERPERFORMING</span> - Conceding ${Math.abs(xgp90).toFixed(2)} goals/90 more than expected.<br>`;
                } else {
                    analysis += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <span style="color: #17a2b8;">MEETING EXPECTATION</span> - Performance sesuai dengan quality shots faced.<br>`;
                }
            }

            // Add Benchmark Box at the bottom
            analysis += `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e1e8ed; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">&#128220; Benchmark:</div>
                    <div style="font-size: 0.8em; color: #5a6c7d; line-height: 1.6;">
                        <strong>Goals Conceded/90:</strong> =0.8 Excellent | 0.8-1.0 Very Good | 1.0-1.2 Good | 1.2-1.5 Average | &gt;1.5 Concern<br>
                        <strong>Save %:</strong> =75% Elite | 72-75% Excellent | 68-72% Good | 65-68% Average | &lt;65% Poor<br>
                        <strong>xG Prevented/90:</strong> =0.20 Elite | 0.10-0.20 Excellent | 0.0-0.10 Good | &lt;0.0 Underperforming<br>
                        <strong>Clean Sheets %:</strong> =40% Excellent | 30-40% Very Good | 20-30% Good | &lt;20% Limited
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e1e8ed; font-size: 0.75em; color: #7f8c8d; font-style: italic;">
                        Source: StatsBomb; FBref GK Statistics
                    </div>
                </div>
            `;

            document.getElementById('goalkeeperAnalysis').innerHTML = analysis;
        }

        function displayGroupedStats(p) {
            // Basic Stats
            const basicStats = [
                { label: 'Avg Rating', value: findAttribute(p, ['Avg Rat', 'AvRat', 'Average Rating']), format: 'rating' },
                { label: 'Appearances', value: findAttribute(p, ['Appearances', 'Apps', 'Aps']), format: 'number' },
                { label: 'Goals', value: findAttribute(p, ['Goals', 'Gls']), format: 'number' },
                { label: 'Assists', value: findAttribute(p, ['Assists', 'Asts', 'Ast']), format: 'number' },
                { label: 'Man of Match', value: findAttribute(p, ['MoM', 'MotM']), format: 'number' }
            ];
            displayStatGroup('basicStats', basicStats);

            // Passing & Creativity
            const passingStats = [
                { label: 'Pr Passes', value: findAttribute(p, ['Pr passes/90']), format: 'decimal' },
                { label: 'Ps Attempted', value: findAttribute(p, ['Ps A/90']), format: 'decimal' },
                { label: 'Ps Completed', value: findAttribute(p, ['Ps C/90']), format: 'decimal' },
                { label: 'Key Passes', value: findAttribute(p, ['OP-KP/90']), format: 'decimal' },
                { label: 'Assists/90', value: findAttribute(p, ['Asts/90']), format: 'decimal' },
                { label: 'xA/90', value: findAttribute(p, ['xA/90']), format: 'decimal' },
                { label: 'Ch Created', value: findAttribute(p, ['Ch C/90']), format: 'decimal' }
            ];
            displayStatGroup('passingStats', passingStats);

            // Possession & Duel
            const possessionStats = [
                { label: 'Poss Won', value: findAttribute(p, ['Poss Won/90']), format: 'decimal' },
                { label: 'Poss Lost', value: findAttribute(p, ['Poss Lost/90']), format: 'decimal' },
                { label: 'Pres Attempted', value: findAttribute(p, ['Pres A/90']), format: 'decimal' },
                { label: 'Pres Completed', value: findAttribute(p, ['Pres C/90']), format: 'decimal' }
            ];
            displayStatGroup('possessionStats', possessionStats);

            // Attacking
            const attackingStats = [
                { label: 'Shots', value: findAttribute(p, ['Shot/90']), format: 'decimal' },
                { label: 'Shots on Target', value: findAttribute(p, ['Sht/90']), format: 'decimal' },
                { label: 'xG/90', value: findAttribute(p, ['xG/90']), format: 'decimal' },
                { label: 'xG per Shot', value: findAttribute(p, ['xG/shot']), format: 'decimal' },
                { label: 'Dribbles', value: findAttribute(p, ['Drb/90']), format: 'decimal' },
                { label: 'Crosses Att', value: findAttribute(p, ['OP-Crs A/90']), format: 'decimal' },
                { label: 'Crosses Comp', value: findAttribute(p, ['OP-Crs C/90']), format: 'decimal' }
            ];
            displayStatGroup('attackingStats', attackingStats);

            // Defensive
            const defensiveStats = [
                { label: 'Headers Won', value: findAttribute(p, ['Hdrs W/90']), format: 'decimal' },
                { label: 'Blocks', value: findAttribute(p, ['Blk/90']), format: 'decimal' },
                { label: 'Clearances', value: findAttribute(p, ['Clr/90']), format: 'decimal' },
                { label: 'Interceptions', value: findAttribute(p, ['Int/90']), format: 'decimal' },
                { label: 'Tackles', value: findAttribute(p, ['Tck/90']), format: 'decimal' },
                { label: 'Tackle Rate', value: findAttribute(p, ['Tck R']), format: 'percent' }
            ];
            displayStatGroup('defensiveStats', defensiveStats);

            // Physical & Mobility
            const physicalStats = [
                { label: 'Distance (km)', value: findAttribute(p, ['Dist/90']), format: 'decimal' },
                { label: 'Sprints', value: findAttribute(p, ['Sprints/90']), format: 'decimal' }
            ];
            displayStatGroup('physicalStats', physicalStats);

            // Goalkeeper-specific metrics (if present)
            const goalkeeperStats = [
                { label: 'xG Prevented/90 (xGP/90)', value: findAttribute(p, ['xGP/90']), format: 'decimal' },
                { label: 'xSv %', value: findAttribute(p, ['xSv %']), format: 'percent' },
                { label: 'xGP', value: findAttribute(p, ['xGP']), format: 'decimal' },
                { label: 'Sv %', value: findAttribute(p, ['Sv %']), format: 'percent' },
                { label: 'Clean Sheets/90', value: findAttribute(p, ['Cln/90']), format: 'decimal' },
                { label: 'Clean Sheets Total', value: findAttribute(p, ['Shutouts']), format: 'number' },
                { label: 'Goals Conceded/90', value: findAttribute(p, ['All/90']), format: 'decimal' }
            ];
            displayStatGroup('goalkeeperStats', goalkeeperStats);
        }

        function displayStatGroup(elementId, stats) {
            let html = '';
            let hasData = false;
            
            stats.forEach(stat => {
                if (stat.value !== null && stat.value !== undefined && stat.value !== '') {
                    hasData = true;
                    let displayValue = stat.value;
                    let cssClass = 'stat-value';
                    
                    if (stat.format === 'rating') {
                        const val = parseFloat(stat.value);
                        if (val >= 7.5) cssClass += ' rating-excellent';
                        else if (val >= 7.0) cssClass += ' rating-good';
                        else if (val >= 6.5) cssClass += ' rating-average';
                        else cssClass += ' rating-poor';
                        displayValue = val.toFixed(2);
                    } else if (stat.format === 'decimal') {
                        displayValue = parseFloat(stat.value).toFixed(1);
                    } else if (stat.format === 'percent') {
                        displayValue = parseFloat(stat.value).toFixed(0) + '%';
                    }
                    
                    html += `
                        <div class="stat-box">
                            <div class="stat-label">${stat.label}</div>
                            <div class="${cssClass}">${displayValue}</div>
                        </div>
                    `;
                }
            });
            
            document.getElementById(elementId).innerHTML = html || '<p style="padding: 15px; color: #999;">Data tidak tersedia</p>';
        }

        function generateInsights(p) {
            const insights = [];
            const pos = (findAttribute(p, ['Position', 'Pos']) || '').toUpperCase();
            
            // Get all stats
            const avgRat = parseFloat(findAttribute(p, ['Avg Rat', 'Rating', 'AvRat', 'Average Rating'])) || 0;
            const apps = parseInt(findAttribute(p, ['Appearances', 'Apps'])) || 0;
            const goals = parseInt(findAttribute(p, ['Goals', 'Gls'])) || 0;
            const assists = parseInt(findAttribute(p, ['Assists', 'Asts'])) || 0;
            const prPasses = parseFloat(findAttribute(p, ['Pr passes/90'])) || 0;
            const psC = parseFloat(findAttribute(p, ['Ps C/90'])) || 0;
            const psA = parseFloat(findAttribute(p, ['Ps A/90'])) || 0;
            const keyPasses = parseFloat(findAttribute(p, ['OP-KP/90'])) || 0;
            const chCreated = parseFloat(findAttribute(p, ['Ch C/90'])) || 0;
            const possWon = parseFloat(findAttribute(p, ['Poss Won/90'])) || 0;
            const possLost = parseFloat(findAttribute(p, ['Poss Lost/90'])) || 0;
            const presC = parseFloat(findAttribute(p, ['Pres C/90'])) || 0;
            const dribbles = parseFloat(findAttribute(p, ['Drb/90'])) || 0;
            const crosses = parseFloat(findAttribute(p, ['OP-Crs A/90'])) || 0;
            const crossesC = parseFloat(findAttribute(p, ['OP-Crs C/90'])) || 0;
            const shots = parseFloat(findAttribute(p, ['Shot/90'])) || 0;
            const shotsOT = parseFloat(findAttribute(p, ['Sht/90'])) || 0;
            const xgShot = parseFloat(findAttribute(p, ['xG/shot'])) || 0;
            const distance = parseFloat(findAttribute(p, ['Dist/90'])) || 0;
            const sprints = parseFloat(findAttribute(p, ['Sprints/90'])) || 0;
            const hdrsW = parseFloat(findAttribute(p, ['Hdrs W/90'])) || 0;
            const blocks = parseFloat(findAttribute(p, ['Blk/90'])) || 0;
            const clearances = parseFloat(findAttribute(p, ['Clr/90'])) || 0;
            const interceptions = parseFloat(findAttribute(p, ['Int/90'])) || 0;
            const tackles = parseFloat(findAttribute(p, ['Tck/90'])) || 0;
            const tackleRate = parseFloat(findAttribute(p, ['Tck R'])) || 0;
            const mom = parseInt(findAttribute(p, ['MoM'])) || 0;

            if (apps === 0) {
                insights.push({ type: 'neutral', icon: '&#128681;', text: 'Belum ada data pertandingan yang cukup.' });
                return insights;
            }

            // Overall Rating
            if (avgRat >= 7.5) {
                insights.push({ type: 'strength', icon: '&#11088;', text: `Performa EXCELLENT (${avgRat.toFixed(2)}). Pemain kunci dengan dampak besar.` });
            } else if (avgRat >= 7.0) {
                insights.push({ type: 'strength', icon: '&#128077;', text: `Performa SOLID (${avgRat.toFixed(2)}). Kontributor andalan tim.` });
            } else if (avgRat > 0 && avgRat < 6.5) {
                insights.push({ type: 'weakness', icon: '&#9888;', text: `Rating ${avgRat.toFixed(2)} di bawah standar. Perlu evaluasi role atau adaptasi.` });
            }

            // Passing & Build-up
            if (psC >= 40 && psA > 0) {
                const accuracy = ((psC / psA) * 100).toFixed(1);
                insights.push({ type: 'strength', icon: '&#127912;', text: `Passing tinggi (${psC.toFixed(1)}/90, ${accuracy}% akurasi). ${prPasses >= 5 ? 'Progresif dalam build-up (' + prPasses.toFixed(1) + ' pr passes).' : ''}` });
            }
            if (prPasses >= 5) {
                insights.push({ type: 'strength', icon: '&#128640;', text: `Progressive passes excellent (${prPasses.toFixed(1)}/90). Efektif membawa bola ke area berbahaya.` });
            }

            // Creativity
            if (chCreated >= 2.0) {
                insights.push({ type: 'strength', icon: '&#127775;', text: `Kreator utama: ${chCreated.toFixed(1)} peluang/90. ${keyPasses >= 1.5 ? 'Key passes produktif (' + keyPasses.toFixed(1) + ').' : ''}` });
            }

            // Goal Contributions
            if (goals > 0 || assists > 0) {
                const total = goals + assists;
                const per90 = (total / apps).toFixed(2);
                insights.push({ type: 'strength', icon: '??', text: `${goals}G + ${assists}A = ${total} kontribusi (${per90}/match). ${xgShot >= 0.15 ? 'Quality peluang bagus (xG ' + xgShot.toFixed(2) + ').' : ''}` });
            }

            // Dribbling & Mobility
            if (dribbles >= 1.5) {
                insights.push({ type: 'strength', icon: '&#128293;', text: `Dribbler aktif (${dribbles.toFixed(1)}/90). ${sprints >= 20 ? 'Sprint tinggi (' + sprints.toFixed(0) + '/90) - ancaman transisi.' : ''}` });
            }
            if (distance >= 11) {
                insights.push({ type: 'strength', icon: '&#128170;', text: `Work rate tinggi (${distance.toFixed(1)} km/90). Excellent untuk box-to-box role.` });
            }

            // Crossing
            if (crosses >= 2) {
                const crossAcc = crosses > 0 ? ((crossesC / crosses) * 100).toFixed(1) : 0;
                insights.push({ type: crosses >= 3 ? 'strength' : 'neutral', icon: '&#128640;', text: `Outlet sayap (${crosses.toFixed(1)} crosses/90, ${crossAcc}% sukses). ${crosses >= 3 ? 'Cocok wing-play dominan.' : ''}` });
            }

            // Possession
            if (possWon > 0 && possLost > 0) {
                const ratio = (possWon / possLost).toFixed(2);
                if (parseFloat(ratio) >= 1.1) {
                    insights.push({ type: 'strength', icon: '&#128737;', text: `Ball security bagus (won ${possWon.toFixed(1)} vs lost ${possLost.toFixed(1)}). Aman dalam possession.` });
                } else if (possLost >= 10) {
                    insights.push({ type: 'weakness', icon: '&#9888;', text: `Turnover tinggi (${possLost.toFixed(1)} lost/90). ${pos.includes('W') || pos.includes('F') ? 'Wajar untuk attacker, tapi tetap perlu hati-hati.' : 'Perlu improve decision making.'}` });
                }
            }

            // Defensive
            const isDef = pos.includes('D') || pos.includes('DM');
            if (isDef) {
                if (hdrsW >= 3) {
                    insights.push({ type: 'strength', icon: '&#128170;', text: `Dominasi udara (${hdrsW.toFixed(1)} headers won/90). Ancaman set-piece & solid defensif.` });
                }
                if (interceptions >= 2.5) {
                    insights.push({ type: 'strength', icon: '&#128065;', text: `Game reading bagus (${interceptions.toFixed(1)} int/90). Positioning & anticipation strong.` });
                }
                if (tackles > 0 && tackleRate >= 75) {
                    insights.push({ type: 'strength', icon: '&#128737;', text: `Tackling efisien (${tackles.toFixed(1)}/90, ${tackleRate.toFixed(0)}% sukses). Reliable dalam duel.` });
                }
            }

            // Pressing
            if (presC >= 3) {
                insights.push({ type: 'strength', icon: '&#128293;', text: `Pressing efektif (${presC.toFixed(1)} sukses/90). Kontribusi recovery bola tinggi.` });
            }

            // Man of the Match
            if (mom > 0) {
                const momRate = ((mom / apps) * 100).toFixed(1);
                insights.push({ type: 'strength', icon: '&#11088;', text: `${mom}x MoM (${momRate}%). Sering jadi game changer!` });
            }

            return insights;
        }

        function displayInsights(insights) {
            let html = '';
            insights.forEach(insight => {
                html += `<li class="insight-item ${insight.type}">${insight.icon} ${insight.text}</li>`;
            });
            document.getElementById('insightsList').innerHTML = html;
        }

        function calculateEffectiveness(p) {
            const avgRat = parseFloat(findAttribute(p, ['Avg Rat', 'Rating', 'AvRat', 'Average Rating'])) || 0;
            const pos = (findAttribute(p, ['Position', 'Pos']) || '').toUpperCase();
            const apps = parseInt(findAttribute(p, ['Appearances', 'Apps'])) || 0;
            
            // Core stats
            const goals = parseInt(findAttribute(p, ['Goals'])) || 0;
            const assists = parseInt(findAttribute(p, ['Assists'])) || 0;
            const chCreated = parseFloat(findAttribute(p, ['Ch C/90'])) || 0;
            const xg90 = parseFloat(findAttribute(p, ['xG/90'])) || 0;
            const xa90 = parseFloat(findAttribute(p, ['xA/90'])) || 0;
            const tackles = parseFloat(findAttribute(p, ['Tck/90'])) || 0;
            const interceptions = parseFloat(findAttribute(p, ['Int/90'])) || 0;
            const aerials = parseFloat(findAttribute(p, ['Hdrs W/90'])) || 0;
            const possWon = parseFloat(findAttribute(p, ['Poss Won/90'])) || 0;
            const possLost = parseFloat(findAttribute(p, ['Poss Lost/90'])) || 0;
            const distance = parseFloat(findAttribute(p, ['Dist/90'])) || 0;
            
            // GK stats
            const conceded90 = parseFloat(findAttribute(p, ['All/90'])) || 0;
            const xgp90 = parseFloat(findAttribute(p, ['xGP/90'])) || 0;
            const svPerc = parseFloat(findAttribute(p, ['Sv %'])) || 0;
            const cln90 = parseFloat(findAttribute(p, ['Cln/90'])) || 0;
            
            let score = 0;
            
            // Base: Average Rating (max 2.5 points) - More generous
            if (avgRat >= 7.5) score += 2.5;
            else if (avgRat >= 7.2) score += 2.2;
            else if (avgRat >= 7.0) score += 2.0;
            else if (avgRat >= 6.8) score += 1.8;
            else if (avgRat >= 6.5) score += 1.6;
            else if (avgRat >= 6.3) score += 1.4;
            else if (avgRat >= 6.0) score += 1.2;
            else if (avgRat >= 5.8) score += 1.0;
            else if (avgRat >= 5.5) score += 0.8;
            else if (avgRat > 0) score += 0.5;
            
            // Position-specific scoring (max 2.5 points)
            const isGK = pos.includes('GK');
            const isDefender = pos.includes('D') || pos.includes('CB') || pos.includes('B');
            const isDM = pos.includes('DM');
            const isMidfielder = pos.includes('M') && !isDM;
            const isAttacker = pos.includes('ST') || pos.includes('CF') || pos.includes('W') || pos.includes('AM');
            
            if (isGK) {
                // GK: Clean sheets + xG prevention + save %
                let gkScore = 0;
                if (conceded90 > 0) {
                    if (conceded90 <= 0.8) gkScore += 1.0;
                    else if (conceded90 <= 1.0) gkScore += 0.8;
                    else if (conceded90 <= 1.2) gkScore += 0.6;
                    else if (conceded90 <= 1.5) gkScore += 0.3;
                }
                if (xgp90 >= 0.2) gkScore += 0.8;
                else if (xgp90 >= 0.1) gkScore += 0.5;
                else if (xgp90 >= 0) gkScore += 0.2;
                
                if (svPerc >= 75) gkScore += 0.7;
                else if (svPerc >= 70) gkScore += 0.5;
                else if (svPerc >= 65) gkScore += 0.3;
                
                score += Math.min(gkScore, 2.5);
                
            } else if (isAttacker) {
                // Attacker: Goals + Assists + xG + Creativity
                let attScore = 0;
                
                // Goals contribution
                if (apps > 0) {
                    const goalsPerGame = goals / apps;
                    if (goalsPerGame >= 0.5) attScore += 1.0;
                    else if (goalsPerGame >= 0.3) attScore += 0.7;
                    else if (goalsPerGame >= 0.15) attScore += 0.4;
                    else if (goals > 0) attScore += 0.2;
                }
                
                // xG/90
                if (xg90 >= 0.5) attScore += 0.7;
                else if (xg90 >= 0.3) attScore += 0.5;
                else if (xg90 >= 0.15) attScore += 0.3;
                
                // Assists/Creativity
                if (apps > 0) {
                    const assistsPerGame = assists / apps;
                    if (assistsPerGame >= 0.3) attScore += 0.5;
                    else if (assistsPerGame >= 0.15) attScore += 0.3;
                    else if (assists > 0) attScore += 0.1;
                }
                
                if (chCreated >= 2.0) attScore += 0.3;
                else if (chCreated >= 1.0) attScore += 0.2;
                
                score += Math.min(attScore, 2.5);
                
            } else if (isMidfielder) {
                // Midfielder: Balanced - creativity, possession, work rate
                let midScore = 0;
                
                // Creativity
                if (chCreated >= 2.0) midScore += 0.8;
                else if (chCreated >= 1.0) midScore += 0.5;
                else if (chCreated >= 0.5) midScore += 0.3;
                
                if (xa90 >= 0.2) midScore += 0.5;
                else if (xa90 >= 0.1) midScore += 0.3;
                
                // Possession quality
                if (possWon > 0 && possLost > 0) {
                    const ratio = possWon / possLost;
                    if (ratio >= 1.2) midScore += 0.6;
                    else if (ratio >= 1.0) midScore += 0.4;
                    else if (ratio >= 0.8) midScore += 0.2;
                }
                
                // Work rate
                if (distance >= 11) midScore += 0.4;
                else if (distance >= 10) midScore += 0.2;
                
                // Goals/Assists bonus
                if (apps > 0 && (goals + assists) / apps >= 0.2) midScore += 0.2;
                
                score += Math.min(midScore, 2.5);
                
            } else if (isDM || isDefender) {
                // Defender/DM: Defensive actions + possession + aerials
                let defScore = 0;
                
                // Defensive actions
                if (tackles >= 2.5) defScore += 0.6;
                else if (tackles >= 1.5) defScore += 0.4;
                else if (tackles >= 0.8) defScore += 0.2;
                
                if (interceptions >= 2.5) defScore += 0.7;
                else if (interceptions >= 1.5) defScore += 0.5;
                else if (interceptions >= 0.8) defScore += 0.3;
                
                if (aerials >= 3.5) defScore += 0.5;
                else if (aerials >= 2.5) defScore += 0.3;
                else if (aerials >= 1.5) defScore += 0.2;
                
                // Possession (ball-playing ability)
                if (possWon > 0 && possLost > 0) {
                    const ratio = possWon / possLost;
                    if (ratio >= 1.2) defScore += 0.5;
                    else if (ratio >= 1.0) defScore += 0.3;
                    else if (ratio >= 0.8) defScore += 0.1;
                }
                
                // Clean contribution (bonus for goals/assists from defender)
                if (apps > 0 && (goals + assists) > 0) {
                    defScore += 0.2;
                }
                
                score += Math.min(defScore, 2.5);
            }
            
            return Math.min(score, 5);
        }

        function calculateEffectivenessWithBreakdown(p) {
            const avgRat = parseFloat(findAttribute(p, ['Avg Rat', 'Rating', 'AvRat', 'Average Rating'])) || 0;
            const pos = (findAttribute(p, ['Position', 'Pos']) || '').toUpperCase();
            const apps = parseInt(findAttribute(p, ['Appearances', 'Apps'])) || 0;
            
            // Core stats
            const goals = parseInt(findAttribute(p, ['Goals'])) || 0;
            const assists = parseInt(findAttribute(p, ['Assists'])) || 0;
            const chCreated = parseFloat(findAttribute(p, ['Ch C/90'])) || 0;
            const xg90 = parseFloat(findAttribute(p, ['xG/90'])) || 0;
            const xa90 = parseFloat(findAttribute(p, ['xA/90'])) || 0;
            const tackles = parseFloat(findAttribute(p, ['Tck/90'])) || 0;
            const interceptions = parseFloat(findAttribute(p, ['Int/90'])) || 0;
            const aerials = parseFloat(findAttribute(p, ['Hdrs W/90'])) || 0;
            const possWon = parseFloat(findAttribute(p, ['Poss Won/90'])) || 0;
            const possLost = parseFloat(findAttribute(p, ['Poss Lost/90'])) || 0;
            const distance = parseFloat(findAttribute(p, ['Dist/90'])) || 0;
            
            // GK stats
            const conceded90 = parseFloat(findAttribute(p, ['All/90'])) || 0;
            const xgp90 = parseFloat(findAttribute(p, ['xGP/90'])) || 0;
            const svPerc = parseFloat(findAttribute(p, ['Sv %'])) || 0;
            
            let breakdown = {
                baseScore: 0,
                baseDetail: '',
                positionScore: 0,
                positionDetail: [],
                total: 0,
                position: pos
            };
            
            // Base: Average Rating
            if (avgRat >= 7.5) { breakdown.baseScore = 2.5; breakdown.baseDetail = 'Avg Rating 7.5+ (Elite)'; }
            else if (avgRat >= 7.2) { breakdown.baseScore = 2.2; breakdown.baseDetail = 'Avg Rating 7.2-7.5 (Excellent)'; }
            else if (avgRat >= 7.0) { breakdown.baseScore = 2.0; breakdown.baseDetail = 'Avg Rating 7.0-7.2 (Very Good)'; }
            else if (avgRat >= 6.8) { breakdown.baseScore = 1.8; breakdown.baseDetail = 'Avg Rating 6.8-7.0 (Good+)'; }
            else if (avgRat >= 6.5) { breakdown.baseScore = 1.6; breakdown.baseDetail = 'Avg Rating 6.5-6.8 (Good)'; }
            else if (avgRat >= 6.3) { breakdown.baseScore = 1.4; breakdown.baseDetail = 'Avg Rating 6.3-6.5 (Above Average)'; }
            else if (avgRat >= 6.0) { breakdown.baseScore = 1.2; breakdown.baseDetail = 'Avg Rating 6.0-6.3 (Average)'; }
            else if (avgRat >= 5.8) { breakdown.baseScore = 1.0; breakdown.baseDetail = 'Avg Rating 5.8-6.0 (Below Average)'; }
            else if (avgRat >= 5.5) { breakdown.baseScore = 0.8; breakdown.baseDetail = 'Avg Rating 5.5-5.8 (Poor)'; }
            else if (avgRat > 0) { breakdown.baseScore = 0.5; breakdown.baseDetail = `Avg Rating ${avgRat.toFixed(2)} (Very Poor)`; }
            else { breakdown.baseDetail = 'No Avg Rating data'; }
            
            // Position-specific scoring
            const isGK = pos.includes('GK');
            const isDefender = pos.includes('D') || pos.includes('CB') || pos.includes('B');
            const isDM = pos.includes('DM');
            const isMidfielder = pos.includes('M') && !isDM;
            const isAttacker = pos.includes('ST') || pos.includes('CF') || pos.includes('W') || pos.includes('AM');
            
            if (isGK) {
                let gkScore = 0;
                if (conceded90 > 0) {
                    if (conceded90 <= 0.8) { gkScore += 1.0; breakdown.positionDetail.push(`+1.0: Goals Conceded =0.8 (${conceded90.toFixed(2)})`); }
                    else if (conceded90 <= 1.0) { gkScore += 0.8; breakdown.positionDetail.push(`+0.8: Goals Conceded ~1.0 (${conceded90.toFixed(2)})`); }
                    else if (conceded90 <= 1.2) { gkScore += 0.6; breakdown.positionDetail.push(`+0.6: Goals Conceded ~1.2 (${conceded90.toFixed(2)})`); }
                    else if (conceded90 <= 1.5) { gkScore += 0.3; breakdown.positionDetail.push(`+0.3: Goals Conceded ~1.5 (${conceded90.toFixed(2)})`); }
                    else { breakdown.positionDetail.push(`+0.0: Goals Conceded high (${conceded90.toFixed(2)})`); }
                }
                if (xgp90 >= 0.2) { gkScore += 0.8; breakdown.positionDetail.push(`+0.8: xG Prevented excellent (${xgp90.toFixed(2)})`); }
                else if (xgp90 >= 0.1) { gkScore += 0.5; breakdown.positionDetail.push(`+0.5: xG Prevented good (${xgp90.toFixed(2)})`); }
                else if (xgp90 >= 0) { gkScore += 0.2; breakdown.positionDetail.push(`+0.2: xG Prevented neutral (${xgp90.toFixed(2)})`); }
                else { breakdown.positionDetail.push(`+0.0: xG Prevented negative (${xgp90.toFixed(2)})`); }
                
                if (svPerc >= 75) { gkScore += 0.7; breakdown.positionDetail.push(`+0.7: Save % excellent (${svPerc.toFixed(0)}%)`); }
                else if (svPerc >= 70) { gkScore += 0.5; breakdown.positionDetail.push(`+0.5: Save % good (${svPerc.toFixed(0)}%)`); }
                else if (svPerc >= 65) { gkScore += 0.3; breakdown.positionDetail.push(`+0.3: Save % average (${svPerc.toFixed(0)}%)`); }
                else if (svPerc > 0) { breakdown.positionDetail.push(`+0.0: Save % low (${svPerc.toFixed(0)}%)`); }
                
                breakdown.positionScore = Math.min(gkScore, 2.5);
                
            } else if (isAttacker) {
                let attScore = 0;
                
                if (apps > 0) {
                    const goalsPerGame = goals / apps;
                    if (goalsPerGame >= 0.5) { attScore += 1.0; breakdown.positionDetail.push(`+1.0: Goals/game excellent (${goalsPerGame.toFixed(2)})`); }
                    else if (goalsPerGame >= 0.3) { attScore += 0.7; breakdown.positionDetail.push(`+0.7: Goals/game good (${goalsPerGame.toFixed(2)})`); }
                    else if (goalsPerGame >= 0.15) { attScore += 0.4; breakdown.positionDetail.push(`+0.4: Goals/game moderate (${goalsPerGame.toFixed(2)})`); }
                    else if (goals > 0) { attScore += 0.2; breakdown.positionDetail.push(`+0.2: Some goals (${goals})`); }
                    else { breakdown.positionDetail.push(`+0.0: No goals`); }
                }
                
                if (xg90 >= 0.5) { attScore += 0.7; breakdown.positionDetail.push(`+0.7: xG/90 excellent (${xg90.toFixed(2)})`); }
                else if (xg90 >= 0.3) { attScore += 0.5; breakdown.positionDetail.push(`+0.5: xG/90 good (${xg90.toFixed(2)})`); }
                else if (xg90 >= 0.15) { attScore += 0.3; breakdown.positionDetail.push(`+0.3: xG/90 moderate (${xg90.toFixed(2)})`); }
                else if (xg90 > 0) { breakdown.positionDetail.push(`+0.0: xG/90 low (${xg90.toFixed(2)})`); }
                
                if (apps > 0 && assists > 0) {
                    const assistsPerGame = assists / apps;
                    if (assistsPerGame >= 0.3) { attScore += 0.5; breakdown.positionDetail.push(`+0.5: Assists/game excellent (${assistsPerGame.toFixed(2)})`); }
                    else if (assistsPerGame >= 0.15) { attScore += 0.3; breakdown.positionDetail.push(`+0.3: Assists/game good (${assistsPerGame.toFixed(2)})`); }
                    else { attScore += 0.1; breakdown.positionDetail.push(`+0.1: Some assists (${assists})`); }
                }
                
                if (chCreated >= 2.0) { attScore += 0.3; breakdown.positionDetail.push(`+0.3: Creativity bonus (${chCreated.toFixed(1)} Ch/90)`); }
                else if (chCreated >= 1.0) { attScore += 0.2; breakdown.positionDetail.push(`+0.2: Some creativity (${chCreated.toFixed(1)} Ch/90)`); }
                
                breakdown.positionScore = Math.min(attScore, 2.5);
                
            } else if (isMidfielder) {
                let midScore = 0;
                
                if (chCreated >= 2.0) { midScore += 0.8; breakdown.positionDetail.push(`+0.8: Creativity excellent (${chCreated.toFixed(1)} Ch/90)`); }
                else if (chCreated >= 1.0) { midScore += 0.5; breakdown.positionDetail.push(`+0.5: Creativity good (${chCreated.toFixed(1)} Ch/90)`); }
                else if (chCreated >= 0.5) { midScore += 0.3; breakdown.positionDetail.push(`+0.3: Some creativity (${chCreated.toFixed(1)} Ch/90)`); }
                
                if (xa90 >= 0.2) { midScore += 0.5; breakdown.positionDetail.push(`+0.5: xA excellent (${xa90.toFixed(2)})`); }
                else if (xa90 >= 0.1) { midScore += 0.3; breakdown.positionDetail.push(`+0.3: xA good (${xa90.toFixed(2)})`); }
                
                if (possWon > 0 && possLost > 0) {
                    const ratio = possWon / possLost;
                    if (ratio >= 1.2) { midScore += 0.6; breakdown.positionDetail.push(`+0.6: Ball security excellent (${ratio.toFixed(2)})`); }
                    else if (ratio >= 1.0) { midScore += 0.4; breakdown.positionDetail.push(`+0.4: Ball security good (${ratio.toFixed(2)})`); }
                    else if (ratio >= 0.8) { midScore += 0.2; breakdown.positionDetail.push(`+0.2: Ball security moderate (${ratio.toFixed(2)})`); }
                }
                
                if (distance >= 11) { midScore += 0.4; breakdown.positionDetail.push(`+0.4: Work rate excellent (${distance.toFixed(1)}km)`); }
                else if (distance >= 10) { midScore += 0.2; breakdown.positionDetail.push(`+0.2: Work rate good (${distance.toFixed(1)}km)`); }
                
                if (apps > 0 && (goals + assists) / apps >= 0.2) { 
                    midScore += 0.2; 
                    breakdown.positionDetail.push(`+0.2: Goal contribution bonus (${goals}G ${assists}A)`); 
                }
                
                breakdown.positionScore = Math.min(midScore, 2.5);
                
            } else if (isDM || isDefender) {
                let defScore = 0;
                
                if (tackles >= 2.5) { defScore += 0.6; breakdown.positionDetail.push(`+0.6: Tackles excellent (${tackles.toFixed(1)}/90)`); }
                else if (tackles >= 1.5) { defScore += 0.4; breakdown.positionDetail.push(`+0.4: Tackles good (${tackles.toFixed(1)}/90)`); }
                else if (tackles >= 0.8) { defScore += 0.2; breakdown.positionDetail.push(`+0.2: Tackles moderate (${tackles.toFixed(1)}/90)`); }
                
                if (interceptions >= 2.5) { defScore += 0.7; breakdown.positionDetail.push(`+0.7: Interceptions excellent (${interceptions.toFixed(1)}/90)`); }
                else if (interceptions >= 1.5) { defScore += 0.5; breakdown.positionDetail.push(`+0.5: Interceptions good (${interceptions.toFixed(1)}/90)`); }
                else if (interceptions >= 0.8) { defScore += 0.3; breakdown.positionDetail.push(`+0.3: Interceptions moderate (${interceptions.toFixed(1)}/90)`); }
                
                if (aerials >= 3.5) { defScore += 0.5; breakdown.positionDetail.push(`+0.5: Aerials dominant (${aerials.toFixed(1)}/90)`); }
                else if (aerials >= 2.5) { defScore += 0.3; breakdown.positionDetail.push(`+0.3: Aerials good (${aerials.toFixed(1)}/90)`); }
                else if (aerials >= 1.5) { defScore += 0.2; breakdown.positionDetail.push(`+0.2: Aerials moderate (${aerials.toFixed(1)}/90)`); }
                
                if (possWon > 0 && possLost > 0) {
                    const ratio = possWon / possLost;
                    if (ratio >= 1.2) { defScore += 0.5; breakdown.positionDetail.push(`+0.5: Ball-playing excellent (${ratio.toFixed(2)})`); }
                    else if (ratio >= 1.0) { defScore += 0.3; breakdown.positionDetail.push(`+0.3: Ball-playing good (${ratio.toFixed(2)})`); }
                    else if (ratio >= 0.8) { defScore += 0.1; breakdown.positionDetail.push(`+0.1: Ball-playing moderate (${ratio.toFixed(2)})`); }
                }
                
                if (apps > 0 && (goals + assists) > 0) {
                    defScore += 0.2;
                    breakdown.positionDetail.push(`+0.2: Attacking bonus (${goals}G ${assists}A)`);
                }
                
                breakdown.positionScore = Math.min(defScore, 2.5);
            }
            
            breakdown.total = Math.min(breakdown.baseScore + breakdown.positionScore, 5);
            return breakdown;
        }

        function displayEffectivenessRating(rating, breakdown) {
            const fullStars = Math.floor(rating);
            const hasHalf = (rating % 1) >= 0.5;
            
            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += '‚òÖ'; // &#11088;
            if (hasHalf) stars += '¬Ω'; // &#189;
            for (let i = fullStars + (hasHalf ? 1 : 0); i < 5; i++) stars += '‚òÜ'; // &#9734;
            document.getElementById('effectivenessStars').textContent = stars;
            
            let text = '';
            if (rating >= 4.5) text = 'Elite Player - Pemain terbaik di posisinya';
            else if (rating >= 4.0) text = 'Excellent - Pemain kunci yang sangat efektif';
            else if (rating >= 3.5) text = 'Very Good - Kontributor solid dan reliable';
            else if (rating >= 3.0) text = 'Good - Pemain rotasi yang berguna';
            else text = 'Developing - Perlu waktu atau penyesuaian role';
            
            document.getElementById('effectivenessText').textContent = `${rating.toFixed(1)}/5.0 - ${text}`;
            
            // Display breakdown explanation
            if (breakdown) {
                let breakdownHTML = '<div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 6px; font-size: 0.9em; color: #2c3e50; border: 1px solid #e1e8ed;">';
                breakdownHTML += '<strong style="color: #2c3e50;">&#128220; Detail Penilaian Rating:</strong><br><br>';
                
                // Base score
                breakdownHTML += `<strong style="color: #2c3e50;">Base Performance:</strong> ${breakdown.baseScore.toFixed(1)}/2.5 poin<br>`;
                breakdownHTML += `<span style="margin-left: 15px; color: #5a6c7d;">‚Ä¢ ${breakdown.baseDetail}</span><br><br>`;
                // Position-specific score
                breakdownHTML += `<strong style="color: #2c3e50;">Kontribusi Spesifik Posisi:</strong> ${breakdown.positionScore.toFixed(1)}/2.5 poin<br>`;
                if (breakdown.positionDetail.length > 0) {
                    breakdown.positionDetail.forEach(detail => {
                        breakdownHTML += `<span style="margin-left: 15px; color: #5a6c7d;">‚Ä¢ ${detail}</span><br>`;
                    });
                } else {
                    breakdownHTML += `<span style="margin-left: 15px; color: #5a6c7d;">‚Ä¢ Tidak ada data metrik posisi</span><br>`;
                }
                
                breakdownHTML += `<br><strong style="color: #2c3e50;">Total Rating: ${breakdown.total.toFixed(1)}/5.0</strong>`;
                breakdownHTML += '</div>';
                
                document.getElementById('effectivenessText').innerHTML += breakdownHTML;
            }
        }

        function displayRecommendations(p, insights, rating) {
            const pos = (findAttribute(p, ['Position', 'Pos']) || '').toUpperCase();
            const bestPos = findAttribute(p, ['Best Pos']) || '';
            const bestRole = findAttribute(p, ['Best Role']) || '';
            const pros = findAttribute(p, ['Pros']) || '';
            const preferredFoot = findAttribute(p, ['Preferred Foot']) || '';
            const age = parseInt(findAttribute(p, ['Age'])) || 0;
            
            // Get key stats for training recommendations
            const avgRat = parseFloat(findAttribute(p, ['Avg Rat'])) || 0;
            const shots = parseFloat(findAttribute(p, ['Shot/90'])) || 0;
            const xg90 = parseFloat(findAttribute(p, ['xG/90'])) || 0;
            const xgShot = parseFloat(findAttribute(p, ['xG/shot'])) || 0;
            const psAcc = parseFloat(findAttribute(p, ['Ps C/90'])) / parseFloat(findAttribute(p, ['Ps A/90'])) * 100 || 0;
            const prPasses = parseFloat(findAttribute(p, ['Pr passes/90'])) || 0;
            const chCreated = parseFloat(findAttribute(p, ['Ch C/90'])) || 0;
            const tackles = parseFloat(findAttribute(p, ['Tck/90'])) || 0;
            const interceptions = parseFloat(findAttribute(p, ['Int/90'])) || 0;
            const dribbles = parseFloat(findAttribute(p, ['Drb/90'])) || 0;
            const aerials = parseFloat(findAttribute(p, ['Hdrs W/90'])) || 0;
            const distance = parseFloat(findAttribute(p, ['Dist/90'])) || 0;
            const sprints = parseFloat(findAttribute(p, ['Sprints/90'])) || 0;
            
            let html = '<div style="padding: 20px;">';
            
            // Player Summary
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">`;
            html += `<h3 style="margin: 0 0 10px 0; font-size: 1.3em;">&#128100; Profil Pemain</h3>`;
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">`;
            html += `<div><strong>Posisi Natural:</strong> ${pos}</div>`;
            if (bestPos) html += `<div><strong>Best Position:</strong> ${bestPos}</div>`;
            if (bestRole) html += `<div><strong>Best Role:</strong> ${bestRole}</div>`;
            if (age > 0) html += `<div><strong>Umur:</strong> ${age} tahun</div>`;
            if (preferredFoot) html += `<div><strong>Kaki Dominan:</strong> ${preferredFoot}</div>`;
            if (pros) html += `<div><strong>Kelebihan:</strong> ${pros}</div>`;
            html += `</div></div>`;
            
            // Overall Assessment
            html += `<div class="insight-item" style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 3px solid #3498db;">`;
            html += `<strong>&#128736; Penilaian Keseluruhan:</strong><br><br>`;
            
            if (rating >= 4.0) {
                html += `<span style="color: #27ae60; font-size: 1.05em;">&#11088; PEMAIN KUNCI</span> - Wajib starter, performa sangat baik (Rating: ${rating.toFixed(1)}/5.0)<br>`;
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Pemain ini adalah asset penting untuk tim. Fokus training untuk maintain & enhance strengths.<br>`;
            } else if (rating >= 3.5) {
                html += `<span style="color: #27ae60; font-size: 1.05em;">&#9989; STARTER SOLID</span> - Performa konsisten baik (Rating: ${rating.toFixed(1)}/5.0)<br>`;
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Pemain first-choice dengan sedikit area untuk improvement.<br>`;
            } else if (rating >= 3.0) {
                html += `<span style="color: #3498db; font-size: 1.05em;">&#128260; ROTASI/BACKUP</span> - Performa standar (Rating: ${rating.toFixed(1)}/5.0)<br>`;
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Squad player yang berguna. Training focus untuk develop jadi starter.<br>`;
            } else if (rating >= 2.5) {
                html += `<span style="color: #f39c12; font-size: 1.05em;">&#9888; PERLU DEVELOPMENT</span> - Performa di bawah standar (Rating: ${rating.toFixed(1)}/5.0)<br>`;
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Butuh intensive training atau loan untuk match experience.<br>`;
            } else {
                html += `<span style="color: #e74c3c; font-size: 1.05em;">&#128680; CONCERN</span> - Performa kurang (Rating: ${rating.toFixed(1)}/5.0)<br>`;
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; Pertimbangkan role change, loan, atau development di level lebih rendah.<br>`;
            }
            html += `</div>`;
            
            // Training Recommendations
            html += `<div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #3498db;">`;
            html += `<h3 style="color: #3498db; margin-top: 0;">&#127891; Rekomendasi Training Spesifik</h3>`;
            
            // Position-specific training
            const isGK = pos.includes('GK');
            const isDefender = pos.includes('D') || pos.includes('CB') || pos.includes('B');
            const isDM = pos.includes('DM');
            const isMidfielder = pos.includes('M') && !isDM;
            const isAttacker = pos.includes('ST') || pos.includes('CF') || pos.includes('W') || pos.includes('AM');
            
            let trainingPriorities = [];
            
            if (isGK) {
                // GK Training
                const conceded90 = parseFloat(findAttribute(p, ['All/90'])) || 0;
                const svPerc = parseFloat(findAttribute(p, ['Sv %'])) || 0;
                const xgp90 = parseFloat(findAttribute(p, ['xGP/90'])) || 0;
                
                if (svPerc < 70 || xgp90 < 0) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Shot-Stopping', detail: 'Reaction saves, handling, positioning drills. Focus pada 1v1 situations.' });
                }
                if (conceded90 > 1.3) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Positioning & Decision Making', detail: 'Angle play, when to come out, organizing defense.' });
                }
                if (psAcc < 70) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Distribution', detail: 'Passing accuracy, throw accuracy, kicking range. Modern GK needs.' });
                }
                trainingPriorities.push({ priority: 'MEDIUM', area: 'Command of Box', detail: 'Claiming crosses, communication dengan defenders, set-piece organization.' });
            } else if (isAttacker) {
                // Attacker Training
                if (xg90 < 0.3 || (shots > 0 && xgShot < 0.12)) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Finishing & Movement', detail: 'Shot placement, finishing dari berbagai angles, off-ball runs untuk get into box.' });
                }
                if (dribbles < 1.5 && pos.includes('W')) {
                    trainingPriorities.push({ priority: 'HIGH', area: '1v1 Dribbling', detail: 'Take-ons, change of pace, body feints. Winger butuh beat defenders.' });
                }
                if (chCreated < 1.5 && (pos.includes('AM') || pos.includes('ST'))) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Link-up Play & Vision', detail: 'Key passes, through balls, combination play dengan teammates.' });
                }
                if (sprints < 20) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Pace & Acceleration', detail: 'Sprint drills, explosive starts, counter-attack training.' });
                }
                if (aerials < 2 && pros.toLowerCase().includes('heading')) {
                    trainingPriorities.push({ priority: 'LOW', area: 'Aerial Ability (Maximize Pros)', detail: 'Heading accuracy, timing jumps, attacking set-pieces.' });
                }
            } else if (isMidfielder) {
                // Midfielder Training
                if (psAcc < 80) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Passing Accuracy', detail: 'Short passing drills, under pressure scenarios, first touch improvement.' });
                }
                if (prPasses < 4 && !isDM) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Progressive Passing', detail: 'Line-breaking passes, vision training, switch of play.' });
                }
                if (chCreated < 1.0 && pos.includes('AM')) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Creativity', detail: 'Final ball, key passes, weight of pass training.' });
                }
                if (distance < 10.5) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Stamina & Work Rate', detail: 'Endurance training, box-to-box runs, maintain intensity 90 minutes.' });
                }
                if (tackles < 1.5 && isDM) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Defensive Positioning & Tackling', detail: 'Tackle timing, reading game, intercept passing lanes.' });
                }
            } else if (isDefender) {
                // Defender Training
                if (interceptions < 1.5) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Reading the Game', detail: 'Anticipation drills, positioning awareness, cutting passing lanes.' });
                }
                if (tackles > 0 && parseFloat(findAttribute(p, ['Tck R'])) < 70) {
                    trainingPriorities.push({ priority: 'HIGH', area: 'Tackle Timing & Success', detail: 'Clean tackling technique, reduce fouls, stay on feet.' });
                }
                if (aerials < 2.5) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Aerial Dominance', detail: 'Heading clearances, winning duels, attacking corners.' });
                }
                if (psAcc < 85 && (pos.includes('CB') || pos.includes('B'))) {
                    trainingPriorities.push({ priority: 'MEDIUM', area: 'Ball-Playing (Modern Defender)', detail: 'Passing out from back, composure under press, progressive passes.' });
                }
                if (sprints < 15 && pos.includes('B')) {
                    trainingPriorities.push({ priority: 'LOW', area: 'Recovery Speed', detail: 'Sprint endurance, tracking back runs, defensive transitions.' });
                }
            }
            
            // General training based on pros
            if (pros) {
                const prosLower = pros.toLowerCase();
                if (prosLower.includes('pace') || prosLower.includes('speed')) {
                    trainingPriorities.push({ priority: 'LOW', area: `Maximize: ${pros}`, detail: 'Maintain explosive speed dengan sprint drills & agility work.' });
                } else if (prosLower.includes('passing')) {
                    trainingPriorities.push({ priority: 'LOW', area: `Maximize: ${pros}`, detail: 'Advanced passing scenarios, dikombinasi vision & through balls.' });
                } else if (prosLower.includes('heading')) {
                    trainingPriorities.push({ priority: 'LOW', area: `Maximize: ${pros}`, detail: 'Aerial training - both defensive & attacking set-pieces.' });
                }
            }
            
            // Physical conditioning based on age
            if (age > 0) {
                if (age <= 21) {
                    trainingPriorities.push({ priority: 'LOW', area: 'Youth Development', detail: 'Physical conditioning, technique refinement, match experience penting.' });
                } else if (age >= 30) {
                    trainingPriorities.push({ priority: 'LOW', area: 'Veteran Maintenance', detail: 'Recovery management, injury prevention, maintain sharpness tanpa overtraining.' });
                }
            }
            
            // Sort and display priorities
            const priorityOrder = { 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
            trainingPriorities.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            
            trainingPriorities.forEach(item => {
                let color = item.priority === 'HIGH' ? '#e74c3c' : item.priority === 'MEDIUM' ? '#f39c12' : '#3498db';
                html += `<div style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid ${color};">`;
                html += `<strong style="color: ${color};">[${item.priority}]</strong> <strong>${item.area}</strong><br>`;
                html += `<span style="color: #7f8c8d; margin-left: 20px; font-size: 0.9em;">&bull; ${item.detail}</span>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            
            // Tactical Usage
            html += `<div style="background: #e8f4f8; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 3px solid #3498db;">`;
            html += `<strong style="color: #3498db;">&#9881; Rekomendasi Penggunaan Taktis:</strong><br><br>`;
            
            if (bestRole) {
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Role Optimal:</strong> ${bestRole}`;
                if (bestPos) html += ` di posisi ${bestPos}`;
                html += `<br>`;
            }
            
            if (rating >= 3.5) {
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Status:</strong> First-choice starter untuk match penting.<br>`;
            } else if (rating >= 3.0) {
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Status:</strong> Rotasi player, starter untuk cup games atau vs weaker opposition.<br>`;
            } else {
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Status:</strong> Backup option. Consider loan untuk regular game time & development.<br>`;
            }
            
            if (pros) {
                html += `&nbsp;&nbsp;&nbsp;&nbsp;&bull; <strong>Exploit Strengths:</strong> Tactics harus utilize ${pros.toLowerCase()}.<br>`;
            }
            
            html += `</div>`;
            
            html += '</div>';
            
            document.getElementById('recommendations').innerHTML = html;
        }
        
        // Try Both Normalization Modes: show side-by-side comparison
        function tryBothNormalizationModes() {
            if (!playersData || playersData.length === 0) {
                alert('Tidak ada data pemain. Silakan upload file terlebih dahulu.');
                return;
            }
            
            // Make sure recommendation panel is open
            const recDiv = document.getElementById('teamTacticalRecommendation');
            if (recDiv && recDiv.classList.contains('hidden')) {
                // Open the panel first
                showTeamTacticalRecommendation();
            }
            
            // Run analysis for both modes
            const analysisCategory = analyzeSquadStrengths({ mode: 'category' });
            const analysisPerMetric = analyzeSquadStrengths({ mode: 'perMetric' });
            
            // Build comparison table
            const metrics = ['attacking','creativity','possession','pressing','defensive','physical'];
            const labels = {
                attacking: 'Attacking',
                creativity: 'Creativity',
                possession: 'Possession',
                pressing: 'Pressing',
                defensive: 'Defensive',
                physical: 'Physical'
            };
            
            let table = `<div id="normCompareTable" style="margin-bottom:18px; padding:15px; background:#f9f9f9; border-radius:6px; border:1px solid #ddd;">
                <b style="color:#2c3e50;">üìä Perbandingan Skor Kekuatan Tim (Category vs Per-metric):</b>
                <table style="margin-top:10px; border-collapse:collapse; width:100%; max-width:600px; font-size:0.95em;">
                    <thead>
                        <tr style='background:#3498db; color:white;'>
                            <th style='padding:8px 12px; border:1px solid #ccc; text-align:left;'>Kategori</th>
                            <th style='padding:8px 12px; border:1px solid #ccc; text-align:center;'>Category</th>
                            <th style='padding:8px 12px; border:1px solid #ccc; text-align:center;'>Per-metric</th>
                            <th style='padding:8px 12px; border:1px solid #ccc; text-align:center;'>Œî</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            metrics.forEach(m => {
                const catScore = analysisCategory.strengths[m];
                const perScore = analysisPerMetric.strengths[m];
                const diff = perScore - catScore;
                const diffColor = Math.abs(diff) < 0.5 ? '#95a5a6' : (diff > 0 ? '#27ae60' : '#e74c3c');
                table += `<tr style='background:white;'>
                    <td style='padding:8px 12px; border:1px solid #ddd;'><strong>${labels[m]}</strong></td>
                    <td style='padding:8px 12px; border:1px solid #ddd; text-align:center; font-weight:600;'>${catScore.toFixed(2)}</td>
                    <td style='padding:8px 12px; border:1px solid #ddd; text-align:center; font-weight:600;'>${perScore.toFixed(2)}</td>
                    <td style='padding:8px 12px; border:1px solid #ddd; text-align:center; font-weight:600; color:${diffColor};'>${diff >= 0 ? '+' : ''}${diff.toFixed(2)}</td>
                </tr>`;
            });
            
            table += `</tbody></table>
                <p style="margin-top:10px; font-size:0.85em; color:#7f8c8d; font-style:italic;">
                    üí° <strong>Œî</strong> = Selisih (Per-metric - Category). Nilai positif = Per-metric lebih tinggi.
                </p>
            </div>`;
            
            // Show table in the dedicated container (below Try Both button)
            const container = document.getElementById('normCompareTableContainer');
            if (container) {
                // Remove previous comparison table if exists
                const prev = document.getElementById('normCompareTable');
                if (prev) prev.remove();
                // Insert table in container
                container.innerHTML = table;
                // Scroll to the comparison table
                setTimeout(() => {
                    const compareTable = document.getElementById('normCompareTable');
                    if (compareTable) {
                        compareTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        // Helper function to get quality labels for export
        function getPassAccuracyLabel(passAcc, pos) {
            const isGK = pos.includes('GK');
            const isCB = pos.includes('CB') || (pos.includes('D') && pos.includes('C'));
            const isFB = pos.includes('B') || pos.includes('WB');
            const isDM = pos.includes('DM') || pos.includes('CDM');
            const isCM = pos.includes('CM') || (pos.includes('M') && !pos.includes('A') && !pos.includes('D'));
            const isAM = pos.includes('AM') || pos.includes('CAM');
            const isWinger = pos.includes('W') || pos.includes('AML') || pos.includes('AMR');
            const isStriker = pos.includes('ST') || pos.includes('CF');

            if (isGK) {
                if (passAcc >= 75) return 'EXCELLENT';
                if (passAcc >= 65) return 'GOOD';
                return 'TRADITIONAL GK';
            } else if (isCB || isDM) {
                if (passAcc >= 90) return 'ELITE';
                if (passAcc >= 85) return 'EXCELLENT';
                if (passAcc >= 80) return 'GOOD';
                return 'BELOW PAR';
            } else if (isFB) {
                if (passAcc >= 80) return 'EXCELLENT';
                if (passAcc >= 75) return 'GOOD';
                return 'TRADITIONAL FB';
            } else if (isCM || isAM) {
                if (passAcc >= 85) return 'ELITE';
                if (passAcc >= 80) return 'EXCELLENT';
                if (passAcc >= 75) return 'OK';
                return 'CONCERN';
            } else if (isWinger || isStriker) {
                if (passAcc >= 75) return 'BONUS';
                if (passAcc >= 70) return 'STANDARD';
                return 'DIRECT PLAYER';
            }
            
            if (passAcc >= 85) return 'ELITE';
            if (passAcc >= 80) return 'GOOD';
            if (passAcc >= 75) return 'AVERAGE';
            return 'POOR';
        }

        function getProgressivePassesLabel(prPasses, pos) {
            const isGK = pos.includes('GK');
            const isCB = pos.includes('CB') || (pos.includes('D') && pos.includes('C'));
            const isFB = pos.includes('B') || pos.includes('WB');
            const isDM = pos.includes('DM');
            const isCM = pos.includes('CM') || (pos.includes('M') && !pos.includes('A') && !pos.includes('D'));
            const isAM = pos.includes('AM');

            if (isGK) {
                if (prPasses >= 3) return 'ELITE';
                if (prPasses >= 2) return 'EXCELLENT';
                if (prPasses >= 1) return 'GOOD';
                return 'TRADITIONAL';
            } else if (isCB) {
                if (prPasses >= 5) return 'ELITE';
                if (prPasses >= 3.5) return 'EXCELLENT';
                if (prPasses >= 2.5) return 'GOOD';
                return 'BELOW AVERAGE';
            } else if (isFB) {
                if (prPasses >= 4) return 'ELITE';
                if (prPasses >= 3) return 'EXCELLENT';
                if (prPasses >= 2) return 'GOOD';
                return 'AVERAGE';
            } else if (isDM) {
                if (prPasses >= 8) return 'ELITE';
                if (prPasses >= 6) return 'EXCELLENT';
                if (prPasses >= 4) return 'GOOD';
                return 'BELOW AVERAGE';
            } else if (isCM) {
                if (prPasses >= 7) return 'ELITE';
                if (prPasses >= 5) return 'EXCELLENT';
                if (prPasses >= 3.5) return 'GOOD';
                return 'AVERAGE';
            } else if (isAM) {
                if (prPasses >= 6) return 'ELITE';
                if (prPasses >= 4.5) return 'EXCELLENT';
                if (prPasses >= 3) return 'GOOD';
                return 'AVERAGE';
            }
            
            if (prPasses >= 5) return 'EXCELLENT';
            if (prPasses >= 3) return 'GOOD';
            if (prPasses >= 1.5) return 'AVERAGE';
            return 'POOR';
        }

        function getCreativityLabel(chCreated, keyPasses, pos) {
            const isAM = pos.includes('AM');
            const isWinger = pos.includes('W') || pos.includes('AML') || pos.includes('AMR');
            const isFB = pos.includes('B') || pos.includes('WB');
            const isCM = pos.includes('CM');

            if (isAM) {
                if (chCreated >= 2.5 || keyPasses >= 2.5) return 'ELITE';
                if (chCreated >= 2 || keyPasses >= 2) return 'EXCELLENT';
                if (chCreated >= 1.5 || keyPasses >= 1.5) return 'GOOD';
                return 'BELOW PAR';
            } else if (isWinger) {
                if (chCreated >= 2.5 || keyPasses >= 2.5) return 'ELITE';
                if (chCreated >= 2 || keyPasses >= 2) return 'EXCELLENT';
                if (chCreated >= 1.2 || keyPasses >= 1.2) return 'GOOD';
                return 'AVERAGE';
            } else if (isFB) {
                if (chCreated >= 1.5 || keyPasses >= 1.5) return 'ELITE';
                if (chCreated >= 1 || keyPasses >= 1) return 'EXCELLENT';
                if (chCreated >= 0.6 || keyPasses >= 0.6) return 'GOOD';
                return 'DEFENSIVE FB';
            } else if (isCM) {
                if (chCreated >= 2 || keyPasses >= 2) return 'ELITE';
                if (chCreated >= 1.5 || keyPasses >= 1.5) return 'EXCELLENT';
                if (chCreated >= 1 || keyPasses >= 1) return 'GOOD';
                return 'AVERAGE';
            }
            
            if (chCreated >= 1.5 || keyPasses >= 1.5) return 'EXCELLENT';
            if (chCreated >= 1 || keyPasses >= 1) return 'GOOD';
            if (chCreated >= 0.5 || keyPasses >= 0.5) return 'AVERAGE';
            return 'POOR';
        }

        function getBallSecurityLabel(possWon, possLost, pos) {
            if (!possWon || !possLost) return 'N/A';
            const ratio = parseFloat(possWon) / parseFloat(possLost);
            
            if (ratio >= 1.2) return 'EXCELLENT';
            if (ratio >= 1.0) return 'GOOD';
            if (ratio >= 0.8) return 'AVERAGE';
            return 'POOR';
        }

        function getPressingLabel(presC, presA, pos) {
            if (!presC || !presA) return 'N/A';
            const presSucc = (parseFloat(presC) / parseFloat(presA)) * 100;
            const presAVal = parseFloat(presA);
            
            // Check volume first
            let volumeLabel = '';
            if (presAVal >= 20) {
                volumeLabel = 'HIGH VOLUME PRESSER';
            } else if (presAVal >= 10) {
                volumeLabel = 'MODERATE PRESSING';
            } else if (presAVal < 5) {
                volumeLabel = 'LOW PRESSING';
            }
            
            // Success rate labels (based on frontend logic)
            let qualityLabel = '';
            if (presSucc >= 40) {
                qualityLabel = 'ELITE PRESSER';
            } else if (presSucc >= 35) {
                qualityLabel = 'EXCELLENT';
            } else if (presSucc >= 30) {
                qualityLabel = 'GOOD';
            } else if (presSucc >= 25) {
                qualityLabel = 'AVERAGE';
            } else {
                qualityLabel = 'INEFFICIENT';
            }
            
            // Combine both if high volume
            if (presAVal >= 20) {
                return `${qualityLabel} - ${volumeLabel}`;
            } else if (presAVal < 5) {
                return volumeLabel;
            }
            
            return qualityLabel;
        }

        function getShootingLabel(xG90, shots, pos) {
            const isStriker = pos.includes('ST') || pos.includes('CF');
            const isWinger = pos.includes('W') || pos.includes('AML') || pos.includes('AMR');
            const isAM = pos.includes('AM');

            // Use same thresholds as analyzeAttacking to keep labels identical
            const xGVal = parseFloat(xG90) || 0;

            if (isStriker) {
                // analyzeAttacking uses 0.7/0.5/0.35 for striker
                if (xGVal >= 0.7) return 'ELITE';
                if (xGVal >= 0.5) return 'EXCELLENT';
                if (xGVal >= 0.35) return 'GOOD';
                return 'BELOW AVERAGE';
            } else if (isWinger || isAM) {
                // wingers: 0.4/0.25/0.15
                if (xGVal >= 0.4) return 'ELITE';
                if (xGVal >= 0.25) return 'EXCELLENT';
                if (xGVal >= 0.15) return 'GOOD';
                return 'AVERAGE';
            }

            // default: general attacker expectations
            if (xGVal >= 0.3) return 'GOOD';
            if (xGVal >= 0.15) return 'AVERAGE';
            return 'LOW QUALITY';
        }

        function getDribblingLabel(dribbles, pos) {
            const drbVal = parseFloat(dribbles) || 0;
            
            // Based on frontend: Elite 3+, Very Good 2-3, Good 1-2, Limited <1
            if (drbVal >= 3.0) return 'ELITE';
            if (drbVal >= 2.0) return 'VERY GOOD';
            if (drbVal >= 1.0) return 'GOOD';
            if (drbVal >= 0.5) return 'LIMITED';
            return 'MINIMAL';
        }

        function getCrossingLabel(crosses, crossesC, pos) {
            const crsVal = parseFloat(crosses) || 0;
            const crsC = parseFloat(crossesC) || 0;
            
            if (crsVal === 0) return 'N/A';
            
            const crsAcc = (crsC / crsVal) * 100;
            
            // Based on frontend: Elite 35%+, Excellent 28-35%, Good 22-28%, Average 18-22%, Poor <18%
            if (crsAcc >= 35) return 'ELITE';
            if (crsAcc >= 28) return 'EXCELLENT';
            if (crsAcc >= 22) return 'GOOD';
            if (crsAcc >= 18) return 'AVERAGE';
            return 'POOR';
        }

        // Helper functions to convert stats to labels
        function getAerialDuelsLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 4.0) return 'DOMINANT';
            if (v >= 3.0) return 'STRONG';
            if (v >= 2.0) return 'GOOD';
            if (v >= 1.0) return 'MODERATE';
            return 'WEAK';
        }

        function getInterceptionsLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 3.0) return 'ELITE';
            if (v >= 2.5) return 'EXCELLENT';
            if (v >= 2.0) return 'VERY GOOD';
            if (v >= 1.5) return 'GOOD';
            return 'LIMITED';
        }

        function getTacklesLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 3.5) return 'VERY HIGH';
            if (v >= 2.5) return 'HIGH';
            if (v >= 1.5) return 'GOOD';
            if (v >= 1.0) return 'MODERATE';
            return 'LOW';
        }

        function getTackleSuccessLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 75) return 'ELITE';
            if (v >= 70) return 'EXCELLENT';
            if (v >= 65) return 'GOOD';
            if (v >= 60) return 'AVERAGE';
            return 'POOR';
        }

        function getClearancesLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 5.0) return 'VERY HIGH';
            if (v >= 3.5) return 'HIGH';
            if (v >= 2.0) return 'MODERATE';
            return 'LOW';
        }

        function getBlocksLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 2.0) return 'VERY HIGH';
            if (v >= 1.5) return 'HIGH';
            if (v >= 1.0) return 'GOOD';
            if (v >= 0.5) return 'MODERATE';
            return 'LOW';
        }

        function getDistanceLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 12) return 'EXCEPTIONAL';
            if (v >= 11) return 'EXCELLENT';
            if (v >= 10) return 'GOOD';
            if (v >= 9) return 'AVERAGE';
            return 'LOW';
        }

        function getSprintsLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 30) return 'EXPLOSIVE';
            if (v >= 20) return 'HIGH INTENSITY';
            if (v >= 15) return 'MODERATE';
            if (v >= 10) return 'LOW';
            return 'MINIMAL';
        }

        function getAerialWinPercentLabel(value) {
            if (!value || value === 'N/A') return 'N/A';
            const v = parseFloat(value);
            if (v >= 65) return 'DOMINANT';
            if (v >= 55) return 'STRONG';
            if (v >= 45) return 'AVERAGE';
            if (v >= 35) return 'BELOW AVERAGE';
            return 'WEAK';
        }

        // ========= HELPER FUNCTIONS FOR EXPORT (Match Frontend Logic) =========
        
        function getPassAccuracyLabelForExport(psC, psA, pos) {
            if (!psC || !psA || psA === 0) return 'N/A';
            const acc = (psC / psA) * 100;
            if (acc >= 85) return 'ELITE';
            if (acc >= 80) return 'EXCELLENT';
            if (acc >= 75) return 'GOOD';
            if (acc >= 70) return 'AVERAGE';
            return 'POOR';
        }
        
        function getProgressivePassesLabelForExport(prPasses, pos) {
            if (!prPasses) return 'N/A';
            const isFB = pos.includes('B') || pos.includes('WB');
            const isCM = pos.includes('M') && !pos.includes('AM') && !pos.includes('DM');
            const isAM = pos.includes('AM');
            
            if (isFB) {
                if (prPasses >= 4) return 'ELITE';
                if (prPasses >= 3) return 'EXCELLENT';
                if (prPasses >= 2) return 'GOOD';
                return 'AVERAGE';
            } else if (isCM) {
                if (prPasses >= 6) return 'ELITE';
                if (prPasses >= 4.5) return 'EXCELLENT';
                if (prPasses >= 3) return 'GOOD';
                return 'AVERAGE';
            } else if (isAM) {
                if (prPasses >= 5) return 'ELITE';
                if (prPasses >= 3.5) return 'EXCELLENT';
                if (prPasses >= 2.5) return 'GOOD';
                return 'AVERAGE';
            }
            
            if (prPasses >= 4) return 'EXCELLENT';
            if (prPasses >= 3) return 'GOOD';
            return 'AVERAGE';
        }
        
        function getCreativityLabelForExport(chCreated, keyPasses, xA, pos) {
            if (!chCreated && !keyPasses && !xA) return 'N/A';
            const ch = parseFloat(chCreated) || 0;
            const kp = parseFloat(keyPasses) || 0;
            const xa = parseFloat(xA) || 0;
            
            const isAM = pos.includes('AM');
            const isWinger = pos.includes('W') || pos.includes('(RL)');
            const isCM = pos.includes('M') && !pos.includes('AM') && !pos.includes('DM');
            const isFB = pos.includes('B') || pos.includes('WB');
            const isStriker = pos.includes('ST') || pos.includes('CF');
            
            // AM/Winger: Primary creators
            if (isAM || isWinger) {
                if (ch >= 3 || xa >= 0.30) return 'ELITE CREATOR';
                if (ch >= 2 || xa >= 0.20) return 'EXCELLENT';
                if (ch >= 1.5 || xa >= 0.12) return 'GOOD';
                if (xa >= 0.08) return 'MODERATE';
                return 'LIMITED';
            } 
            // CM: Supporting creator
            else if (isCM) {
                if (ch >= 2 || xa >= 0.15) return 'ELITE';
                if (ch >= 1.2 || xa >= 0.10) return 'GOOD';
                if (ch >= 0.5 || xa >= 0.08) return 'MODERATE';
                return 'DESTROYER';
            }
            // Full-backs: Bonus creativity
            else if (isFB) {
                if (ch >= 1.5 || xa >= 0.20) return 'ELITE ATTACKING FB';
                if (ch >= 0.8 || xa >= 0.12) return 'GOOD';
                if (ch >= 0.3) return 'OCCASIONAL';
                return 'DEFENSIVE FB';
            }
            // Strikers: Link-up play
            else if (isStriker) {
                if (ch >= 1.5 || xa >= 0.20) return 'COMPLETE FORWARD';
                if (ch >= 0.8 || xa >= 0.10) return 'GOOD LINK-UP';
                if (ch >= 0.3) return 'OCCASIONAL';
                return 'PURE FINISHER';
            }
            
            // Generic
            if (ch >= 1.5 || xa >= 0.15) return 'EXCELLENT';
            if (ch >= 1 || xa >= 0.08) return 'MODERATE';
            return 'POOR';
        }
        
        function getBallSecurityLabelForExport(possWon, possLost) {
            if (!possWon || !possLost || possLost === 0) return 'N/A';
            const ratio = possWon / possLost;
            if (ratio >= 1.2) return 'EXCELLENT';
            if (ratio >= 1.0) return 'BALANCED';
            if (ratio >= 0.8) return 'TURNOVER RISK';
            return 'MASALAH';
        }
        
        function getPressingLabelForExport(presC, presA) {
            if (!presC || !presA || presA === 0) return 'N/A';
            const presSucc = (presC / presA) * 100;
            
            let volumeText = '';
            if (presA >= 20) volumeText = ' - HIGH VOLUME';
            else if (presA < 5) return 'LOW PRESSING';
            
            if (presSucc >= 40) return 'ELITE PRESSER' + volumeText;
            if (presSucc >= 35) return 'EXCELLENT' + volumeText;
            if (presSucc >= 30) return 'GOOD' + volumeText;
            if (presSucc >= 25) return 'AVERAGE';
            return 'INEFFICIENT';
        }
        
        function getShootingLabelForExport(xGShot, shots) {
            // Frontend uses xG/Shot to determine shot quality, not xG/90
            const xGShotVal = parseFloat(xGShot) || 0;
            const shotsVal = parseFloat(shots) || 0;
            
            if (shotsVal === 0 || xGShotVal === 0) return 'N/A';
            
            // Based on frontend analyzeAttacking function
            // xG per shot quality (Michael Caley research)
            if (xGShotVal >= 0.15) {
                return 'HIGH QUALITY';
            } else if (xGShotVal >= 0.10) {
                return 'GOOD QUALITY';
            } else if (xGShotVal > 0) {
                return 'LOW QUALITY';
            }
            
            return 'N/A';
        }
        
        function getDribblingLabelForExport(dribbles) {
            if (!dribbles) return 'N/A';
            if (dribbles >= 3.0) return 'ELITE DRIBBLER';
            if (dribbles >= 2.0) return 'VERY GOOD';
            if (dribbles >= 1.0) return 'GOOD';
            if (dribbles >= 0.5) return 'LIMITED';
            return 'MINIMAL';
        }
        
        function getCrossingLabelForExport(crosses, crossesC, pos) {
            const crs = parseFloat(crosses) || 0;
            const crsC = parseFloat(crossesC) || 0;
            
            if (crs === 0) return 'N/A';
            
            const crossAcc = (crsC / crs) * 100;
            
            if (crossAcc >= 35) return 'ELITE';
            if (crossAcc >= 28) return 'EXCELLENT';
            if (crossAcc >= 22) return 'GOOD';
            if (crossAcc >= 18) return 'AVERAGE';
            return 'POOR';
        }
        
        function getAerialDuelsLabelForExport(aerials) {
            if (!aerials) return 'N/A';
            if (aerials >= 4) return 'DOMINANT';
            if (aerials >= 3) return 'STRONG';
            if (aerials >= 2) return 'GOOD';
            if (aerials >= 1) return 'MODERATE';
            return 'WEAK';
        }
        
        function getInterceptionsLabelForExport(interceptions) {
            if (!interceptions) return 'N/A';
            if (interceptions >= 3) return 'ELITE READER';
            if (interceptions >= 2) return 'EXCELLENT';
            if (interceptions >= 1.5) return 'GOOD';
            if (interceptions >= 1) return 'AVERAGE';
            return 'REACTIVE';
        }
        
        function getTacklingLabelForExport(tackles, tackleRate) {
            if (!tackles || !tackleRate) return 'N/A';
            
            let efficiencyLabel = '';
            if (tackleRate >= 80) efficiencyLabel = 'ELITE EFFICIENCY';
            else if (tackleRate >= 70) efficiencyLabel = 'EXCELLENT';
            else if (tackleRate >= 60) efficiencyLabel = 'GOOD';
            else if (tackleRate >= 50) efficiencyLabel = 'AVERAGE';
            else efficiencyLabel = 'POOR';
            
            let volumeText = '';
            if (tackles >= 3) volumeText = ' - HIGH VOLUME';
            else if (tackles >= 1.5) volumeText = ' - MODERATE';
            else volumeText = ' - LOW VOLUME';
            
            return efficiencyLabel + volumeText;
        }
        
        function getLastDitchLabelForExport(clearances, blocks) {
            if (!clearances && !blocks) return 'N/A';
            const clr = parseFloat(clearances) || 0;
            const blk = parseFloat(blocks) || 0;
            
            let label = '';
            if (clr >= 5) label = 'HIGH CLEARANCES';
            else if (clr >= 3) label = 'NORMAL';
            else label = 'LOW';
            
            if (blk >= 1.5) label += ' - SHOT BLOCKER';
            
            return label || 'MINIMAL';
        }
        
        function getDistanceLabelForExport(distance) {
            if (!distance) return 'N/A';
            const dist = parseFloat(distance);
            if (dist >= 12) return 'EXCEPTIONAL';
            if (dist >= 11) return 'EXCELLENT';
            if (dist >= 10) return 'GOOD';
            if (dist >= 9) return 'AVERAGE';
            return 'LOW';
        }
        
        function getSprintsLabelForExport(sprints) {
            if (!sprints) return 'N/A';
            const sprint = parseFloat(sprints);
            if (sprint >= 30) return 'EXPLOSIVE';
            if (sprint >= 20) return 'HIGH INTENSITY';
            if (sprint >= 15) return 'MODERATE';
            if (sprint >= 10) return 'LOW';
            return 'MINIMAL';
        }
        
        function getGKPerformanceLabelForExport(diff, conceded, xgp) {
            if (!xgp || !conceded) return 'N/A';
            if (diff > 0) return `EXCELLENT (+${diff.toFixed(2)} vs xG) - Performing above expectation`;
            if (diff < -0.5) return `CONCERN (${diff.toFixed(2)} vs xG) - Conceding more than expected`;
            return `AVERAGE (On par with xG)`;
        }

        // Export All Players Data to Excel
        function exportAllPlayersData() {
            if (!playersData || playersData.length === 0) {
                alert('Tidak ada data pemain untuk di-export. Silakan upload file terlebih dahulu.');
                return;
            }

            // Prepare data for export
            const exportData = [];
            
            playersData.forEach((p) => {
                // Get basic player info
                const name = findAttribute(p, ['Player', 'Name']) || 'Unknown';
                const position = findAttribute(p, ['Position', 'Pos']) || 'N/A';
                const age = findAttribute(p, ['Age']) || 'N/A';
                const bestPos = findAttribute(p, ['Best Pos']) || '';
                const bestRole = findAttribute(p, ['Best Role']) || '';
                
                // Get all key stats with proper fallback
                const avgRat = findAttribute(p, ['Avg Rat', 'AvRat', 'Average Rating']) || '';
                const apps = findAttribute(p, ['Appearances', 'Apps', 'Aps']) || '';
                const goals = findAttribute(p, ['Goals', 'Gls']) || '';
                const assists = findAttribute(p, ['Assists', 'Asts', 'Ast']) || '';
                
                // Passing Stats
                const prPasses = findAttribute(p, ['Pr passes/90', 'Progressive Passes']) || '';
                const psA = findAttribute(p, ['Ps A/90', 'Passes Attempted']) || '';
                const psC = findAttribute(p, ['Ps C/90', 'Passes Completed']) || '';
                let passAccuracy = '';
                if (psA && psC && parseFloat(psA) > 0) {
                    passAccuracy = ((parseFloat(psC) / parseFloat(psA)) * 100).toFixed(1) + '%';
                }
                const keyPasses = findAttribute(p, ['OP-KP/90', 'Key Passes', 'KeyP/90']) || '';
                const chCreated = findAttribute(p, ['Ch C/90', 'Chances Created']) || '';
                const xA = findAttribute(p, ['xA/90', 'xA', 'Expected Assists']) || '';
                
                // Possession Stats
                const possWon = findAttribute(p, ['Poss Won/90', 'Possession Won']) || '';
                const possLost = findAttribute(p, ['Poss Lost/90', 'Possession Lost']) || '';
                const dribbles = findAttribute(p, ['Drb/90', 'Dribbles']) || '';
                const drbSuccess = findAttribute(p, ['Drb Suc %', 'Dribble Success']) || '';
                
                // Defensive Stats
                const tackles = findAttribute(p, ['Tck/90', 'Tackles']) || '';
                const tckWon = findAttribute(p, ['Tck Won/90', 'Tackles Won']) || '';
                const interceptions = findAttribute(p, ['Int/90', 'Interceptions']) || '';
                const blocks = findAttribute(p, ['Blk/90', 'Blocks']) || '';
                const clr = findAttribute(p, ['Clr/90', 'Clearances']) || '';
                
                // Pressing Stats
                const presA = findAttribute(p, ['Pres A/90', 'Pressures Attempted']) || '';
                const presC = findAttribute(p, ['Pres C/90', 'Pressures Completed']) || '';
                
                // Attacking Stats
                const shots = findAttribute(p, ['Shot/90', 'Shots']) || '';
                const shotsOnTarget = findAttribute(p, ['Sht/90', 'SoT/90', 'Shots on Target']) || '';
                const xG = findAttribute(p, ['xG/90']) || '';
                const xGShot = findAttribute(p, ['xG/shot']) || '';
                const npXG = findAttribute(p, ['NP-xG/90']) || '';
                const crosses = findAttribute(p, ['OP-Crs A/90', 'Crs/90', 'Crosses']) || '';
                const crossesC = findAttribute(p, ['OP-Crs C/90', 'Crosses Completed']) || '';
                const crsSuccess = findAttribute(p, ['Crs Suc %', 'Cross Success']) || '';
                
                // Physical Stats
                const distance = findAttribute(p, ['Dist/90', 'Distance']) || '';
                const sprints = findAttribute(p, ['Sprints/90']) || '';
                const aerials = findAttribute(p, ['Hdrs W/90', 'Headers Won']) || '';
                const aerialWinPerc = findAttribute(p, ['Hdrs W%', 'Aerial Win %']) || '';
                
                // Goalkeeper specific stats
                const isGK = position.toUpperCase().includes('GK');
                let gkConceded = '';
                let gkSaves = '';
                let gkSavePerc = '';
                let gkXGP = '';
                let gkXGP90 = '';
                let gkXSavePerc = '';
                let gkPerformance = '';
                
                if (isGK) {
                    gkConceded = findAttribute(p, ['All/90', 'Conceded']) || '';
                    gkSaves = findAttribute(p, ['Saves/90', 'Saves']) || '';
                    gkSavePerc = findAttribute(p, ['Sv %', 'Save %']) || '';
                    gkXGP = findAttribute(p, ['xGP', 'Expected Goals Prevented']) || '';
                    gkXGP90 = findAttribute(p, ['xGP/90']) || '';
                    gkXSavePerc = findAttribute(p, ['xSv %', 'Expected Save %']) || '';
                    
                    // Calculate GK Performance using helper function
                    const xgpVal = parseFloat(gkXGP) || 0;
                    const concededVal = parseFloat(gkConceded) || 0;
                    gkPerformance = getGKPerformanceLabelForExport(xgpVal, concededVal, xgpVal);
                }
                
                // Get quality labels for each metric
                const pos = position.toUpperCase();
                const psAccVal = (psA && psC && parseFloat(psA) > 0) ? ((parseFloat(psC) / parseFloat(psA)) * 100) : 0;
                const prPassesVal = parseFloat(prPasses) || 0;
                const chCreatedVal = parseFloat(chCreated) || 0;
                const keyPassesVal = parseFloat(keyPasses) || 0;
                const possWonVal = parseFloat(possWon) || 0;
                const possLostVal = parseFloat(possLost) || 0;
                const presCVal = parseFloat(presC) || 0;
                const presAVal = parseFloat(presA) || 0;
                const xg90Val = parseFloat(xG) || 0;
                const shotsVal = parseFloat(shots) || 0;
                const dribblesVal = parseFloat(dribbles) || 0;
                const crossesVal = parseFloat(crosses) || 0;
                const crsSuccessVal = parseFloat(crsSuccess) || 0;
                
                // Get quality labels using new export-specific helper functions
                const passAccuracyLabel = getPassAccuracyLabelForExport(parseFloat(psC), parseFloat(psA), position);
                const progressivePassesLabel = getProgressivePassesLabelForExport(parseFloat(prPasses), position);
                const creativityLabel = getCreativityLabelForExport(parseFloat(chCreated), parseFloat(keyPasses), parseFloat(xA), position);
                const ballSecurityLabel = getBallSecurityLabelForExport(parseFloat(possWon), parseFloat(possLost));
                const pressingLabel = getPressingLabelForExport(parseFloat(presC), parseFloat(presA));
                const shootingLabel = getShootingLabelForExport(parseFloat(xGShot), parseFloat(shots));
                const dribblingLabel = getDribblingLabelForExport(parseFloat(dribbles));
                const crossingLabel = getCrossingLabelForExport(parseFloat(crosses), parseFloat(crossesC), position);
                
                // Defensive labels
                const aerialLabel = getAerialDuelsLabelForExport(parseFloat(aerials));
                const interceptLabel = getInterceptionsLabelForExport(parseFloat(interceptions));
                const tackleLabel = getTacklingLabelForExport(parseFloat(tackles), parseFloat(findAttribute(p, ['Tck R'])));
                const lastDitchLabel = getLastDitchLabelForExport(parseFloat(clr), parseFloat(blocks));
                
                // Physical labels
                const distanceLabel = getDistanceLabelForExport(parseFloat(distance));
                const sprintsLabel = getSprintsLabelForExport(parseFloat(sprints));
                
                // Calculate effectiveness rating
                const rating = calculateEffectiveness(p);
                
                // Generate training recommendation based on position and stats
                let trainingRecom = '';
                const tacklesVal = parseFloat(tackles) || 0;
                const tckWonVal = parseFloat(tckWon) || 0;
                const tckSuccessRate = (tacklesVal > 0) ? (tckWonVal / tacklesVal * 100) : 0;
                const interceptionsVal = parseFloat(interceptions) || 0;
                const blocksVal = parseFloat(blocks) || 0;
                const clrVal = parseFloat(clr) || 0;
                const distanceVal = parseFloat(distance) || 0;
                const sprintsVal = parseFloat(sprints) || 0;
                const aerialsVal = parseFloat(aerials) || 0;
                const aerialWinPercVal = parseFloat(aerialWinPerc) || 0;
                
                const isDefender = pos.includes('D') || pos.includes('CB') || pos.includes('B');
                const isDM = pos.includes('DM');
                const isMidfielder = pos.includes('M') && !isDM;
                const isAttacker = pos.includes('ST') || pos.includes('CF') || pos.includes('W') || pos.includes('AM');
                
                if (isGK) {
                    const svPerc = parseFloat(gkSavePerc) || 0;
                    if (svPerc < 70) {
                        trainingRecom = 'Shot-Stopping & Positioning';
                    } else if (psAccVal < 70) {
                        trainingRecom = 'Distribution & Passing';
                    } else {
                        trainingRecom = 'Command of Box & Communication';
                    }
                } else if (isAttacker) {
                    if (xg90Val < 0.3 || (shotsVal > 0 && xg90Val/shotsVal < 0.12)) {
                        trainingRecom = 'Finishing & Movement';
                    } else if (dribblesVal < 1.5 && pos.includes('W')) {
                        trainingRecom = '1v1 Dribbling & Take-ons';
                    } else if (prPassesVal < 3.0) {
                        trainingRecom = 'Link-up Play & Vision';
                    } else {
                        trainingRecom = 'Maintain Sharpness & Decision Making';
                    }
                } else if (isMidfielder) {
                    if (psAccVal < 75) {
                        trainingRecom = 'Passing Accuracy & Technique';
                    } else if (prPassesVal < 4.0) {
                        trainingRecom = 'Progressive Passing & Vision';
                    } else if (tacklesVal < 1.5) {
                        trainingRecom = 'Defensive Work & Positioning';
                    } else {
                        trainingRecom = 'Ball Retention & Game Intelligence';
                    }
                } else if (isDefender || isDM) {
                    if (tacklesVal < 2.0 && interceptionsVal < 1.5) {
                        trainingRecom = 'Defensive Fundamentals & Tackling';
                    } else if (psAccVal < 70) {
                        trainingRecom = 'Ball Playing & Distribution';
                    } else {
                        trainingRecom = 'Positioning & Anticipation';
                    }
                } else {
                    trainingRecom = 'General Technical & Tactical';
                }
                
                // Generate position recommendation
                let positionRecom = bestPos || position;
                if (bestRole) {
                    positionRecom += ` (${bestRole})`;
                }
                
                if (rating >= 4.0) {
                    positionRecom += ' - Starter Utama';
                } else if (rating >= 3.5) {
                    positionRecom += ' - Starter';
                } else if (rating >= 3.0) {
                    positionRecom += ' - Rotasi/Backup';
                } else if (rating >= 2.5) {
                    positionRecom += ' - Butuh Development';
                } else {
                    positionRecom += ' - Consider Loan';
                }
                
                // Create row data with quality labels - Structured like frontend analysis
                const rowData = {
                    // BASIC INFO
                    'Player': name,
                    'Position': position,
                    'Age': age,
                    'Best Pos': bestPos || 'N/A',
                    'Best Role': bestRole || 'N/A',
                    'Avg Rating': avgRat,
                    'Apps': apps,
                    'Goals': goals,
                    'Assists': assists,
                    
                    // PASSING & CREATIVITY
                    'Pass Accuracy': passAccuracyLabel,
                    'Ps Attempted/90': psA,
                    'Ps Completed/90': psC,
                    'Progressive Passes': progressivePassesLabel,
                    'Pr Passes/90': prPasses,
                    'Kreativitas': creativityLabel,
                    'Key Passes/90': keyPasses,
                    'Chances Created/90': chCreated,
                    
                    // POSSESSION & PRESSING
                    'Ball Security': ballSecurityLabel,
                    'Poss Won/90': possWon,
                    'Poss Lost/90': possLost,
                    'Pressing': pressingLabel,
                    'Pres Attempted/90': presA,
                    'Pres Completed/90': presC,
                    
                    // ATTACKING
                    'Shooting': shootingLabel,
                    'Shots/90': shots,
                    'Shots on Target': shotsOnTarget,
                    'xG/90': xG,
                    'xG/Shot': xGShot,
                    'NP-xG/90': npXG,
                    'Dribbling': dribblingLabel,
                    'Dribbles/90': dribbles,
                    'Crossing': crossingLabel,
                    'Crosses/90': crosses,
                    
                    // DEFENSIVE
                    'Aerial Duels': aerialLabel,
                    'Aerials Won/90': aerials,
                    'Interceptions': interceptLabel,
                    'Interceptions/90': interceptions,
                    'Tackling': tackleLabel,
                    'Tackles/90': tackles,
                    'Last-ditch Defense': lastDitchLabel,
                    'Clearances/90': clr,
                    'Blocks/90': blocks,
                    
                    // PHYSICAL
                    'Distance': distanceLabel,
                    'Distance/90': distance,
                    'Sprints': sprintsLabel,
                    'Sprints/90': sprints
                };
                
                // Add GK specific column if player is GK
                if (isGK) {
                    rowData['Conceded/90'] = gkConceded;
                    rowData['Saves/90'] = gkSaves;
                    rowData['Save %'] = gkSavePerc;
                    rowData['xGP'] = gkXGP;
                    rowData['xGP/90'] = gkXGP90;
                    rowData['xSave %'] = gkXSavePerc;
                    rowData['Performance vs Expectation (GK)'] = gkPerformance;
                }
                
                // OVERALL & RECOMMENDATIONS (Always at the end)
                rowData['Effectiveness Rating'] = rating.toFixed(2);
                rowData['Rekomendasi Training'] = trainingRecom;
                rowData['Rekomendasi Posisi'] = positionRecom;
                
                exportData.push(rowData);
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Set column widths
            const colWidths = [
                { wch: 20 }, // Player
                { wch: 12 }, // Position
                { wch: 6 },  // Age
                { wch: 10 }, // Best Pos
                { wch: 12 }, // Best Role
                { wch: 12 }, // Avg Rating
                { wch: 8 },  // Apps
                { wch: 8 },  // Goals
                { wch: 8 },  // Assists
                { wch: 18 }, // Pass Accuracy Label
                { wch: 12 }, // Pass Accuracy %
                { wch: 22 }, // Progressive Passes Label
                { wch: 18 }, // Progressive Passes/90
                { wch: 15 }, // Key Passes/90
                { wch: 15 }, // Kreativitas Label
                { wch: 18 }, // Chances Created/90
                { wch: 15 }, // Ball Security Label
                { wch: 12 }, // Poss Won/90
                { wch: 12 }, // Poss Lost/90
                { wch: 15 }, // Dribbling Label
                { wch: 12 }, // Dribbles/90
                { wch: 18 }, // Dribble Success %
                { wch: 15 }, // Pressing Label
                { wch: 18 }, // Pres Attempted/90
                { wch: 18 }, // Pres Completed/90
                { wch: 15 }, // Shooting Label
                { wch: 12 }, // Shots/90
                { wch: 18 }, // Shots on Target
                { wch: 10 }, // xG/90
                { wch: 10 }, // xG/Shot
                { wch: 12 }, // NP-xG/90
                { wch: 15 }, // Crossing Label
                { wch: 12 }, // Crosses/90
                { wch: 16 }, // Cross Success %
                { wch: 12 }, // Tackles/90
                { wch: 15 }, // Tackles Won/90
                { wch: 15 }, // Interceptions/90
                { wch: 10 }, // Blocks/90
                { wch: 15 }, // Clearances/90
                { wch: 12 }, // Distance/90
                { wch: 12 }, // Sprints/90
                { wch: 15 }, // Aerials Won/90
                { wch: 14 }, // Aerial Win %
                { wch: 18 }, // Effectiveness Rating
                { wch: 35 }, // Rekomendasi Training
                { wch: 40 }, // Rekomendasi Posisi
                { wch: 45 }  // Performance vs Expectation (GK)
            ];
            ws['!cols'] = colWidths;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Pemain');
            
            // Generate filename with date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Rekap_Analisis_Pemain_${dateStr}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            alert(`‚úÖ Export berhasil! File "${filename}" telah di-download.\n\nTotal ${exportData.length} pemain dengan analisis lengkap.`);
        }
    </script>
</body>
</html>





